<!-- <script src="data:application/octet-stream;base64,LyoKQ29weXJpZ2h0IDIwMTIgSWdvciBWYXluYmVyZwoKVmVyc2lvbjogMy41LjAgVGltZXN0YW1wOiBNb24gSnVuIDE2IDE5OjI5OjQ0IEVEVCAyMDE0CgpUaGlzIHNvZnR3YXJlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSAiQXBhY2hlIExpY2Vuc2UiKSBvciB0aGUgR05VCkdlbmVyYWwgUHVibGljIExpY2Vuc2UgdmVyc2lvbiAyICh0aGUgIkdQTCBMaWNlbnNlIikuIFlvdSBtYXkgY2hvb3NlIGVpdGhlciBsaWNlbnNlIHRvIGdvdmVybiB5b3VyCnVzZSBvZiB0aGlzIHNvZnR3YXJlIG9ubHkgdXBvbiB0aGUgY29uZGl0aW9uIHRoYXQgeW91IGFjY2VwdCBhbGwgb2YgdGhlIHRlcm1zIG9mIGVpdGhlciB0aGUgQXBhY2hlCkxpY2Vuc2Ugb3IgdGhlIEdQTCBMaWNlbnNlLgoKWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBBcGFjaGUgTGljZW5zZSBhbmQgdGhlIEdQTCBMaWNlbnNlIGF0OgoKICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMAogICAgaHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzL2dwbC0yLjAuaHRtbAoKVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZSBkaXN0cmlidXRlZCB1bmRlciB0aGUKQXBhY2hlIExpY2Vuc2Ugb3IgdGhlIEdQTCBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuICJBUyBJUyIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUgpDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLiBTZWUgdGhlIEFwYWNoZSBMaWNlbnNlIGFuZCB0aGUgR1BMIExpY2Vuc2UgZm9yCnRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSBhbmQgdGhlIEdQTCBMaWNlbnNlLgoqLwooZnVuY3Rpb24gKCQpIHsKICAgIGlmKHR5cGVvZiAkLmZuLmVhY2gyID09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgJC5leHRlbmQoJC5mbiwgewogICAgICAgICAgICAvKgogICAgICAgICAgICAqIDQtMTAgdGltZXMgZmFzdGVyIC5lYWNoIHJlcGxhY2VtZW50CiAgICAgICAgICAgICogdXNlIGl0IGNhcmVmdWxseSwgYXMgaXQgb3ZlcnJpZGVzIGpRdWVyeSBjb250ZXh0IG9mIGVsZW1lbnQgb24gZWFjaCBpdGVyYXRpb24KICAgICAgICAgICAgKi8KICAgICAgICAgICAgZWFjaDIgOiBmdW5jdGlvbiAoYykgewogICAgICAgICAgICAgICAgdmFyIGogPSAkKFswXSksIGkgPSAtMSwgbCA9IHRoaXMubGVuZ3RoOwogICAgICAgICAgICAgICAgd2hpbGUgKAogICAgICAgICAgICAgICAgICAgICsraSA8IGwKICAgICAgICAgICAgICAgICAgICAmJiAoai5jb250ZXh0ID0galswXSA9IHRoaXNbaV0pCiAgICAgICAgICAgICAgICAgICAgJiYgYy5jYWxsKGpbMF0sIGksIGopICE9PSBmYWxzZSAvLyJ0aGlzIj1ET00sIGk9aW5kZXgsIGo9alF1ZXJ5IG9iamVjdAogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9Cn0pKGpRdWVyeSk7CgooZnVuY3Rpb24gKCQsIHVuZGVmaW5lZCkgewogICAgInVzZSBzdHJpY3QiOwogICAgLypnbG9iYWwgZG9jdW1lbnQsIHdpbmRvdywgalF1ZXJ5LCBjb25zb2xlICovCgogICAgaWYgKHdpbmRvdy5TZWxlY3QyICE9PSB1bmRlZmluZWQpIHsKICAgICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIEtFWSwgQWJzdHJhY3RTZWxlY3QyLCBTaW5nbGVTZWxlY3QyLCBNdWx0aVNlbGVjdDIsIG5leHRVaWQsIHNpemVyLAogICAgICAgIGxhc3RNb3VzZVBvc2l0aW9uPXt4OjAseTowfSwgJGRvY3VtZW50LCBzY3JvbGxCYXJEaW1lbnNpb25zLAoKICAgIEtFWSA9IHsKICAgICAgICBUQUI6IDksCiAgICAgICAgRU5URVI6IDEzLAogICAgICAgIEVTQzogMjcsCiAgICAgICAgU1BBQ0U6IDMyLAogICAgICAgIExFRlQ6IDM3LAogICAgICAgIFVQOiAzOCwKICAgICAgICBSSUdIVDogMzksCiAgICAgICAgRE9XTjogNDAsCiAgICAgICAgU0hJRlQ6IDE2LAogICAgICAgIENUUkw6IDE3LAogICAgICAgIEFMVDogMTgsCiAgICAgICAgUEFHRV9VUDogMzMsCiAgICAgICAgUEFHRV9ET1dOOiAzNCwKICAgICAgICBIT01FOiAzNiwKICAgICAgICBFTkQ6IDM1LAogICAgICAgIEJBQ0tTUEFDRTogOCwKICAgICAgICBERUxFVEU6IDQ2LAogICAgICAgIGlzQXJyb3c6IGZ1bmN0aW9uIChrKSB7CiAgICAgICAgICAgIGsgPSBrLndoaWNoID8gay53aGljaCA6IGs7CiAgICAgICAgICAgIHN3aXRjaCAoaykgewogICAgICAgICAgICBjYXNlIEtFWS5MRUZUOgogICAgICAgICAgICBjYXNlIEtFWS5SSUdIVDoKICAgICAgICAgICAgY2FzZSBLRVkuVVA6CiAgICAgICAgICAgIGNhc2UgS0VZLkRPV046CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfSwKICAgICAgICBpc0NvbnRyb2w6IGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgIHZhciBrID0gZS53aGljaDsKICAgICAgICAgICAgc3dpdGNoIChrKSB7CiAgICAgICAgICAgIGNhc2UgS0VZLlNISUZUOgogICAgICAgICAgICBjYXNlIEtFWS5DVFJMOgogICAgICAgICAgICBjYXNlIEtFWS5BTFQ6CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGUubWV0YUtleSkgcmV0dXJuIHRydWU7CgogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfSwKICAgICAgICBpc0Z1bmN0aW9uS2V5OiBmdW5jdGlvbiAoaykgewogICAgICAgICAgICBrID0gay53aGljaCA/IGsud2hpY2ggOiBrOwogICAgICAgICAgICByZXR1cm4gayA+PSAxMTIgJiYgayA8PSAxMjM7CiAgICAgICAgfQogICAgfSwKICAgIE1FQVNVUkVfU0NST0xMQkFSX1RFTVBMQVRFID0gIjxkaXYgY2xhc3M9J3NlbGVjdDItbWVhc3VyZS1zY3JvbGxiYXInPjwvZGl2PiIsCgogICAgRElBQ1JJVElDUyA9IHsiXHUyNEI2IjoiQSIsIlx1RkYyMSI6IkEiLCJcdTAwQzAiOiJBIiwiXHUwMEMxIjoiQSIsIlx1MDBDMiI6IkEiLCJcdTFFQTYiOiJBIiwiXHUxRUE0IjoiQSIsIlx1MUVBQSI6IkEiLCJcdTFFQTgiOiJBIiwiXHUwMEMzIjoiQSIsIlx1MDEwMCI6IkEiLCJcdTAxMDIiOiJBIiwiXHUxRUIwIjoiQSIsIlx1MUVBRSI6IkEiLCJcdTFFQjQiOiJBIiwiXHUxRUIyIjoiQSIsIlx1MDIyNiI6IkEiLCJcdTAxRTAiOiJBIiwiXHUwMEM0IjoiQSIsIlx1MDFERSI6IkEiLCJcdTFFQTIiOiJBIiwiXHUwMEM1IjoiQSIsIlx1MDFGQSI6IkEiLCJcdTAxQ0QiOiJBIiwiXHUwMjAwIjoiQSIsIlx1MDIwMiI6IkEiLCJcdTFFQTAiOiJBIiwiXHUxRUFDIjoiQSIsIlx1MUVCNiI6IkEiLCJcdTFFMDAiOiJBIiwiXHUwMTA0IjoiQSIsIlx1MDIzQSI6IkEiLCJcdTJDNkYiOiJBIiwiXHVBNzMyIjoiQUEiLCJcdTAwQzYiOiJBRSIsIlx1MDFGQyI6IkFFIiwiXHUwMUUyIjoiQUUiLCJcdUE3MzQiOiJBTyIsIlx1QTczNiI6IkFVIiwiXHVBNzM4IjoiQVYiLCJcdUE3M0EiOiJBViIsIlx1QTczQyI6IkFZIiwiXHUyNEI3IjoiQiIsIlx1RkYyMiI6IkIiLCJcdTFFMDIiOiJCIiwiXHUxRTA0IjoiQiIsIlx1MUUwNiI6IkIiLCJcdTAyNDMiOiJCIiwiXHUwMTgyIjoiQiIsIlx1MDE4MSI6IkIiLCJcdTI0QjgiOiJDIiwiXHVGRjIzIjoiQyIsIlx1MDEwNiI6IkMiLCJcdTAxMDgiOiJDIiwiXHUwMTBBIjoiQyIsIlx1MDEwQyI6IkMiLCJcdTAwQzciOiJDIiwiXHUxRTA4IjoiQyIsIlx1MDE4NyI6IkMiLCJcdTAyM0IiOiJDIiwiXHVBNzNFIjoiQyIsIlx1MjRCOSI6IkQiLCJcdUZGMjQiOiJEIiwiXHUxRTBBIjoiRCIsIlx1MDEwRSI6IkQiLCJcdTFFMEMiOiJEIiwiXHUxRTEwIjoiRCIsIlx1MUUxMiI6IkQiLCJcdTFFMEUiOiJEIiwiXHUwMTEwIjoiRCIsIlx1MDE4QiI6IkQiLCJcdTAxOEEiOiJEIiwiXHUwMTg5IjoiRCIsIlx1QTc3OSI6IkQiLCJcdTAxRjEiOiJEWiIsIlx1MDFDNCI6IkRaIiwiXHUwMUYyIjoiRHoiLCJcdTAxQzUiOiJEeiIsIlx1MjRCQSI6IkUiLCJcdUZGMjUiOiJFIiwiXHUwMEM4IjoiRSIsIlx1MDBDOSI6IkUiLCJcdTAwQ0EiOiJFIiwiXHUxRUMwIjoiRSIsIlx1MUVCRSI6IkUiLCJcdTFFQzQiOiJFIiwiXHUxRUMyIjoiRSIsIlx1MUVCQyI6IkUiLCJcdTAxMTIiOiJFIiwiXHUxRTE0IjoiRSIsIlx1MUUxNiI6IkUiLCJcdTAxMTQiOiJFIiwiXHUwMTE2IjoiRSIsIlx1MDBDQiI6IkUiLCJcdTFFQkEiOiJFIiwiXHUwMTFBIjoiRSIsIlx1MDIwNCI6IkUiLCJcdTAyMDYiOiJFIiwiXHUxRUI4IjoiRSIsIlx1MUVDNiI6IkUiLCJcdTAyMjgiOiJFIiwiXHUxRTFDIjoiRSIsIlx1MDExOCI6IkUiLCJcdTFFMTgiOiJFIiwiXHUxRTFBIjoiRSIsIlx1MDE5MCI6IkUiLCJcdTAxOEUiOiJFIiwiXHUyNEJCIjoiRiIsIlx1RkYyNiI6IkYiLCJcdTFFMUUiOiJGIiwiXHUwMTkxIjoiRiIsIlx1QTc3QiI6IkYiLCJcdTI0QkMiOiJHIiwiXHVGRjI3IjoiRyIsIlx1MDFGNCI6IkciLCJcdTAxMUMiOiJHIiwiXHUxRTIwIjoiRyIsIlx1MDExRSI6IkciLCJcdTAxMjAiOiJHIiwiXHUwMUU2IjoiRyIsIlx1MDEyMiI6IkciLCJcdTAxRTQiOiJHIiwiXHUwMTkzIjoiRyIsIlx1QTdBMCI6IkciLCJcdUE3N0QiOiJHIiwiXHVBNzdFIjoiRyIsIlx1MjRCRCI6IkgiLCJcdUZGMjgiOiJIIiwiXHUwMTI0IjoiSCIsIlx1MUUyMiI6IkgiLCJcdTFFMjYiOiJIIiwiXHUwMjFFIjoiSCIsIlx1MUUyNCI6IkgiLCJcdTFFMjgiOiJIIiwiXHUxRTJBIjoiSCIsIlx1MDEyNiI6IkgiLCJcdTJDNjciOiJIIiwiXHUyQzc1IjoiSCIsIlx1QTc4RCI6IkgiLCJcdTI0QkUiOiJJIiwiXHVGRjI5IjoiSSIsIlx1MDBDQyI6IkkiLCJcdTAwQ0QiOiJJIiwiXHUwMENFIjoiSSIsIlx1MDEyOCI6IkkiLCJcdTAxMkEiOiJJIiwiXHUwMTJDIjoiSSIsIlx1MDEzMCI6IkkiLCJcdTAwQ0YiOiJJIiwiXHUxRTJFIjoiSSIsIlx1MUVDOCI6IkkiLCJcdTAxQ0YiOiJJIiwiXHUwMjA4IjoiSSIsIlx1MDIwQSI6IkkiLCJcdTFFQ0EiOiJJIiwiXHUwMTJFIjoiSSIsIlx1MUUyQyI6IkkiLCJcdTAxOTciOiJJIiwiXHUyNEJGIjoiSiIsIlx1RkYyQSI6IkoiLCJcdTAxMzQiOiJKIiwiXHUwMjQ4IjoiSiIsIlx1MjRDMCI6IksiLCJcdUZGMkIiOiJLIiwiXHUxRTMwIjoiSyIsIlx1MDFFOCI6IksiLCJcdTFFMzIiOiJLIiwiXHUwMTM2IjoiSyIsIlx1MUUzNCI6IksiLCJcdTAxOTgiOiJLIiwiXHUyQzY5IjoiSyIsIlx1QTc0MCI6IksiLCJcdUE3NDIiOiJLIiwiXHVBNzQ0IjoiSyIsIlx1QTdBMiI6IksiLCJcdTI0QzEiOiJMIiwiXHVGRjJDIjoiTCIsIlx1MDEzRiI6IkwiLCJcdTAxMzkiOiJMIiwiXHUwMTNEIjoiTCIsIlx1MUUzNiI6IkwiLCJcdTFFMzgiOiJMIiwiXHUwMTNCIjoiTCIsIlx1MUUzQyI6IkwiLCJcdTFFM0EiOiJMIiwiXHUwMTQxIjoiTCIsIlx1MDIzRCI6IkwiLCJcdTJDNjIiOiJMIiwiXHUyQzYwIjoiTCIsIlx1QTc0OCI6IkwiLCJcdUE3NDYiOiJMIiwiXHVBNzgwIjoiTCIsIlx1MDFDNyI6IkxKIiwiXHUwMUM4IjoiTGoiLCJcdTI0QzIiOiJNIiwiXHVGRjJEIjoiTSIsIlx1MUUzRSI6Ik0iLCJcdTFFNDAiOiJNIiwiXHUxRTQyIjoiTSIsIlx1MkM2RSI6Ik0iLCJcdTAxOUMiOiJNIiwiXHUyNEMzIjoiTiIsIlx1RkYyRSI6Ik4iLCJcdTAxRjgiOiJOIiwiXHUwMTQzIjoiTiIsIlx1MDBEMSI6Ik4iLCJcdTFFNDQiOiJOIiwiXHUwMTQ3IjoiTiIsIlx1MUU0NiI6Ik4iLCJcdTAxNDUiOiJOIiwiXHUxRTRBIjoiTiIsIlx1MUU0OCI6Ik4iLCJcdTAyMjAiOiJOIiwiXHUwMTlEIjoiTiIsIlx1QTc5MCI6Ik4iLCJcdUE3QTQiOiJOIiwiXHUwMUNBIjoiTkoiLCJcdTAxQ0IiOiJOaiIsIlx1MjRDNCI6Ik8iLCJcdUZGMkYiOiJPIiwiXHUwMEQyIjoiTyIsIlx1MDBEMyI6Ik8iLCJcdTAwRDQiOiJPIiwiXHUxRUQyIjoiTyIsIlx1MUVEMCI6Ik8iLCJcdTFFRDYiOiJPIiwiXHUxRUQ0IjoiTyIsIlx1MDBENSI6Ik8iLCJcdTFFNEMiOiJPIiwiXHUwMjJDIjoiTyIsIlx1MUU0RSI6Ik8iLCJcdTAxNEMiOiJPIiwiXHUxRTUwIjoiTyIsIlx1MUU1MiI6Ik8iLCJcdTAxNEUiOiJPIiwiXHUwMjJFIjoiTyIsIlx1MDIzMCI6Ik8iLCJcdTAwRDYiOiJPIiwiXHUwMjJBIjoiTyIsIlx1MUVDRSI6Ik8iLCJcdTAxNTAiOiJPIiwiXHUwMUQxIjoiTyIsIlx1MDIwQyI6Ik8iLCJcdTAyMEUiOiJPIiwiXHUwMUEwIjoiTyIsIlx1MUVEQyI6Ik8iLCJcdTFFREEiOiJPIiwiXHUxRUUwIjoiTyIsIlx1MUVERSI6Ik8iLCJcdTFFRTIiOiJPIiwiXHUxRUNDIjoiTyIsIlx1MUVEOCI6Ik8iLCJcdTAxRUEiOiJPIiwiXHUwMUVDIjoiTyIsIlx1MDBEOCI6Ik8iLCJcdTAxRkUiOiJPIiwiXHUwMTg2IjoiTyIsIlx1MDE5RiI6Ik8iLCJcdUE3NEEiOiJPIiwiXHVBNzRDIjoiTyIsIlx1MDFBMiI6Ik9JIiwiXHVBNzRFIjoiT08iLCJcdTAyMjIiOiJPVSIsIlx1MjRDNSI6IlAiLCJcdUZGMzAiOiJQIiwiXHUxRTU0IjoiUCIsIlx1MUU1NiI6IlAiLCJcdTAxQTQiOiJQIiwiXHUyQzYzIjoiUCIsIlx1QTc1MCI6IlAiLCJcdUE3NTIiOiJQIiwiXHVBNzU0IjoiUCIsIlx1MjRDNiI6IlEiLCJcdUZGMzEiOiJRIiwiXHVBNzU2IjoiUSIsIlx1QTc1OCI6IlEiLCJcdTAyNEEiOiJRIiwiXHUyNEM3IjoiUiIsIlx1RkYzMiI6IlIiLCJcdTAxNTQiOiJSIiwiXHUxRTU4IjoiUiIsIlx1MDE1OCI6IlIiLCJcdTAyMTAiOiJSIiwiXHUwMjEyIjoiUiIsIlx1MUU1QSI6IlIiLCJcdTFFNUMiOiJSIiwiXHUwMTU2IjoiUiIsIlx1MUU1RSI6IlIiLCJcdTAyNEMiOiJSIiwiXHUyQzY0IjoiUiIsIlx1QTc1QSI6IlIiLCJcdUE3QTYiOiJSIiwiXHVBNzgyIjoiUiIsIlx1MjRDOCI6IlMiLCJcdUZGMzMiOiJTIiwiXHUxRTlFIjoiUyIsIlx1MDE1QSI6IlMiLCJcdTFFNjQiOiJTIiwiXHUwMTVDIjoiUyIsIlx1MUU2MCI6IlMiLCJcdTAxNjAiOiJTIiwiXHUxRTY2IjoiUyIsIlx1MUU2MiI6IlMiLCJcdTFFNjgiOiJTIiwiXHUwMjE4IjoiUyIsIlx1MDE1RSI6IlMiLCJcdTJDN0UiOiJTIiwiXHVBN0E4IjoiUyIsIlx1QTc4NCI6IlMiLCJcdTI0QzkiOiJUIiwiXHVGRjM0IjoiVCIsIlx1MUU2QSI6IlQiLCJcdTAxNjQiOiJUIiwiXHUxRTZDIjoiVCIsIlx1MDIxQSI6IlQiLCJcdTAxNjIiOiJUIiwiXHUxRTcwIjoiVCIsIlx1MUU2RSI6IlQiLCJcdTAxNjYiOiJUIiwiXHUwMUFDIjoiVCIsIlx1MDFBRSI6IlQiLCJcdTAyM0UiOiJUIiwiXHVBNzg2IjoiVCIsIlx1QTcyOCI6IlRaIiwiXHUyNENBIjoiVSIsIlx1RkYzNSI6IlUiLCJcdTAwRDkiOiJVIiwiXHUwMERBIjoiVSIsIlx1MDBEQiI6IlUiLCJcdTAxNjgiOiJVIiwiXHUxRTc4IjoiVSIsIlx1MDE2QSI6IlUiLCJcdTFFN0EiOiJVIiwiXHUwMTZDIjoiVSIsIlx1MDBEQyI6IlUiLCJcdTAxREIiOiJVIiwiXHUwMUQ3IjoiVSIsIlx1MDFENSI6IlUiLCJcdTAxRDkiOiJVIiwiXHUxRUU2IjoiVSIsIlx1MDE2RSI6IlUiLCJcdTAxNzAiOiJVIiwiXHUwMUQzIjoiVSIsIlx1MDIxNCI6IlUiLCJcdTAyMTYiOiJVIiwiXHUwMUFGIjoiVSIsIlx1MUVFQSI6IlUiLCJcdTFFRTgiOiJVIiwiXHUxRUVFIjoiVSIsIlx1MUVFQyI6IlUiLCJcdTFFRjAiOiJVIiwiXHUxRUU0IjoiVSIsIlx1MUU3MiI6IlUiLCJcdTAxNzIiOiJVIiwiXHUxRTc2IjoiVSIsIlx1MUU3NCI6IlUiLCJcdTAyNDQiOiJVIiwiXHUyNENCIjoiViIsIlx1RkYzNiI6IlYiLCJcdTFFN0MiOiJWIiwiXHUxRTdFIjoiViIsIlx1MDFCMiI6IlYiLCJcdUE3NUUiOiJWIiwiXHUwMjQ1IjoiViIsIlx1QTc2MCI6IlZZIiwiXHUyNENDIjoiVyIsIlx1RkYzNyI6IlciLCJcdTFFODAiOiJXIiwiXHUxRTgyIjoiVyIsIlx1MDE3NCI6IlciLCJcdTFFODYiOiJXIiwiXHUxRTg0IjoiVyIsIlx1MUU4OCI6IlciLCJcdTJDNzIiOiJXIiwiXHUyNENEIjoiWCIsIlx1RkYzOCI6IlgiLCJcdTFFOEEiOiJYIiwiXHUxRThDIjoiWCIsIlx1MjRDRSI6IlkiLCJcdUZGMzkiOiJZIiwiXHUxRUYyIjoiWSIsIlx1MDBERCI6IlkiLCJcdTAxNzYiOiJZIiwiXHUxRUY4IjoiWSIsIlx1MDIzMiI6IlkiLCJcdTFFOEUiOiJZIiwiXHUwMTc4IjoiWSIsIlx1MUVGNiI6IlkiLCJcdTFFRjQiOiJZIiwiXHUwMUIzIjoiWSIsIlx1MDI0RSI6IlkiLCJcdTFFRkUiOiJZIiwiXHUyNENGIjoiWiIsIlx1RkYzQSI6IloiLCJcdTAxNzkiOiJaIiwiXHUxRTkwIjoiWiIsIlx1MDE3QiI6IloiLCJcdTAxN0QiOiJaIiwiXHUxRTkyIjoiWiIsIlx1MUU5NCI6IloiLCJcdTAxQjUiOiJaIiwiXHUwMjI0IjoiWiIsIlx1MkM3RiI6IloiLCJcdTJDNkIiOiJaIiwiXHVBNzYyIjoiWiIsIlx1MjREMCI6ImEiLCJcdUZGNDEiOiJhIiwiXHUxRTlBIjoiYSIsIlx1MDBFMCI6ImEiLCJcdTAwRTEiOiJhIiwiXHUwMEUyIjoiYSIsIlx1MUVBNyI6ImEiLCJcdTFFQTUiOiJhIiwiXHUxRUFCIjoiYSIsIlx1MUVBOSI6ImEiLCJcdTAwRTMiOiJhIiwiXHUwMTAxIjoiYSIsIlx1MDEwMyI6ImEiLCJcdTFFQjEiOiJhIiwiXHUxRUFGIjoiYSIsIlx1MUVCNSI6ImEiLCJcdTFFQjMiOiJhIiwiXHUwMjI3IjoiYSIsIlx1MDFFMSI6ImEiLCJcdTAwRTQiOiJhIiwiXHUwMURGIjoiYSIsIlx1MUVBMyI6ImEiLCJcdTAwRTUiOiJhIiwiXHUwMUZCIjoiYSIsIlx1MDFDRSI6ImEiLCJcdTAyMDEiOiJhIiwiXHUwMjAzIjoiYSIsIlx1MUVBMSI6ImEiLCJcdTFFQUQiOiJhIiwiXHUxRUI3IjoiYSIsIlx1MUUwMSI6ImEiLCJcdTAxMDUiOiJhIiwiXHUyQzY1IjoiYSIsIlx1MDI1MCI6ImEiLCJcdUE3MzMiOiJhYSIsIlx1MDBFNiI6ImFlIiwiXHUwMUZEIjoiYWUiLCJcdTAxRTMiOiJhZSIsIlx1QTczNSI6ImFvIiwiXHVBNzM3IjoiYXUiLCJcdUE3MzkiOiJhdiIsIlx1QTczQiI6ImF2IiwiXHVBNzNEIjoiYXkiLCJcdTI0RDEiOiJiIiwiXHVGRjQyIjoiYiIsIlx1MUUwMyI6ImIiLCJcdTFFMDUiOiJiIiwiXHUxRTA3IjoiYiIsIlx1MDE4MCI6ImIiLCJcdTAxODMiOiJiIiwiXHUwMjUzIjoiYiIsIlx1MjREMiI6ImMiLCJcdUZGNDMiOiJjIiwiXHUwMTA3IjoiYyIsIlx1MDEwOSI6ImMiLCJcdTAxMEIiOiJjIiwiXHUwMTBEIjoiYyIsIlx1MDBFNyI6ImMiLCJcdTFFMDkiOiJjIiwiXHUwMTg4IjoiYyIsIlx1MDIzQyI6ImMiLCJcdUE3M0YiOiJjIiwiXHUyMTg0IjoiYyIsIlx1MjREMyI6ImQiLCJcdUZGNDQiOiJkIiwiXHUxRTBCIjoiZCIsIlx1MDEwRiI6ImQiLCJcdTFFMEQiOiJkIiwiXHUxRTExIjoiZCIsIlx1MUUxMyI6ImQiLCJcdTFFMEYiOiJkIiwiXHUwMTExIjoiZCIsIlx1MDE4QyI6ImQiLCJcdTAyNTYiOiJkIiwiXHUwMjU3IjoiZCIsIlx1QTc3QSI6ImQiLCJcdTAxRjMiOiJkeiIsIlx1MDFDNiI6ImR6IiwiXHUyNEQ0IjoiZSIsIlx1RkY0NSI6ImUiLCJcdTAwRTgiOiJlIiwiXHUwMEU5IjoiZSIsIlx1MDBFQSI6ImUiLCJcdTFFQzEiOiJlIiwiXHUxRUJGIjoiZSIsIlx1MUVDNSI6ImUiLCJcdTFFQzMiOiJlIiwiXHUxRUJEIjoiZSIsIlx1MDExMyI6ImUiLCJcdTFFMTUiOiJlIiwiXHUxRTE3IjoiZSIsIlx1MDExNSI6ImUiLCJcdTAxMTciOiJlIiwiXHUwMEVCIjoiZSIsIlx1MUVCQiI6ImUiLCJcdTAxMUIiOiJlIiwiXHUwMjA1IjoiZSIsIlx1MDIwNyI6ImUiLCJcdTFFQjkiOiJlIiwiXHUxRUM3IjoiZSIsIlx1MDIyOSI6ImUiLCJcdTFFMUQiOiJlIiwiXHUwMTE5IjoiZSIsIlx1MUUxOSI6ImUiLCJcdTFFMUIiOiJlIiwiXHUwMjQ3IjoiZSIsIlx1MDI1QiI6ImUiLCJcdTAxREQiOiJlIiwiXHUyNEQ1IjoiZiIsIlx1RkY0NiI6ImYiLCJcdTFFMUYiOiJmIiwiXHUwMTkyIjoiZiIsIlx1QTc3QyI6ImYiLCJcdTI0RDYiOiJnIiwiXHVGRjQ3IjoiZyIsIlx1MDFGNSI6ImciLCJcdTAxMUQiOiJnIiwiXHUxRTIxIjoiZyIsIlx1MDExRiI6ImciLCJcdTAxMjEiOiJnIiwiXHUwMUU3IjoiZyIsIlx1MDEyMyI6ImciLCJcdTAxRTUiOiJnIiwiXHUwMjYwIjoiZyIsIlx1QTdBMSI6ImciLCJcdTFENzkiOiJnIiwiXHVBNzdGIjoiZyIsIlx1MjRENyI6ImgiLCJcdUZGNDgiOiJoIiwiXHUwMTI1IjoiaCIsIlx1MUUyMyI6ImgiLCJcdTFFMjciOiJoIiwiXHUwMjFGIjoiaCIsIlx1MUUyNSI6ImgiLCJcdTFFMjkiOiJoIiwiXHUxRTJCIjoiaCIsIlx1MUU5NiI6ImgiLCJcdTAxMjciOiJoIiwiXHUyQzY4IjoiaCIsIlx1MkM3NiI6ImgiLCJcdTAyNjUiOiJoIiwiXHUwMTk1IjoiaHYiLCJcdTI0RDgiOiJpIiwiXHVGRjQ5IjoiaSIsIlx1MDBFQyI6ImkiLCJcdTAwRUQiOiJpIiwiXHUwMEVFIjoiaSIsIlx1MDEyOSI6ImkiLCJcdTAxMkIiOiJpIiwiXHUwMTJEIjoiaSIsIlx1MDBFRiI6ImkiLCJcdTFFMkYiOiJpIiwiXHUxRUM5IjoiaSIsIlx1MDFEMCI6ImkiLCJcdTAyMDkiOiJpIiwiXHUwMjBCIjoiaSIsIlx1MUVDQiI6ImkiLCJcdTAxMkYiOiJpIiwiXHUxRTJEIjoiaSIsIlx1MDI2OCI6ImkiLCJcdTAxMzEiOiJpIiwiXHUyNEQ5IjoiaiIsIlx1RkY0QSI6ImoiLCJcdTAxMzUiOiJqIiwiXHUwMUYwIjoiaiIsIlx1MDI0OSI6ImoiLCJcdTI0REEiOiJrIiwiXHVGRjRCIjoiayIsIlx1MUUzMSI6ImsiLCJcdTAxRTkiOiJrIiwiXHUxRTMzIjoiayIsIlx1MDEzNyI6ImsiLCJcdTFFMzUiOiJrIiwiXHUwMTk5IjoiayIsIlx1MkM2QSI6ImsiLCJcdUE3NDEiOiJrIiwiXHVBNzQzIjoiayIsIlx1QTc0NSI6ImsiLCJcdUE3QTMiOiJrIiwiXHUyNERCIjoibCIsIlx1RkY0QyI6ImwiLCJcdTAxNDAiOiJsIiwiXHUwMTNBIjoibCIsIlx1MDEzRSI6ImwiLCJcdTFFMzciOiJsIiwiXHUxRTM5IjoibCIsIlx1MDEzQyI6ImwiLCJcdTFFM0QiOiJsIiwiXHUxRTNCIjoibCIsIlx1MDE3RiI6ImwiLCJcdTAxNDIiOiJsIiwiXHUwMTlBIjoibCIsIlx1MDI2QiI6ImwiLCJcdTJDNjEiOiJsIiwiXHVBNzQ5IjoibCIsIlx1QTc4MSI6ImwiLCJcdUE3NDciOiJsIiwiXHUwMUM5IjoibGoiLCJcdTI0REMiOiJtIiwiXHVGRjREIjoibSIsIlx1MUUzRiI6Im0iLCJcdTFFNDEiOiJtIiwiXHUxRTQzIjoibSIsIlx1MDI3MSI6Im0iLCJcdTAyNkYiOiJtIiwiXHUyNEREIjoibiIsIlx1RkY0RSI6Im4iLCJcdTAxRjkiOiJuIiwiXHUwMTQ0IjoibiIsIlx1MDBGMSI6Im4iLCJcdTFFNDUiOiJuIiwiXHUwMTQ4IjoibiIsIlx1MUU0NyI6Im4iLCJcdTAxNDYiOiJuIiwiXHUxRTRCIjoibiIsIlx1MUU0OSI6Im4iLCJcdTAxOUUiOiJuIiwiXHUwMjcyIjoibiIsIlx1MDE0OSI6Im4iLCJcdUE3OTEiOiJuIiwiXHVBN0E1IjoibiIsIlx1MDFDQyI6Im5qIiwiXHUyNERFIjoibyIsIlx1RkY0RiI6Im8iLCJcdTAwRjIiOiJvIiwiXHUwMEYzIjoibyIsIlx1MDBGNCI6Im8iLCJcdTFFRDMiOiJvIiwiXHUxRUQxIjoibyIsIlx1MUVENyI6Im8iLCJcdTFFRDUiOiJvIiwiXHUwMEY1IjoibyIsIlx1MUU0RCI6Im8iLCJcdTAyMkQiOiJvIiwiXHUxRTRGIjoibyIsIlx1MDE0RCI6Im8iLCJcdTFFNTEiOiJvIiwiXHUxRTUzIjoibyIsIlx1MDE0RiI6Im8iLCJcdTAyMkYiOiJvIiwiXHUwMjMxIjoibyIsIlx1MDBGNiI6Im8iLCJcdTAyMkIiOiJvIiwiXHUxRUNGIjoibyIsIlx1MDE1MSI6Im8iLCJcdTAxRDIiOiJvIiwiXHUwMjBEIjoibyIsIlx1MDIwRiI6Im8iLCJcdTAxQTEiOiJvIiwiXHUxRUREIjoibyIsIlx1MUVEQiI6Im8iLCJcdTFFRTEiOiJvIiwiXHUxRURGIjoibyIsIlx1MUVFMyI6Im8iLCJcdTFFQ0QiOiJvIiwiXHUxRUQ5IjoibyIsIlx1MDFFQiI6Im8iLCJcdTAxRUQiOiJvIiwiXHUwMEY4IjoibyIsIlx1MDFGRiI6Im8iLCJcdTAyNTQiOiJvIiwiXHVBNzRCIjoibyIsIlx1QTc0RCI6Im8iLCJcdTAyNzUiOiJvIiwiXHUwMUEzIjoib2kiLCJcdTAyMjMiOiJvdSIsIlx1QTc0RiI6Im9vIiwiXHUyNERGIjoicCIsIlx1RkY1MCI6InAiLCJcdTFFNTUiOiJwIiwiXHUxRTU3IjoicCIsIlx1MDFBNSI6InAiLCJcdTFEN0QiOiJwIiwiXHVBNzUxIjoicCIsIlx1QTc1MyI6InAiLCJcdUE3NTUiOiJwIiwiXHUyNEUwIjoicSIsIlx1RkY1MSI6InEiLCJcdTAyNEIiOiJxIiwiXHVBNzU3IjoicSIsIlx1QTc1OSI6InEiLCJcdTI0RTEiOiJyIiwiXHVGRjUyIjoiciIsIlx1MDE1NSI6InIiLCJcdTFFNTkiOiJyIiwiXHUwMTU5IjoiciIsIlx1MDIxMSI6InIiLCJcdTAyMTMiOiJyIiwiXHUxRTVCIjoiciIsIlx1MUU1RCI6InIiLCJcdTAxNTciOiJyIiwiXHUxRTVGIjoiciIsIlx1MDI0RCI6InIiLCJcdTAyN0QiOiJyIiwiXHVBNzVCIjoiciIsIlx1QTdBNyI6InIiLCJcdUE3ODMiOiJyIiwiXHUyNEUyIjoicyIsIlx1RkY1MyI6InMiLCJcdTAwREYiOiJzIiwiXHUwMTVCIjoicyIsIlx1MUU2NSI6InMiLCJcdTAxNUQiOiJzIiwiXHUxRTYxIjoicyIsIlx1MDE2MSI6InMiLCJcdTFFNjciOiJzIiwiXHUxRTYzIjoicyIsIlx1MUU2OSI6InMiLCJcdTAyMTkiOiJzIiwiXHUwMTVGIjoicyIsIlx1MDIzRiI6InMiLCJcdUE3QTkiOiJzIiwiXHVBNzg1IjoicyIsIlx1MUU5QiI6InMiLCJcdTI0RTMiOiJ0IiwiXHVGRjU0IjoidCIsIlx1MUU2QiI6InQiLCJcdTFFOTciOiJ0IiwiXHUwMTY1IjoidCIsIlx1MUU2RCI6InQiLCJcdTAyMUIiOiJ0IiwiXHUwMTYzIjoidCIsIlx1MUU3MSI6InQiLCJcdTFFNkYiOiJ0IiwiXHUwMTY3IjoidCIsIlx1MDFBRCI6InQiLCJcdTAyODgiOiJ0IiwiXHUyQzY2IjoidCIsIlx1QTc4NyI6InQiLCJcdUE3MjkiOiJ0eiIsIlx1MjRFNCI6InUiLCJcdUZGNTUiOiJ1IiwiXHUwMEY5IjoidSIsIlx1MDBGQSI6InUiLCJcdTAwRkIiOiJ1IiwiXHUwMTY5IjoidSIsIlx1MUU3OSI6InUiLCJcdTAxNkIiOiJ1IiwiXHUxRTdCIjoidSIsIlx1MDE2RCI6InUiLCJcdTAwRkMiOiJ1IiwiXHUwMURDIjoidSIsIlx1MDFEOCI6InUiLCJcdTAxRDYiOiJ1IiwiXHUwMURBIjoidSIsIlx1MUVFNyI6InUiLCJcdTAxNkYiOiJ1IiwiXHUwMTcxIjoidSIsIlx1MDFENCI6InUiLCJcdTAyMTUiOiJ1IiwiXHUwMjE3IjoidSIsIlx1MDFCMCI6InUiLCJcdTFFRUIiOiJ1IiwiXHUxRUU5IjoidSIsIlx1MUVFRiI6InUiLCJcdTFFRUQiOiJ1IiwiXHUxRUYxIjoidSIsIlx1MUVFNSI6InUiLCJcdTFFNzMiOiJ1IiwiXHUwMTczIjoidSIsIlx1MUU3NyI6InUiLCJcdTFFNzUiOiJ1IiwiXHUwMjg5IjoidSIsIlx1MjRFNSI6InYiLCJcdUZGNTYiOiJ2IiwiXHUxRTdEIjoidiIsIlx1MUU3RiI6InYiLCJcdTAyOEIiOiJ2IiwiXHVBNzVGIjoidiIsIlx1MDI4QyI6InYiLCJcdUE3NjEiOiJ2eSIsIlx1MjRFNiI6InciLCJcdUZGNTciOiJ3IiwiXHUxRTgxIjoidyIsIlx1MUU4MyI6InciLCJcdTAxNzUiOiJ3IiwiXHUxRTg3IjoidyIsIlx1MUU4NSI6InciLCJcdTFFOTgiOiJ3IiwiXHUxRTg5IjoidyIsIlx1MkM3MyI6InciLCJcdTI0RTciOiJ4IiwiXHVGRjU4IjoieCIsIlx1MUU4QiI6IngiLCJcdTFFOEQiOiJ4IiwiXHUyNEU4IjoieSIsIlx1RkY1OSI6InkiLCJcdTFFRjMiOiJ5IiwiXHUwMEZEIjoieSIsIlx1MDE3NyI6InkiLCJcdTFFRjkiOiJ5IiwiXHUwMjMzIjoieSIsIlx1MUU4RiI6InkiLCJcdTAwRkYiOiJ5IiwiXHUxRUY3IjoieSIsIlx1MUU5OSI6InkiLCJcdTFFRjUiOiJ5IiwiXHUwMUI0IjoieSIsIlx1MDI0RiI6InkiLCJcdTFFRkYiOiJ5IiwiXHUyNEU5IjoieiIsIlx1RkY1QSI6InoiLCJcdTAxN0EiOiJ6IiwiXHUxRTkxIjoieiIsIlx1MDE3QyI6InoiLCJcdTAxN0UiOiJ6IiwiXHUxRTkzIjoieiIsIlx1MUU5NSI6InoiLCJcdTAxQjYiOiJ6IiwiXHUwMjI1IjoieiIsIlx1MDI0MCI6InoiLCJcdTJDNkMiOiJ6IiwiXHVBNzYzIjoieiIsIlx1MDM4NiI6Ilx1MDM5MSIsIlx1MDM4OCI6Ilx1MDM5NSIsIlx1MDM4OSI6Ilx1MDM5NyIsIlx1MDM4QSI6Ilx1MDM5OSIsIlx1MDNBQSI6Ilx1MDM5OSIsIlx1MDM4QyI6Ilx1MDM5RiIsIlx1MDM4RSI6Ilx1MDNBNSIsIlx1MDNBQiI6Ilx1MDNBNSIsIlx1MDM4RiI6Ilx1MDNBOSIsIlx1MDNBQyI6Ilx1MDNCMSIsIlx1MDNBRCI6Ilx1MDNCNSIsIlx1MDNBRSI6Ilx1MDNCNyIsIlx1MDNBRiI6Ilx1MDNCOSIsIlx1MDNDQSI6Ilx1MDNCOSIsIlx1MDM5MCI6Ilx1MDNCOSIsIlx1MDNDQyI6Ilx1MDNCRiIsIlx1MDNDRCI6Ilx1MDNDNSIsIlx1MDNDQiI6Ilx1MDNDNSIsIlx1MDNCMCI6Ilx1MDNDNSIsIlx1MDNDOSI6Ilx1MDNDOSIsIlx1MDNDMiI6Ilx1MDNDMyJ9OwoKICAgICRkb2N1bWVudCA9ICQoZG9jdW1lbnQpOwoKICAgIG5leHRVaWQ9KGZ1bmN0aW9uKCkgeyB2YXIgY291bnRlcj0xOyByZXR1cm4gZnVuY3Rpb24oKSB7IHJldHVybiBjb3VudGVyKys7IH07IH0oKSk7CgoKICAgIGZ1bmN0aW9uIHJlaW5zZXJ0RWxlbWVudChlbGVtZW50KSB7CiAgICAgICAgdmFyIHBsYWNlaG9sZGVyID0gJChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSgnJykpOwoKICAgICAgICBlbGVtZW50LmJlZm9yZShwbGFjZWhvbGRlcik7CiAgICAgICAgcGxhY2Vob2xkZXIuYmVmb3JlKGVsZW1lbnQpOwogICAgICAgIHBsYWNlaG9sZGVyLnJlbW92ZSgpOwogICAgfQoKICAgIGZ1bmN0aW9uIHN0cmlwRGlhY3JpdGljcyhzdHIpIHsKICAgICAgICAvLyBVc2VkICd1bmkgcmFuZ2UgKyBuYW1lZCBmdW5jdGlvbicgZnJvbSBodHRwOi8vanNwZXJmLmNvbS9kaWFjcml0aWNzLzE4CiAgICAgICAgZnVuY3Rpb24gbWF0Y2goYSkgewogICAgICAgICAgICByZXR1cm4gRElBQ1JJVElDU1thXSB8fCBhOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHN0ci5yZXBsYWNlKC9bXlx1MDAwMC1cdTAwN0VdL2csIG1hdGNoKTsKICAgIH0KCiAgICBmdW5jdGlvbiBpbmRleE9mKHZhbHVlLCBhcnJheSkgewogICAgICAgIHZhciBpID0gMCwgbCA9IGFycmF5Lmxlbmd0aDsKICAgICAgICBmb3IgKDsgaSA8IGw7IGkgPSBpICsgMSkgewogICAgICAgICAgICBpZiAoZXF1YWwodmFsdWUsIGFycmF5W2ldKSkgcmV0dXJuIGk7CiAgICAgICAgfQogICAgICAgIHJldHVybiAtMTsKICAgIH0KCiAgICBmdW5jdGlvbiBtZWFzdXJlU2Nyb2xsYmFyICgpIHsKICAgICAgICB2YXIgJHRlbXBsYXRlID0gJCggTUVBU1VSRV9TQ1JPTExCQVJfVEVNUExBVEUgKTsKICAgICAgICAkdGVtcGxhdGUuYXBwZW5kVG8oJ2JvZHknKTsKCiAgICAgICAgdmFyIGRpbSA9IHsKICAgICAgICAgICAgd2lkdGg6ICR0ZW1wbGF0ZS53aWR0aCgpIC0gJHRlbXBsYXRlWzBdLmNsaWVudFdpZHRoLAogICAgICAgICAgICBoZWlnaHQ6ICR0ZW1wbGF0ZS5oZWlnaHQoKSAtICR0ZW1wbGF0ZVswXS5jbGllbnRIZWlnaHQKICAgICAgICB9OwogICAgICAgICR0ZW1wbGF0ZS5yZW1vdmUoKTsKCiAgICAgICAgcmV0dXJuIGRpbTsKICAgIH0KCiAgICAvKioKICAgICAqIENvbXBhcmVzIGVxdWFsaXR5IG9mIGEgYW5kIGIKICAgICAqIEBwYXJhbSBhCiAgICAgKiBAcGFyYW0gYgogICAgICovCiAgICBmdW5jdGlvbiBlcXVhbChhLCBiKSB7CiAgICAgICAgaWYgKGEgPT09IGIpIHJldHVybiB0cnVlOwogICAgICAgIGlmIChhID09PSB1bmRlZmluZWQgfHwgYiA9PT0gdW5kZWZpbmVkKSByZXR1cm4gZmFsc2U7CiAgICAgICAgaWYgKGEgPT09IG51bGwgfHwgYiA9PT0gbnVsbCkgcmV0dXJuIGZhbHNlOwogICAgICAgIC8vIENoZWNrIHdoZXRoZXIgJ2EnIG9yICdiJyBpcyBhIHN0cmluZyAocHJpbWl0aXZlIG9yIG9iamVjdCkuCiAgICAgICAgLy8gVGhlIGNvbmNhdGVuYXRpb24gb2YgYW4gZW1wdHkgc3RyaW5nICgrJycpIGNvbnZlcnRzIGl0cyBhcmd1bWVudCB0byBhIHN0cmluZydzIHByaW1pdGl2ZS4KICAgICAgICBpZiAoYS5jb25zdHJ1Y3RvciA9PT0gU3RyaW5nKSByZXR1cm4gYSsnJyA9PT0gYisnJzsgLy8gYSsnJyAtIGluIGNhc2UgJ2EnIGlzIGEgU3RyaW5nIG9iamVjdAogICAgICAgIGlmIChiLmNvbnN0cnVjdG9yID09PSBTdHJpbmcpIHJldHVybiBiKycnID09PSBhKycnOyAvLyBiKycnIC0gaW4gY2FzZSAnYicgaXMgYSBTdHJpbmcgb2JqZWN0CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC8qKgogICAgICogU3BsaXRzIHRoZSBzdHJpbmcgaW50byBhbiBhcnJheSBvZiB2YWx1ZXMsIHRyaW1taW5nIGVhY2ggdmFsdWUuIEFuIGVtcHR5IGFycmF5IGlzIHJldHVybmVkIGZvciBudWxscyBvciBlbXB0eQogICAgICogc3RyaW5ncwogICAgICogQHBhcmFtIHN0cmluZwogICAgICogQHBhcmFtIHNlcGFyYXRvcgogICAgICovCiAgICBmdW5jdGlvbiBzcGxpdFZhbChzdHJpbmcsIHNlcGFyYXRvcikgewogICAgICAgIHZhciB2YWwsIGksIGw7CiAgICAgICAgaWYgKHN0cmluZyA9PT0gbnVsbCB8fCBzdHJpbmcubGVuZ3RoIDwgMSkgcmV0dXJuIFtdOwogICAgICAgIHZhbCA9IHN0cmluZy5zcGxpdChzZXBhcmF0b3IpOwogICAgICAgIGZvciAoaSA9IDAsIGwgPSB2YWwubGVuZ3RoOyBpIDwgbDsgaSA9IGkgKyAxKSB2YWxbaV0gPSAkLnRyaW0odmFsW2ldKTsKICAgICAgICByZXR1cm4gdmFsOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldFNpZGVCb3JkZXJQYWRkaW5nKGVsZW1lbnQpIHsKICAgICAgICByZXR1cm4gZWxlbWVudC5vdXRlcldpZHRoKGZhbHNlKSAtIGVsZW1lbnQud2lkdGgoKTsKICAgIH0KCiAgICBmdW5jdGlvbiBpbnN0YWxsS2V5VXBDaGFuZ2VFdmVudChlbGVtZW50KSB7CiAgICAgICAgdmFyIGtleT0ia2V5dXAtY2hhbmdlLXZhbHVlIjsKICAgICAgICBlbGVtZW50Lm9uKCJrZXlkb3duIiwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICBpZiAoJC5kYXRhKGVsZW1lbnQsIGtleSkgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgJC5kYXRhKGVsZW1lbnQsIGtleSwgZWxlbWVudC52YWwoKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBlbGVtZW50Lm9uKCJrZXl1cCIsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIHZhbD0gJC5kYXRhKGVsZW1lbnQsIGtleSk7CiAgICAgICAgICAgIGlmICh2YWwgIT09IHVuZGVmaW5lZCAmJiBlbGVtZW50LnZhbCgpICE9PSB2YWwpIHsKICAgICAgICAgICAgICAgICQucmVtb3ZlRGF0YShlbGVtZW50LCBrZXkpOwogICAgICAgICAgICAgICAgZWxlbWVudC50cmlnZ2VyKCJrZXl1cC1jaGFuZ2UiKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfQoKCiAgICAvKioKICAgICAqIGZpbHRlcnMgbW91c2UgZXZlbnRzIHNvIGFuIGV2ZW50IGlzIGZpcmVkIG9ubHkgaWYgdGhlIG1vdXNlIG1vdmVkLgogICAgICoKICAgICAqIGZpbHRlcnMgb3V0IG1vdXNlIGV2ZW50cyB0aGF0IG9jY3VyIHdoZW4gbW91c2UgaXMgc3RhdGlvbmFyeSBidXQKICAgICAqIHRoZSBlbGVtZW50cyB1bmRlciB0aGUgcG9pbnRlciBhcmUgc2Nyb2xsZWQuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGluc3RhbGxGaWx0ZXJlZE1vdXNlTW92ZShlbGVtZW50KSB7CiAgICAgICAgZWxlbWVudC5vbigibW91c2Vtb3ZlIiwgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgdmFyIGxhc3Rwb3MgPSBsYXN0TW91c2VQb3NpdGlvbjsKICAgICAgICAgICAgaWYgKGxhc3Rwb3MgPT09IHVuZGVmaW5lZCB8fCBsYXN0cG9zLnggIT09IGUucGFnZVggfHwgbGFzdHBvcy55ICE9PSBlLnBhZ2VZKSB7CiAgICAgICAgICAgICAgICAkKGUudGFyZ2V0KS50cmlnZ2VyKCJtb3VzZW1vdmUtZmlsdGVyZWQiLCBlKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfQoKICAgIC8qKgogICAgICogRGVib3VuY2VzIGEgZnVuY3Rpb24uIFJldHVybnMgYSBmdW5jdGlvbiB0aGF0IGNhbGxzIHRoZSBvcmlnaW5hbCBmbiBmdW5jdGlvbiBvbmx5IGlmIG5vIGludm9jYXRpb25zIGhhdmUgYmVlbiBtYWRlCiAgICAgKiB3aXRoaW4gdGhlIGxhc3QgcXVpZXRNaWxsaXMgbWlsbGlzZWNvbmRzLgogICAgICoKICAgICAqIEBwYXJhbSBxdWlldE1pbGxpcyBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIHRvIHdhaXQgYmVmb3JlIGludm9raW5nIGZuCiAgICAgKiBAcGFyYW0gZm4gZnVuY3Rpb24gdG8gYmUgZGVib3VuY2VkCiAgICAgKiBAcGFyYW0gY3R4IG9iamVjdCB0byBiZSB1c2VkIGFzIHRoaXMgcmVmZXJlbmNlIHdpdGhpbiBmbgogICAgICogQHJldHVybiBkZWJvdW5jZWQgdmVyc2lvbiBvZiBmbgogICAgICovCiAgICBmdW5jdGlvbiBkZWJvdW5jZShxdWlldE1pbGxpcywgZm4sIGN0eCkgewogICAgICAgIGN0eCA9IGN0eCB8fCB1bmRlZmluZWQ7CiAgICAgICAgdmFyIHRpbWVvdXQ7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgICAgICAgIHdpbmRvdy5jbGVhclRpbWVvdXQodGltZW91dCk7CiAgICAgICAgICAgIHRpbWVvdXQgPSB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGZuLmFwcGx5KGN0eCwgYXJncyk7CiAgICAgICAgICAgIH0sIHF1aWV0TWlsbGlzKTsKICAgICAgICB9OwogICAgfQoKICAgIGZ1bmN0aW9uIGluc3RhbGxEZWJvdW5jZWRTY3JvbGwodGhyZXNob2xkLCBlbGVtZW50KSB7CiAgICAgICAgdmFyIG5vdGlmeSA9IGRlYm91bmNlKHRocmVzaG9sZCwgZnVuY3Rpb24gKGUpIHsgZWxlbWVudC50cmlnZ2VyKCJzY3JvbGwtZGVib3VuY2VkIiwgZSk7fSk7CiAgICAgICAgZWxlbWVudC5vbigic2Nyb2xsIiwgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgaWYgKGluZGV4T2YoZS50YXJnZXQsIGVsZW1lbnQuZ2V0KCkpID49IDApIG5vdGlmeShlKTsKICAgICAgICB9KTsKICAgIH0KCiAgICBmdW5jdGlvbiBmb2N1cygkZWwpIHsKICAgICAgICBpZiAoJGVsWzBdID09PSBkb2N1bWVudC5hY3RpdmVFbGVtZW50KSByZXR1cm47CgogICAgICAgIC8qIHNldCB0aGUgZm9jdXMgaW4gYSAwIHRpbWVvdXQgLSB0aGF0IHdheSB0aGUgZm9jdXMgaXMgc2V0IGFmdGVyIHRoZSBwcm9jZXNzaW5nCiAgICAgICAgICAgIG9mIHRoZSBjdXJyZW50IGV2ZW50IGhhcyBmaW5pc2hlZCAtIHdoaWNoIHNlZW1zIGxpa2UgdGhlIG9ubHkgcmVsaWFibGUgd2F5CiAgICAgICAgICAgIHRvIHNldCBmb2N1cyAqLwogICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgZWw9JGVsWzBdLCBwb3M9JGVsLnZhbCgpLmxlbmd0aCwgcmFuZ2U7CgogICAgICAgICAgICAkZWwuZm9jdXMoKTsKCiAgICAgICAgICAgIC8qIG1ha2Ugc3VyZSBlbCByZWNlaXZlZCBmb2N1cyBzbyB3ZSBkbyBub3QgZXJyb3Igb3V0IHdoZW4gdHJ5aW5nIHRvIG1hbmlwdWxhdGUgdGhlIGNhcmV0LgogICAgICAgICAgICAgICAgc29tZXRpbWVzIG1vZGFscyBvciBvdGhlcnMgbGlzdGVuZXJzIG1heSBzdGVhbCBpdCBhZnRlciBpdHMgc2V0ICovCiAgICAgICAgICAgIHZhciBpc1Zpc2libGUgPSAoZWwub2Zmc2V0V2lkdGggPiAwIHx8IGVsLm9mZnNldEhlaWdodCA+IDApOwogICAgICAgICAgICBpZiAoaXNWaXNpYmxlICYmIGVsID09PSBkb2N1bWVudC5hY3RpdmVFbGVtZW50KSB7CgogICAgICAgICAgICAgICAgLyogYWZ0ZXIgdGhlIGZvY3VzIGlzIHNldCBtb3ZlIHRoZSBjYXJldCB0byB0aGUgZW5kLCBuZWNlc3Nhcnkgd2hlbiB3ZSB2YWwoKQogICAgICAgICAgICAgICAgICAgIGp1c3QgYmVmb3JlIHNldHRpbmcgZm9jdXMgKi8KICAgICAgICAgICAgICAgIGlmKGVsLnNldFNlbGVjdGlvblJhbmdlKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGVsLnNldFNlbGVjdGlvblJhbmdlKHBvcywgcG9zKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYgKGVsLmNyZWF0ZVRleHRSYW5nZSkgewogICAgICAgICAgICAgICAgICAgIHJhbmdlID0gZWwuY3JlYXRlVGV4dFJhbmdlKCk7CiAgICAgICAgICAgICAgICAgICAgcmFuZ2UuY29sbGFwc2UoZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIHJhbmdlLnNlbGVjdCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwgMCk7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0Q3Vyc29ySW5mbyhlbCkgewogICAgICAgIGVsID0gJChlbClbMF07CiAgICAgICAgdmFyIG9mZnNldCA9IDA7CiAgICAgICAgdmFyIGxlbmd0aCA9IDA7CiAgICAgICAgaWYgKCdzZWxlY3Rpb25TdGFydCcgaW4gZWwpIHsKICAgICAgICAgICAgb2Zmc2V0ID0gZWwuc2VsZWN0aW9uU3RhcnQ7CiAgICAgICAgICAgIGxlbmd0aCA9IGVsLnNlbGVjdGlvbkVuZCAtIG9mZnNldDsKICAgICAgICB9IGVsc2UgaWYgKCdzZWxlY3Rpb24nIGluIGRvY3VtZW50KSB7CiAgICAgICAgICAgIGVsLmZvY3VzKCk7CiAgICAgICAgICAgIHZhciBzZWwgPSBkb2N1bWVudC5zZWxlY3Rpb24uY3JlYXRlUmFuZ2UoKTsKICAgICAgICAgICAgbGVuZ3RoID0gZG9jdW1lbnQuc2VsZWN0aW9uLmNyZWF0ZVJhbmdlKCkudGV4dC5sZW5ndGg7CiAgICAgICAgICAgIHNlbC5tb3ZlU3RhcnQoJ2NoYXJhY3RlcicsIC1lbC52YWx1ZS5sZW5ndGgpOwogICAgICAgICAgICBvZmZzZXQgPSBzZWwudGV4dC5sZW5ndGggLSBsZW5ndGg7CiAgICAgICAgfQogICAgICAgIHJldHVybiB7IG9mZnNldDogb2Zmc2V0LCBsZW5ndGg6IGxlbmd0aCB9OwogICAgfQoKICAgIGZ1bmN0aW9uIGtpbGxFdmVudChldmVudCkgewogICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICB9CiAgICBmdW5jdGlvbiBraWxsRXZlbnRJbW1lZGlhdGVseShldmVudCkgewogICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgZXZlbnQuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CiAgICB9CgogICAgZnVuY3Rpb24gbWVhc3VyZVRleHRXaWR0aChlKSB7CiAgICAgICAgaWYgKCFzaXplcil7CiAgICAgICAgICAgIHZhciBzdHlsZSA9IGVbMF0uY3VycmVudFN0eWxlIHx8IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKGVbMF0sIG51bGwpOwogICAgICAgICAgICBzaXplciA9ICQoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikpLmNzcyh7CiAgICAgICAgICAgICAgICBwb3NpdGlvbjogImFic29sdXRlIiwKICAgICAgICAgICAgICAgIGxlZnQ6ICItMTAwMDBweCIsCiAgICAgICAgICAgICAgICB0b3A6ICItMTAwMDBweCIsCiAgICAgICAgICAgICAgICBkaXNwbGF5OiAibm9uZSIsCiAgICAgICAgICAgICAgICBmb250U2l6ZTogc3R5bGUuZm9udFNpemUsCiAgICAgICAgICAgICAgICBmb250RmFtaWx5OiBzdHlsZS5mb250RmFtaWx5LAogICAgICAgICAgICAgICAgZm9udFN0eWxlOiBzdHlsZS5mb250U3R5bGUsCiAgICAgICAgICAgICAgICBmb250V2VpZ2h0OiBzdHlsZS5mb250V2VpZ2h0LAogICAgICAgICAgICAgICAgbGV0dGVyU3BhY2luZzogc3R5bGUubGV0dGVyU3BhY2luZywKICAgICAgICAgICAgICAgIHRleHRUcmFuc2Zvcm06IHN0eWxlLnRleHRUcmFuc2Zvcm0sCiAgICAgICAgICAgICAgICB3aGl0ZVNwYWNlOiAibm93cmFwIgogICAgICAgICAgICB9KTsKICAgICAgICAgICAgc2l6ZXIuYXR0cigiY2xhc3MiLCJzZWxlY3QyLXNpemVyIik7CiAgICAgICAgICAgICQoImJvZHkiKS5hcHBlbmQoc2l6ZXIpOwogICAgICAgIH0KICAgICAgICBzaXplci50ZXh0KGUudmFsKCkpOwogICAgICAgIHJldHVybiBzaXplci53aWR0aCgpOwogICAgfQoKICAgIGZ1bmN0aW9uIHN5bmNDc3NDbGFzc2VzKGRlc3QsIHNyYywgYWRhcHRlcikgewogICAgICAgIHZhciBjbGFzc2VzLCByZXBsYWNlbWVudHMgPSBbXSwgYWRhcHRlZDsKCiAgICAgICAgY2xhc3NlcyA9ICQudHJpbShkZXN0LmF0dHIoImNsYXNzIikpOwoKICAgICAgICBpZiAoY2xhc3NlcykgewogICAgICAgICAgICBjbGFzc2VzID0gJycgKyBjbGFzc2VzOyAvLyBmb3IgSUUgd2hpY2ggcmV0dXJucyBvYmplY3QKCiAgICAgICAgICAgICQoY2xhc3Nlcy5zcGxpdCgvXHMrLykpLmVhY2gyKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuaW5kZXhPZigic2VsZWN0Mi0iKSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIHJlcGxhY2VtZW50cy5wdXNoKHRoaXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGNsYXNzZXMgPSAkLnRyaW0oc3JjLmF0dHIoImNsYXNzIikpOwoKICAgICAgICBpZiAoY2xhc3NlcykgewogICAgICAgICAgICBjbGFzc2VzID0gJycgKyBjbGFzc2VzOyAvLyBmb3IgSUUgd2hpY2ggcmV0dXJucyBvYmplY3QKCiAgICAgICAgICAgICQoY2xhc3Nlcy5zcGxpdCgvXHMrLykpLmVhY2gyKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuaW5kZXhPZigic2VsZWN0Mi0iKSAhPT0gMCkgewogICAgICAgICAgICAgICAgICAgIGFkYXB0ZWQgPSBhZGFwdGVyKHRoaXMpOwoKICAgICAgICAgICAgICAgICAgICBpZiAoYWRhcHRlZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXBsYWNlbWVudHMucHVzaChhZGFwdGVkKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgZGVzdC5hdHRyKCJjbGFzcyIsIHJlcGxhY2VtZW50cy5qb2luKCIgIikpOwogICAgfQoKCiAgICBmdW5jdGlvbiBtYXJrTWF0Y2godGV4dCwgdGVybSwgbWFya3VwLCBlc2NhcGVNYXJrdXApIHsKICAgICAgICB2YXIgbWF0Y2g9c3RyaXBEaWFjcml0aWNzKHRleHQudG9VcHBlckNhc2UoKSkuaW5kZXhPZihzdHJpcERpYWNyaXRpY3ModGVybS50b1VwcGVyQ2FzZSgpKSksCiAgICAgICAgICAgIHRsPXRlcm0ubGVuZ3RoOwoKICAgICAgICBpZiAobWF0Y2g8MCkgewogICAgICAgICAgICBtYXJrdXAucHVzaChlc2NhcGVNYXJrdXAodGV4dCkpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBtYXJrdXAucHVzaChlc2NhcGVNYXJrdXAodGV4dC5zdWJzdHJpbmcoMCwgbWF0Y2gpKSk7CiAgICAgICAgbWFya3VwLnB1c2goIjxzcGFuIGNsYXNzPSdzZWxlY3QyLW1hdGNoJz4iKTsKICAgICAgICBtYXJrdXAucHVzaChlc2NhcGVNYXJrdXAodGV4dC5zdWJzdHJpbmcobWF0Y2gsIG1hdGNoICsgdGwpKSk7CiAgICAgICAgbWFya3VwLnB1c2goIjwvc3Bhbj4iKTsKICAgICAgICBtYXJrdXAucHVzaChlc2NhcGVNYXJrdXAodGV4dC5zdWJzdHJpbmcobWF0Y2ggKyB0bCwgdGV4dC5sZW5ndGgpKSk7CiAgICB9CgogICAgZnVuY3Rpb24gZGVmYXVsdEVzY2FwZU1hcmt1cChtYXJrdXApIHsKICAgICAgICB2YXIgcmVwbGFjZV9tYXAgPSB7CiAgICAgICAgICAgICdcXCc6ICcmIzkyOycsCiAgICAgICAgICAgICcmJzogJyZhbXA7JywKICAgICAgICAgICAgJzwnOiAnJmx0OycsCiAgICAgICAgICAgICc+JzogJyZndDsnLAogICAgICAgICAgICAnIic6ICcmcXVvdDsnLAogICAgICAgICAgICAiJyI6ICcmIzM5OycsCiAgICAgICAgICAgICIvIjogJyYjNDc7JwogICAgICAgIH07CgogICAgICAgIHJldHVybiBTdHJpbmcobWFya3VwKS5yZXBsYWNlKC9bJjw+IidcL1xcXS9nLCBmdW5jdGlvbiAobWF0Y2gpIHsKICAgICAgICAgICAgcmV0dXJuIHJlcGxhY2VfbWFwW21hdGNoXTsKICAgICAgICB9KTsKICAgIH0KCiAgICAvKioKICAgICAqIFByb2R1Y2VzIGFuIGFqYXgtYmFzZWQgcXVlcnkgZnVuY3Rpb24KICAgICAqCiAgICAgKiBAcGFyYW0gb3B0aW9ucyBvYmplY3QgY29udGFpbmluZyBjb25maWd1cmF0aW9uIHBhcmFtZXRlcnMKICAgICAqIEBwYXJhbSBvcHRpb25zLnBhcmFtcyBwYXJhbWV0ZXIgbWFwIGZvciB0aGUgdHJhbnNwb3J0IGFqYXggY2FsbCwgY2FuIGNvbnRhaW4gc3VjaCBvcHRpb25zIGFzIGNhY2hlLCBqc29ucENhbGxiYWNrLCBldGMuIHNlZSAkLmFqYXgKICAgICAqIEBwYXJhbSBvcHRpb25zLnRyYW5zcG9ydCBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgdXNlZCB0byBleGVjdXRlIHRoZSBhamF4IHJlcXVlc3QuIG11c3QgYmUgY29tcGF0aWJsZSB3aXRoIHBhcmFtZXRlcnMgc3VwcG9ydGVkIGJ5ICQuYWpheAogICAgICogQHBhcmFtIG9wdGlvbnMudXJsIHVybCBmb3IgdGhlIGRhdGEKICAgICAqIEBwYXJhbSBvcHRpb25zLmRhdGEgYSBmdW5jdGlvbihzZWFyY2hUZXJtLCBwYWdlTnVtYmVyLCBjb250ZXh0KSB0aGF0IHNob3VsZCByZXR1cm4gYW4gb2JqZWN0IGNvbnRhaW5pbmcgcXVlcnkgc3RyaW5nIHBhcmFtZXRlcnMgZm9yIHRoZSBhYm92ZSB1cmwuCiAgICAgKiBAcGFyYW0gb3B0aW9ucy5kYXRhVHlwZSByZXF1ZXN0IGRhdGEgdHlwZTogYWpheCwganNvbnAsIG90aGVyIGRhdGF0eXBlcyBzdXBwb3J0ZWQgYnkgalF1ZXJ5J3MgJC5hamF4IGZ1bmN0aW9uIG9yIHRoZSB0cmFuc3BvcnQgZnVuY3Rpb24gaWYgc3BlY2lmaWVkCiAgICAgKiBAcGFyYW0gb3B0aW9ucy5xdWlldE1pbGxpcyAob3B0aW9uYWwpIG1pbGxpc2Vjb25kcyB0byB3YWl0IGJlZm9yZSBtYWtpbmcgdGhlIGFqYXhSZXF1ZXN0LCBoZWxwcyBkZWJvdW5jZSB0aGUgYWpheCBmdW5jdGlvbiBpZiBpbnZva2VkIHRvbyBvZnRlbgogICAgICogQHBhcmFtIG9wdGlvbnMucmVzdWx0cyBhIGZ1bmN0aW9uKHJlbW90ZURhdGEsIHBhZ2VOdW1iZXIsIHF1ZXJ5KSB0aGF0IGNvbnZlcnRzIGRhdGEgcmV0dXJuZWQgZm9ybSB0aGUgcmVtb3RlIHJlcXVlc3QgdG8gdGhlIGZvcm1hdCBleHBlY3RlZCBieSBTZWxlY3QyLgogICAgICogICAgICBUaGUgZXhwZWN0ZWQgZm9ybWF0IGlzIGFuIG9iamVjdCBjb250YWluaW5nIHRoZSBmb2xsb3dpbmcga2V5czoKICAgICAqICAgICAgcmVzdWx0cyBhcnJheSBvZiBvYmplY3RzIHRoYXQgd2lsbCBiZSB1c2VkIGFzIGNob2ljZXMKICAgICAqICAgICAgbW9yZSAob3B0aW9uYWwpIGJvb2xlYW4gaW5kaWNhdGluZyB3aGV0aGVyIHRoZXJlIGFyZSBtb3JlIHJlc3VsdHMgYXZhaWxhYmxlCiAgICAgKiAgICAgIEV4YW1wbGU6IHtyZXN1bHRzOlt7aWQ6MSwgdGV4dDonUmVkJ30se2lkOjIsIHRleHQ6J0JsdWUnfV0sIG1vcmU6dHJ1ZX0KICAgICAqLwogICAgZnVuY3Rpb24gYWpheChvcHRpb25zKSB7CiAgICAgICAgdmFyIHRpbWVvdXQsIC8vIGN1cnJlbnQgc2NoZWR1bGVkIGJ1dCBub3QgeWV0IGV4ZWN1dGVkIHJlcXVlc3QKICAgICAgICAgICAgaGFuZGxlciA9IG51bGwsCiAgICAgICAgICAgIHF1aWV0TWlsbGlzID0gb3B0aW9ucy5xdWlldE1pbGxpcyB8fCAxMDAsCiAgICAgICAgICAgIGFqYXhVcmwgPSBvcHRpb25zLnVybCwKICAgICAgICAgICAgc2VsZiA9IHRoaXM7CgogICAgICAgIHJldHVybiBmdW5jdGlvbiAocXVlcnkpIHsKICAgICAgICAgICAgd2luZG93LmNsZWFyVGltZW91dCh0aW1lb3V0KTsKICAgICAgICAgICAgdGltZW91dCA9IHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciBkYXRhID0gb3B0aW9ucy5kYXRhLCAvLyBhamF4IGRhdGEgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICB1cmwgPSBhamF4VXJsLCAvLyBhamF4IHVybCBzdHJpbmcgb3IgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICB0cmFuc3BvcnQgPSBvcHRpb25zLnRyYW5zcG9ydCB8fCAkLmZuLnNlbGVjdDIuYWpheERlZmF1bHRzLnRyYW5zcG9ydCwKICAgICAgICAgICAgICAgICAgICAvLyBkZXByZWNhdGVkIC0gdG8gYmUgcmVtb3ZlZCBpbiA0LjAgIC0gdXNlIHBhcmFtcyBpbnN0ZWFkCiAgICAgICAgICAgICAgICAgICAgZGVwcmVjYXRlZCA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogb3B0aW9ucy50eXBlIHx8ICdHRVQnLCAvLyBzZXQgdHlwZSBvZiByZXF1ZXN0IChHRVQgb3IgUE9TVCkKICAgICAgICAgICAgICAgICAgICAgICAgY2FjaGU6IG9wdGlvbnMuY2FjaGUgfHwgZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgIGpzb25wQ2FsbGJhY2s6IG9wdGlvbnMuanNvbnBDYWxsYmFja3x8dW5kZWZpbmVkLAogICAgICAgICAgICAgICAgICAgICAgICBkYXRhVHlwZTogb3B0aW9ucy5kYXRhVHlwZXx8Impzb24iCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBwYXJhbXMgPSAkLmV4dGVuZCh7fSwgJC5mbi5zZWxlY3QyLmFqYXhEZWZhdWx0cy5wYXJhbXMsIGRlcHJlY2F0ZWQpOwoKICAgICAgICAgICAgICAgIGRhdGEgPSBkYXRhID8gZGF0YS5jYWxsKHNlbGYsIHF1ZXJ5LnRlcm0sIHF1ZXJ5LnBhZ2UsIHF1ZXJ5LmNvbnRleHQpIDogbnVsbDsKICAgICAgICAgICAgICAgIHVybCA9ICh0eXBlb2YgdXJsID09PSAnZnVuY3Rpb24nKSA/IHVybC5jYWxsKHNlbGYsIHF1ZXJ5LnRlcm0sIHF1ZXJ5LnBhZ2UsIHF1ZXJ5LmNvbnRleHQpIDogdXJsOwoKICAgICAgICAgICAgICAgIGlmIChoYW5kbGVyICYmIHR5cGVvZiBoYW5kbGVyLmFib3J0ID09PSAiZnVuY3Rpb24iKSB7IGhhbmRsZXIuYWJvcnQoKTsgfQoKICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLnBhcmFtcykgewogICAgICAgICAgICAgICAgICAgIGlmICgkLmlzRnVuY3Rpb24ob3B0aW9ucy5wYXJhbXMpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICQuZXh0ZW5kKHBhcmFtcywgb3B0aW9ucy5wYXJhbXMuY2FsbChzZWxmKSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgJC5leHRlbmQocGFyYW1zLCBvcHRpb25zLnBhcmFtcyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICQuZXh0ZW5kKHBhcmFtcywgewogICAgICAgICAgICAgICAgICAgIHVybDogdXJsLAogICAgICAgICAgICAgICAgICAgIGRhdGFUeXBlOiBvcHRpb25zLmRhdGFUeXBlLAogICAgICAgICAgICAgICAgICAgIGRhdGE6IGRhdGEsCiAgICAgICAgICAgICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVE9ETyAtIHJlcGxhY2UgcXVlcnkucGFnZSB3aXRoIHF1ZXJ5IHNvIHVzZXJzIGhhdmUgYWNjZXNzIHRvIHRlcm0sIHBhZ2UsIGV0Yy4KICAgICAgICAgICAgICAgICAgICAgICAgLy8gYWRkZWQgcXVlcnkgYXMgdGhpcmQgcGFyYW10ZXIgdG8ga2VlcCBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eQogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVzdWx0cyA9IG9wdGlvbnMucmVzdWx0cyhkYXRhLCBxdWVyeS5wYWdlLCBxdWVyeSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHF1ZXJ5LmNhbGxiYWNrKHJlc3VsdHMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgaGFuZGxlciA9IHRyYW5zcG9ydC5jYWxsKHNlbGYsIHBhcmFtcyk7CiAgICAgICAgICAgIH0sIHF1aWV0TWlsbGlzKTsKICAgICAgICB9OwogICAgfQoKICAgIC8qKgogICAgICogUHJvZHVjZXMgYSBxdWVyeSBmdW5jdGlvbiB0aGF0IHdvcmtzIHdpdGggYSBsb2NhbCBhcnJheQogICAgICoKICAgICAqIEBwYXJhbSBvcHRpb25zIG9iamVjdCBjb250YWluaW5nIGNvbmZpZ3VyYXRpb24gcGFyYW1ldGVycy4gVGhlIG9wdGlvbnMgcGFyYW1ldGVyIGNhbiBlaXRoZXIgYmUgYW4gYXJyYXkgb3IgYW4KICAgICAqIG9iamVjdC4KICAgICAqCiAgICAgKiBJZiB0aGUgYXJyYXkgZm9ybSBpcyB1c2VkIGl0IGlzIGFzc3VtZWQgdGhhdCBpdCBjb250YWlucyBvYmplY3RzIHdpdGggJ2lkJyBhbmQgJ3RleHQnIGtleXMuCiAgICAgKgogICAgICogSWYgdGhlIG9iamVjdCBmb3JtIGlzIHVzZWQgaXQgaXMgYXNzdW1lZCB0aGF0IGl0IGNvbnRhaW5zICdkYXRhJyBhbmQgJ3RleHQnIGtleXMuIFRoZSAnZGF0YScga2V5IHNob3VsZCBjb250YWluCiAgICAgKiBhbiBhcnJheSBvZiBvYmplY3RzIHRoYXQgd2lsbCBiZSB1c2VkIGFzIGNob2ljZXMuIFRoZXNlIG9iamVjdHMgbXVzdCBjb250YWluIGF0IGxlYXN0IGFuICdpZCcga2V5LiBUaGUgJ3RleHQnCiAgICAgKiBrZXkgY2FuIGVpdGhlciBiZSBhIFN0cmluZyBpbiB3aGljaCBjYXNlIGl0IGlzIGV4cGVjdGVkIHRoYXQgZWFjaCBlbGVtZW50IGluIHRoZSAnZGF0YScgYXJyYXkgaGFzIGEga2V5IHdpdGggdGhlCiAgICAgKiB2YWx1ZSBvZiAndGV4dCcgd2hpY2ggd2lsbCBiZSB1c2VkIHRvIG1hdGNoIGNob2ljZXMuIEFsdGVybmF0aXZlbHksIHRleHQgY2FuIGJlIGEgZnVuY3Rpb24oaXRlbSkgdGhhdCBjYW4gZXh0cmFjdAogICAgICogdGhlIHRleHQuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGxvY2FsKG9wdGlvbnMpIHsKICAgICAgICB2YXIgZGF0YSA9IG9wdGlvbnMsIC8vIGRhdGEgZWxlbWVudHMKICAgICAgICAgICAgZGF0YVRleHQsCiAgICAgICAgICAgIHRtcCwKICAgICAgICAgICAgdGV4dCA9IGZ1bmN0aW9uIChpdGVtKSB7IHJldHVybiAiIitpdGVtLnRleHQ7IH07IC8vIGZ1bmN0aW9uIHVzZWQgdG8gcmV0cmlldmUgdGhlIHRleHQgcG9ydGlvbiBvZiBhIGRhdGEgaXRlbSB0aGF0IGlzIG1hdGNoZWQgYWdhaW5zdCB0aGUgc2VhcmNoCgogICAgICAgICBpZiAoJC5pc0FycmF5KGRhdGEpKSB7CiAgICAgICAgICAgIHRtcCA9IGRhdGE7CiAgICAgICAgICAgIGRhdGEgPSB7IHJlc3VsdHM6IHRtcCB9OwogICAgICAgIH0KCiAgICAgICAgIGlmICgkLmlzRnVuY3Rpb24oZGF0YSkgPT09IGZhbHNlKSB7CiAgICAgICAgICAgIHRtcCA9IGRhdGE7CiAgICAgICAgICAgIGRhdGEgPSBmdW5jdGlvbigpIHsgcmV0dXJuIHRtcDsgfTsKICAgICAgICB9CgogICAgICAgIHZhciBkYXRhSXRlbSA9IGRhdGEoKTsKICAgICAgICBpZiAoZGF0YUl0ZW0udGV4dCkgewogICAgICAgICAgICB0ZXh0ID0gZGF0YUl0ZW0udGV4dDsKICAgICAgICAgICAgLy8gaWYgdGV4dCBpcyBub3QgYSBmdW5jdGlvbiB3ZSBhc3N1bWUgaXQgdG8gYmUgYSBrZXkgbmFtZQogICAgICAgICAgICBpZiAoISQuaXNGdW5jdGlvbih0ZXh0KSkgewogICAgICAgICAgICAgICAgZGF0YVRleHQgPSBkYXRhSXRlbS50ZXh0OyAvLyB3ZSBuZWVkIHRvIHN0b3JlIHRoaXMgaW4gYSBzZXBhcmF0ZSB2YXJpYWJsZSBiZWNhdXNlIGluIHRoZSBuZXh0IHN0ZXAgZGF0YSBnZXRzIHJlc2V0IGFuZCBkYXRhLnRleHQgaXMgbm8gbG9uZ2VyIGF2YWlsYWJsZQogICAgICAgICAgICAgICAgdGV4dCA9IGZ1bmN0aW9uIChpdGVtKSB7IHJldHVybiBpdGVtW2RhdGFUZXh0XTsgfTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChxdWVyeSkgewogICAgICAgICAgICB2YXIgdCA9IHF1ZXJ5LnRlcm0sIGZpbHRlcmVkID0geyByZXN1bHRzOiBbXSB9LCBwcm9jZXNzOwogICAgICAgICAgICBpZiAodCA9PT0gIiIpIHsKICAgICAgICAgICAgICAgIHF1ZXJ5LmNhbGxiYWNrKGRhdGEoKSk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHByb2Nlc3MgPSBmdW5jdGlvbihkYXR1bSwgY29sbGVjdGlvbikgewogICAgICAgICAgICAgICAgdmFyIGdyb3VwLCBhdHRyOwogICAgICAgICAgICAgICAgZGF0dW0gPSBkYXR1bVswXTsKICAgICAgICAgICAgICAgIGlmIChkYXR1bS5jaGlsZHJlbikgewogICAgICAgICAgICAgICAgICAgIGdyb3VwID0ge307CiAgICAgICAgICAgICAgICAgICAgZm9yIChhdHRyIGluIGRhdHVtKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkYXR1bS5oYXNPd25Qcm9wZXJ0eShhdHRyKSkgZ3JvdXBbYXR0cl09ZGF0dW1bYXR0cl07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGdyb3VwLmNoaWxkcmVuPVtdOwogICAgICAgICAgICAgICAgICAgICQoZGF0dW0uY2hpbGRyZW4pLmVhY2gyKGZ1bmN0aW9uKGksIGNoaWxkRGF0dW0pIHsgcHJvY2VzcyhjaGlsZERhdHVtLCBncm91cC5jaGlsZHJlbik7IH0pOwogICAgICAgICAgICAgICAgICAgIGlmIChncm91cC5jaGlsZHJlbi5sZW5ndGggfHwgcXVlcnkubWF0Y2hlcih0LCB0ZXh0KGdyb3VwKSwgZGF0dW0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbGxlY3Rpb24ucHVzaChncm91cCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAocXVlcnkubWF0Y2hlcih0LCB0ZXh0KGRhdHVtKSwgZGF0dW0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbGxlY3Rpb24ucHVzaChkYXR1bSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgJChkYXRhKCkucmVzdWx0cykuZWFjaDIoZnVuY3Rpb24oaSwgZGF0dW0pIHsgcHJvY2VzcyhkYXR1bSwgZmlsdGVyZWQucmVzdWx0cyk7IH0pOwogICAgICAgICAgICBxdWVyeS5jYWxsYmFjayhmaWx0ZXJlZCk7CiAgICAgICAgfTsKICAgIH0KCiAgICAvLyBUT0RPIGphdmFkb2MKICAgIGZ1bmN0aW9uIHRhZ3MoZGF0YSkgewogICAgICAgIHZhciBpc0Z1bmMgPSAkLmlzRnVuY3Rpb24oZGF0YSk7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChxdWVyeSkgewogICAgICAgICAgICB2YXIgdCA9IHF1ZXJ5LnRlcm0sIGZpbHRlcmVkID0ge3Jlc3VsdHM6IFtdfTsKICAgICAgICAgICAgdmFyIHJlc3VsdCA9IGlzRnVuYyA/IGRhdGEocXVlcnkpIDogZGF0YTsKICAgICAgICAgICAgaWYgKCQuaXNBcnJheShyZXN1bHQpKSB7CiAgICAgICAgICAgICAgICAkKHJlc3VsdCkuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGlzT2JqZWN0ID0gdGhpcy50ZXh0ICE9PSB1bmRlZmluZWQsCiAgICAgICAgICAgICAgICAgICAgICAgIHRleHQgPSBpc09iamVjdCA/IHRoaXMudGV4dCA6IHRoaXM7CiAgICAgICAgICAgICAgICAgICAgaWYgKHQgPT09ICIiIHx8IHF1ZXJ5Lm1hdGNoZXIodCwgdGV4dCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVyZWQucmVzdWx0cy5wdXNoKGlzT2JqZWN0ID8gdGhpcyA6IHtpZDogdGhpcywgdGV4dDogdGhpc30pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgcXVlcnkuY2FsbGJhY2soZmlsdGVyZWQpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiB0aGUgZm9ybWF0dGVyIGZ1bmN0aW9uIHNob3VsZCBiZSB1c2VkLgogICAgICoKICAgICAqIFRocm93cyBhbiBlcnJvciBpZiBpdCBpcyBub3QgYSBmdW5jdGlvbi4gUmV0dXJucyB0cnVlIGlmIGl0IHNob3VsZCBiZSB1c2VkLAogICAgICogZmFsc2UgaWYgbm8gZm9ybWF0dGluZyBzaG91bGQgYmUgcGVyZm9ybWVkLgogICAgICoKICAgICAqIEBwYXJhbSBmb3JtYXR0ZXIKICAgICAqLwogICAgZnVuY3Rpb24gY2hlY2tGb3JtYXR0ZXIoZm9ybWF0dGVyLCBmb3JtYXR0ZXJOYW1lKSB7CiAgICAgICAgaWYgKCQuaXNGdW5jdGlvbihmb3JtYXR0ZXIpKSByZXR1cm4gdHJ1ZTsKICAgICAgICBpZiAoIWZvcm1hdHRlcikgcmV0dXJuIGZhbHNlOwogICAgICAgIGlmICh0eXBlb2YoZm9ybWF0dGVyKSA9PT0gJ3N0cmluZycpIHJldHVybiB0cnVlOwogICAgICAgIHRocm93IG5ldyBFcnJvcihmb3JtYXR0ZXJOYW1lICsiIG11c3QgYmUgYSBzdHJpbmcsIGZ1bmN0aW9uLCBvciBmYWxzeSB2YWx1ZSIpOwogICAgfQoKICAvKioKICAgKiBSZXR1cm5zIGEgZ2l2ZW4gdmFsdWUKICAgKiBJZiBnaXZlbiBhIGZ1bmN0aW9uLCByZXR1cm5zIGl0cyBvdXRwdXQKICAgKgogICAqIEBwYXJhbSB2YWwgc3RyaW5nfGZ1bmN0aW9uCiAgICogQHBhcmFtIGNvbnRleHQgdmFsdWUgb2YgInRoaXMiIHRvIGJlIHBhc3NlZCB0byBmdW5jdGlvbgogICAqIEByZXR1cm5zIHsqfQogICAqLwogICAgZnVuY3Rpb24gZXZhbHVhdGUodmFsLCBjb250ZXh0KSB7CiAgICAgICAgaWYgKCQuaXNGdW5jdGlvbih2YWwpKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKTsKICAgICAgICAgICAgcmV0dXJuIHZhbC5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZhbDsKICAgIH0KCiAgICBmdW5jdGlvbiBjb3VudFJlc3VsdHMocmVzdWx0cykgewogICAgICAgIHZhciBjb3VudCA9IDA7CiAgICAgICAgJC5lYWNoKHJlc3VsdHMsIGZ1bmN0aW9uKGksIGl0ZW0pIHsKICAgICAgICAgICAgaWYgKGl0ZW0uY2hpbGRyZW4pIHsKICAgICAgICAgICAgICAgIGNvdW50ICs9IGNvdW50UmVzdWx0cyhpdGVtLmNoaWxkcmVuKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvdW50Kys7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gY291bnQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBEZWZhdWx0IHRva2VuaXplci4gVGhpcyBmdW5jdGlvbiB1c2VzIGJyZWFrcyB0aGUgaW5wdXQgb24gc3Vic3RyaW5nIG1hdGNoIG9mIGFueSBzdHJpbmcgZnJvbSB0aGUKICAgICAqIG9wdHMudG9rZW5TZXBhcmF0b3JzIGFycmF5IGFuZCB1c2VzIG9wdHMuY3JlYXRlU2VhcmNoQ2hvaWNlIHRvIGNyZWF0ZSB0aGUgY2hvaWNlIG9iamVjdC4gQm90aCBvZiB0aG9zZQogICAgICogdHdvIG9wdGlvbnMgaGF2ZSB0byBiZSBkZWZpbmVkIGluIG9yZGVyIGZvciB0aGUgdG9rZW5pemVyIHRvIHdvcmsuCiAgICAgKgogICAgICogQHBhcmFtIGlucHV0IHRleHQgdXNlciBoYXMgdHlwZWQgc28gZmFyIG9yIHBhc3RlZCBpbnRvIHRoZSBzZWFyY2ggZmllbGQKICAgICAqIEBwYXJhbSBzZWxlY3Rpb24gY3VycmVudGx5IHNlbGVjdGVkIGNob2ljZXMKICAgICAqIEBwYXJhbSBzZWxlY3RDYWxsYmFjayBmdW5jdGlvbihjaG9pY2UpIGNhbGxiYWNrIHRobyBhZGQgdGhlIGNob2ljZSB0byBzZWxlY3Rpb24KICAgICAqIEBwYXJhbSBvcHRzIHNlbGVjdDIncyBvcHRzCiAgICAgKiBAcmV0dXJuIHVuZGVmaW5lZC9udWxsIHRvIGxlYXZlIHRoZSBjdXJyZW50IGlucHV0IHVuY2hhbmdlZCwgb3IgYSBzdHJpbmcgdG8gY2hhbmdlIHRoZSBpbnB1dCB0byB0aGUgcmV0dXJuZWQgdmFsdWUKICAgICAqLwogICAgZnVuY3Rpb24gZGVmYXVsdFRva2VuaXplcihpbnB1dCwgc2VsZWN0aW9uLCBzZWxlY3RDYWxsYmFjaywgb3B0cykgewogICAgICAgIHZhciBvcmlnaW5hbCA9IGlucHV0LCAvLyBzdG9yZSB0aGUgb3JpZ2luYWwgc28gd2UgY2FuIGNvbXBhcmUgYW5kIGtub3cgaWYgd2UgbmVlZCB0byB0ZWxsIHRoZSBzZWFyY2ggdG8gdXBkYXRlIGl0cyB0ZXh0CiAgICAgICAgICAgIGR1cGUgPSBmYWxzZSwgLy8gY2hlY2sgZm9yIHdoZXRoZXIgYSB0b2tlbiB3ZSBleHRyYWN0ZWQgcmVwcmVzZW50cyBhIGR1cGxpY2F0ZSBzZWxlY3RlZCBjaG9pY2UKICAgICAgICAgICAgdG9rZW4sIC8vIHRva2VuCiAgICAgICAgICAgIGluZGV4LCAvLyBwb3NpdGlvbiBhdCB3aGljaCB0aGUgc2VwYXJhdG9yIHdhcyBmb3VuZAogICAgICAgICAgICBpLCBsLCAvLyBsb29waW5nIHZhcmlhYmxlcwogICAgICAgICAgICBzZXBhcmF0b3I7IC8vIHRoZSBtYXRjaGVkIHNlcGFyYXRvcgoKICAgICAgICBpZiAoIW9wdHMuY3JlYXRlU2VhcmNoQ2hvaWNlIHx8ICFvcHRzLnRva2VuU2VwYXJhdG9ycyB8fCBvcHRzLnRva2VuU2VwYXJhdG9ycy5sZW5ndGggPCAxKSByZXR1cm4gdW5kZWZpbmVkOwoKICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICBpbmRleCA9IC0xOwoKICAgICAgICAgICAgZm9yIChpID0gMCwgbCA9IG9wdHMudG9rZW5TZXBhcmF0b3JzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICAgICAgc2VwYXJhdG9yID0gb3B0cy50b2tlblNlcGFyYXRvcnNbaV07CiAgICAgICAgICAgICAgICBpbmRleCA9IGlucHV0LmluZGV4T2Yoc2VwYXJhdG9yKTsKICAgICAgICAgICAgICAgIGlmIChpbmRleCA+PSAwKSBicmVhazsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGluZGV4IDwgMCkgYnJlYWs7IC8vIGRpZCBub3QgZmluZCBhbnkgdG9rZW4gc2VwYXJhdG9yIGluIHRoZSBpbnB1dCBzdHJpbmcsIGJhaWwKCiAgICAgICAgICAgIHRva2VuID0gaW5wdXQuc3Vic3RyaW5nKDAsIGluZGV4KTsKICAgICAgICAgICAgaW5wdXQgPSBpbnB1dC5zdWJzdHJpbmcoaW5kZXggKyBzZXBhcmF0b3IubGVuZ3RoKTsKCiAgICAgICAgICAgIGlmICh0b2tlbi5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICB0b2tlbiA9IG9wdHMuY3JlYXRlU2VhcmNoQ2hvaWNlLmNhbGwodGhpcywgdG9rZW4sIHNlbGVjdGlvbik7CiAgICAgICAgICAgICAgICBpZiAodG9rZW4gIT09IHVuZGVmaW5lZCAmJiB0b2tlbiAhPT0gbnVsbCAmJiBvcHRzLmlkKHRva2VuKSAhPT0gdW5kZWZpbmVkICYmIG9wdHMuaWQodG9rZW4pICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgZHVwZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIGwgPSBzZWxlY3Rpb24ubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcXVhbChvcHRzLmlkKHRva2VuKSwgb3B0cy5pZChzZWxlY3Rpb25baV0pKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZHVwZSA9IHRydWU7IGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAoIWR1cGUpIHNlbGVjdENhbGxiYWNrKHRva2VuKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKG9yaWdpbmFsIT09aW5wdXQpIHJldHVybiBpbnB1dDsKICAgIH0KCiAgICBmdW5jdGlvbiBjbGVhbnVwSlF1ZXJ5RWxlbWVudHMoKSB7CiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICAkLmVhY2goYXJndW1lbnRzLCBmdW5jdGlvbiAoaSwgZWxlbWVudCkgewogICAgICAgICAgICBzZWxmW2VsZW1lbnRdLnJlbW92ZSgpOwogICAgICAgICAgICBzZWxmW2VsZW1lbnRdID0gbnVsbDsKICAgICAgICB9KTsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBuZXcgY2xhc3MKICAgICAqCiAgICAgKiBAcGFyYW0gc3VwZXJDbGFzcwogICAgICogQHBhcmFtIG1ldGhvZHMKICAgICAqLwogICAgZnVuY3Rpb24gY2xhenooU3VwZXJDbGFzcywgbWV0aG9kcykgewogICAgICAgIHZhciBjb25zdHJ1Y3RvciA9IGZ1bmN0aW9uICgpIHt9OwogICAgICAgIGNvbnN0cnVjdG9yLnByb3RvdHlwZSA9IG5ldyBTdXBlckNsYXNzOwogICAgICAgIGNvbnN0cnVjdG9yLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IGNvbnN0cnVjdG9yOwogICAgICAgIGNvbnN0cnVjdG9yLnByb3RvdHlwZS5wYXJlbnQgPSBTdXBlckNsYXNzLnByb3RvdHlwZTsKICAgICAgICBjb25zdHJ1Y3Rvci5wcm90b3R5cGUgPSAkLmV4dGVuZChjb25zdHJ1Y3Rvci5wcm90b3R5cGUsIG1ldGhvZHMpOwogICAgICAgIHJldHVybiBjb25zdHJ1Y3RvcjsKICAgIH0KCiAgICBBYnN0cmFjdFNlbGVjdDIgPSBjbGF6eihPYmplY3QsIHsKCiAgICAgICAgLy8gYWJzdHJhY3QKICAgICAgICBiaW5kOiBmdW5jdGlvbiAoZnVuYykgewogICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBmdW5jLmFwcGx5KHNlbGYsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIH07CiAgICAgICAgfSwKCiAgICAgICAgLy8gYWJzdHJhY3QKICAgICAgICBpbml0OiBmdW5jdGlvbiAob3B0cykgewogICAgICAgICAgICB2YXIgcmVzdWx0cywgc2VhcmNoLCByZXN1bHRzU2VsZWN0b3IgPSAiLnNlbGVjdDItcmVzdWx0cyI7CgogICAgICAgICAgICAvLyBwcmVwYXJlIG9wdGlvbnMKICAgICAgICAgICAgdGhpcy5vcHRzID0gb3B0cyA9IHRoaXMucHJlcGFyZU9wdHMob3B0cyk7CgogICAgICAgICAgICB0aGlzLmlkPW9wdHMuaWQ7CgogICAgICAgICAgICAvLyBkZXN0cm95IGlmIGNhbGxlZCBvbiBhbiBleGlzdGluZyBjb21wb25lbnQKICAgICAgICAgICAgaWYgKG9wdHMuZWxlbWVudC5kYXRhKCJzZWxlY3QyIikgIT09IHVuZGVmaW5lZCAmJgogICAgICAgICAgICAgICAgb3B0cy5lbGVtZW50LmRhdGEoInNlbGVjdDIiKSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgb3B0cy5lbGVtZW50LmRhdGEoInNlbGVjdDIiKS5kZXN0cm95KCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gdGhpcy5jcmVhdGVDb250YWluZXIoKTsKCiAgICAgICAgICAgIHRoaXMubGl2ZVJlZ2lvbiA9ICQoIjxzcGFuPiIsIHsKICAgICAgICAgICAgICAgICAgICByb2xlOiAic3RhdHVzIiwKICAgICAgICAgICAgICAgICAgICAiYXJpYS1saXZlIjogInBvbGl0ZSIKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAuYWRkQ2xhc3MoInNlbGVjdDItaGlkZGVuLWFjY2Vzc2libGUiKQogICAgICAgICAgICAgICAgLmFwcGVuZFRvKGRvY3VtZW50LmJvZHkpOwoKICAgICAgICAgICAgdGhpcy5jb250YWluZXJJZD0iczJpZF8iKyhvcHRzLmVsZW1lbnQuYXR0cigiaWQiKSB8fCAiYXV0b2dlbiIrbmV4dFVpZCgpKTsKICAgICAgICAgICAgdGhpcy5jb250YWluZXJFdmVudE5hbWU9IHRoaXMuY29udGFpbmVySWQKICAgICAgICAgICAgICAgIC5yZXBsYWNlKC8oWy5dKS9nLCAnXycpCiAgICAgICAgICAgICAgICAucmVwbGFjZSgvKFs7JixcLVwuXCtcKlx+JzoiXCFcXiMkJUBcW1xdXChcKT0+XHxdKS9nLCAnXFwkMScpOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hdHRyKCJpZCIsIHRoaXMuY29udGFpbmVySWQpOwoKICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYXR0cigidGl0bGUiLCBvcHRzLmVsZW1lbnQuYXR0cigidGl0bGUiKSk7CgogICAgICAgICAgICB0aGlzLmJvZHkgPSAkKCJib2R5Iik7CgogICAgICAgICAgICBzeW5jQ3NzQ2xhc3Nlcyh0aGlzLmNvbnRhaW5lciwgdGhpcy5vcHRzLmVsZW1lbnQsIHRoaXMub3B0cy5hZGFwdENvbnRhaW5lckNzc0NsYXNzKTsKCiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmF0dHIoInN0eWxlIiwgb3B0cy5lbGVtZW50LmF0dHIoInN0eWxlIikpOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5jc3MoZXZhbHVhdGUob3B0cy5jb250YWluZXJDc3MsIHRoaXMub3B0cy5lbGVtZW50KSk7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZENsYXNzKGV2YWx1YXRlKG9wdHMuY29udGFpbmVyQ3NzQ2xhc3MsIHRoaXMub3B0cy5lbGVtZW50KSk7CgogICAgICAgICAgICB0aGlzLmVsZW1lbnRUYWJJbmRleCA9IHRoaXMub3B0cy5lbGVtZW50LmF0dHIoInRhYmluZGV4Iik7CgogICAgICAgICAgICAvLyBzd2FwIGNvbnRhaW5lciBmb3IgdGhlIGVsZW1lbnQKICAgICAgICAgICAgdGhpcy5vcHRzLmVsZW1lbnQKICAgICAgICAgICAgICAgIC5kYXRhKCJzZWxlY3QyIiwgdGhpcykKICAgICAgICAgICAgICAgIC5hdHRyKCJ0YWJpbmRleCIsICItMSIpCiAgICAgICAgICAgICAgICAuYmVmb3JlKHRoaXMuY29udGFpbmVyKQogICAgICAgICAgICAgICAgLm9uKCJjbGljay5zZWxlY3QyIiwga2lsbEV2ZW50KTsgLy8gZG8gbm90IGxlYWsgY2xpY2sgZXZlbnRzCgogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5kYXRhKCJzZWxlY3QyIiwgdGhpcyk7CgogICAgICAgICAgICB0aGlzLmRyb3Bkb3duID0gdGhpcy5jb250YWluZXIuZmluZCgiLnNlbGVjdDItZHJvcCIpOwoKICAgICAgICAgICAgc3luY0Nzc0NsYXNzZXModGhpcy5kcm9wZG93biwgdGhpcy5vcHRzLmVsZW1lbnQsIHRoaXMub3B0cy5hZGFwdERyb3Bkb3duQ3NzQ2xhc3MpOwoKICAgICAgICAgICAgdGhpcy5kcm9wZG93bi5hZGRDbGFzcyhldmFsdWF0ZShvcHRzLmRyb3Bkb3duQ3NzQ2xhc3MsIHRoaXMub3B0cy5lbGVtZW50KSk7CiAgICAgICAgICAgIHRoaXMuZHJvcGRvd24uZGF0YSgic2VsZWN0MiIsIHRoaXMpOwogICAgICAgICAgICB0aGlzLmRyb3Bkb3duLm9uKCJjbGljayIsIGtpbGxFdmVudCk7CgogICAgICAgICAgICB0aGlzLnJlc3VsdHMgPSByZXN1bHRzID0gdGhpcy5jb250YWluZXIuZmluZChyZXN1bHRzU2VsZWN0b3IpOwogICAgICAgICAgICB0aGlzLnNlYXJjaCA9IHNlYXJjaCA9IHRoaXMuY29udGFpbmVyLmZpbmQoImlucHV0LnNlbGVjdDItaW5wdXQiKTsKCiAgICAgICAgICAgIHRoaXMucXVlcnlDb3VudCA9IDA7CiAgICAgICAgICAgIHRoaXMucmVzdWx0c1BhZ2UgPSAwOwogICAgICAgICAgICB0aGlzLmNvbnRleHQgPSBudWxsOwoKICAgICAgICAgICAgLy8gaW5pdGlhbGl6ZSB0aGUgY29udGFpbmVyCiAgICAgICAgICAgIHRoaXMuaW5pdENvbnRhaW5lcigpOwoKICAgICAgICAgICAgdGhpcy5jb250YWluZXIub24oImNsaWNrIiwga2lsbEV2ZW50KTsKCiAgICAgICAgICAgIGluc3RhbGxGaWx0ZXJlZE1vdXNlTW92ZSh0aGlzLnJlc3VsdHMpOwoKICAgICAgICAgICAgdGhpcy5kcm9wZG93bi5vbigibW91c2Vtb3ZlLWZpbHRlcmVkIiwgcmVzdWx0c1NlbGVjdG9yLCB0aGlzLmJpbmQodGhpcy5oaWdobGlnaHRVbmRlckV2ZW50KSk7CiAgICAgICAgICAgIHRoaXMuZHJvcGRvd24ub24oInRvdWNoc3RhcnQgdG91Y2htb3ZlIHRvdWNoZW5kIiwgcmVzdWx0c1NlbGVjdG9yLCB0aGlzLmJpbmQoZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICB0aGlzLl90b3VjaEV2ZW50ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuaGlnaGxpZ2h0VW5kZXJFdmVudChldmVudCk7CiAgICAgICAgICAgIH0pKTsKICAgICAgICAgICAgdGhpcy5kcm9wZG93bi5vbigidG91Y2htb3ZlIiwgcmVzdWx0c1NlbGVjdG9yLCB0aGlzLmJpbmQodGhpcy50b3VjaE1vdmVkKSk7CiAgICAgICAgICAgIHRoaXMuZHJvcGRvd24ub24oInRvdWNoc3RhcnQgdG91Y2hlbmQiLCByZXN1bHRzU2VsZWN0b3IsIHRoaXMuYmluZCh0aGlzLmNsZWFyVG91Y2hNb3ZlZCkpOwoKICAgICAgICAgICAgLy8gV2FpdGluZyBmb3IgYSBjbGljayBldmVudCBvbiB0b3VjaCBkZXZpY2VzIHRvIHNlbGVjdCBvcHRpb24gYW5kIGhpZGUgZHJvcGRvd24KICAgICAgICAgICAgLy8gb3RoZXJ3aXNlIGNsaWNrIHdpbGwgYmUgdHJpZ2dlcmVkIG9uIGFuIHVuZGVybHlpbmcgZWxlbWVudAogICAgICAgICAgICB0aGlzLmRyb3Bkb3duLm9uKCdjbGljaycsIHRoaXMuYmluZChmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl90b3VjaEV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdG91Y2hFdmVudCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0SGlnaGxpZ2h0ZWQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSkpOwoKICAgICAgICAgICAgaW5zdGFsbERlYm91bmNlZFNjcm9sbCg4MCwgdGhpcy5yZXN1bHRzKTsKICAgICAgICAgICAgdGhpcy5kcm9wZG93bi5vbigic2Nyb2xsLWRlYm91bmNlZCIsIHJlc3VsdHNTZWxlY3RvciwgdGhpcy5iaW5kKHRoaXMubG9hZE1vcmVJZk5lZWRlZCkpOwoKICAgICAgICAgICAgLy8gZG8gbm90IHByb3BhZ2F0ZSBjaGFuZ2UgZXZlbnQgZnJvbSB0aGUgc2VhcmNoIGZpZWxkIG91dCBvZiB0aGUgY29tcG9uZW50CiAgICAgICAgICAgICQodGhpcy5jb250YWluZXIpLm9uKCJjaGFuZ2UiLCAiLnNlbGVjdDItaW5wdXQiLCBmdW5jdGlvbihlKSB7ZS5zdG9wUHJvcGFnYXRpb24oKTt9KTsKICAgICAgICAgICAgJCh0aGlzLmRyb3Bkb3duKS5vbigiY2hhbmdlIiwgIi5zZWxlY3QyLWlucHV0IiwgZnVuY3Rpb24oZSkge2Uuc3RvcFByb3BhZ2F0aW9uKCk7fSk7CgogICAgICAgICAgICAvLyBpZiBqcXVlcnkubW91c2V3aGVlbCBwbHVnaW4gaXMgaW5zdGFsbGVkIHdlIGNhbiBwcmV2ZW50IG91dC1vZi1ib3VuZHMgc2Nyb2xsaW5nIG9mIHJlc3VsdHMgdmlhIG1vdXNld2hlZWwKICAgICAgICAgICAgaWYgKCQuZm4ubW91c2V3aGVlbCkgewogICAgICAgICAgICAgICAgcmVzdWx0cy5tb3VzZXdoZWVsKGZ1bmN0aW9uIChlLCBkZWx0YSwgZGVsdGFYLCBkZWx0YVkpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdG9wID0gcmVzdWx0cy5zY3JvbGxUb3AoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoZGVsdGFZID4gMCAmJiB0b3AgLSBkZWx0YVkgPD0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzLnNjcm9sbFRvcCgwKTsKICAgICAgICAgICAgICAgICAgICAgICAga2lsbEV2ZW50KGUpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZGVsdGFZIDwgMCAmJiByZXN1bHRzLmdldCgwKS5zY3JvbGxIZWlnaHQgLSByZXN1bHRzLnNjcm9sbFRvcCgpICsgZGVsdGFZIDw9IHJlc3VsdHMuaGVpZ2h0KCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0cy5zY3JvbGxUb3AocmVzdWx0cy5nZXQoMCkuc2Nyb2xsSGVpZ2h0IC0gcmVzdWx0cy5oZWlnaHQoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGtpbGxFdmVudChlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaW5zdGFsbEtleVVwQ2hhbmdlRXZlbnQoc2VhcmNoKTsKICAgICAgICAgICAgc2VhcmNoLm9uKCJrZXl1cC1jaGFuZ2UgaW5wdXQgcGFzdGUiLCB0aGlzLmJpbmQodGhpcy51cGRhdGVSZXN1bHRzKSk7CiAgICAgICAgICAgIHNlYXJjaC5vbigiZm9jdXMiLCBmdW5jdGlvbiAoKSB7IHNlYXJjaC5hZGRDbGFzcygic2VsZWN0Mi1mb2N1c2VkIik7IH0pOwogICAgICAgICAgICBzZWFyY2gub24oImJsdXIiLCBmdW5jdGlvbiAoKSB7IHNlYXJjaC5yZW1vdmVDbGFzcygic2VsZWN0Mi1mb2N1c2VkIik7fSk7CgogICAgICAgICAgICB0aGlzLmRyb3Bkb3duLm9uKCJtb3VzZXVwIiwgcmVzdWx0c1NlbGVjdG9yLCB0aGlzLmJpbmQoZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICAgIGlmICgkKGUudGFyZ2V0KS5jbG9zZXN0KCIuc2VsZWN0Mi1yZXN1bHQtc2VsZWN0YWJsZSIpLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmhpZ2hsaWdodFVuZGVyRXZlbnQoZSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RIaWdobGlnaHRlZChlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSkpOwoKICAgICAgICAgICAgLy8gdHJhcCBhbGwgbW91c2UgZXZlbnRzIGZyb20gbGVhdmluZyB0aGUgZHJvcGRvd24uIHNvbWV0aW1lcyB0aGVyZSBtYXkgYmUgYSBtb2RhbCB0aGF0IGlzIGxpc3RlbmluZwogICAgICAgICAgICAvLyBmb3IgbW91c2UgZXZlbnRzIG91dHNpZGUgb2YgaXRzZWxmIHNvIGl0IGNhbiBjbG9zZSBpdHNlbGYuIHNpbmNlIHRoZSBkcm9wZG93biBpcyBub3cgb3V0c2lkZSB0aGUgc2VsZWN0MidzCiAgICAgICAgICAgIC8vIGRvbSBpdCB3aWxsIHRyaWdnZXIgdGhlIHBvcHVwIGNsb3NlLCB3aGljaCBpcyBub3Qgd2hhdCB3ZSB3YW50CiAgICAgICAgICAgIC8vIGZvY3VzaW4gY2FuIGNhdXNlIGZvY3VzIHdhcnMgYmV0d2VlbiBtb2RhbHMgYW5kIHNlbGVjdDIgc2luY2UgdGhlIGRyb3Bkb3duIGlzIG91dHNpZGUgdGhlIG1vZGFsLgogICAgICAgICAgICB0aGlzLmRyb3Bkb3duLm9uKCJjbGljayBtb3VzZXVwIG1vdXNlZG93biB0b3VjaHN0YXJ0IHRvdWNoZW5kIGZvY3VzaW4iLCBmdW5jdGlvbiAoZSkgeyBlLnN0b3BQcm9wYWdhdGlvbigpOyB9KTsKCiAgICAgICAgICAgIHRoaXMubmV4dFNlYXJjaFRlcm0gPSB1bmRlZmluZWQ7CgogICAgICAgICAgICBpZiAoJC5pc0Z1bmN0aW9uKHRoaXMub3B0cy5pbml0U2VsZWN0aW9uKSkgewogICAgICAgICAgICAgICAgLy8gaW5pdGlhbGl6ZSBzZWxlY3Rpb24gYmFzZWQgb24gdGhlIGN1cnJlbnQgdmFsdWUgb2YgdGhlIHNvdXJjZSBlbGVtZW50CiAgICAgICAgICAgICAgICB0aGlzLmluaXRTZWxlY3Rpb24oKTsKCiAgICAgICAgICAgICAgICAvLyBpZiB0aGUgdXNlciBoYXMgcHJvdmlkZWQgYSBmdW5jdGlvbiB0aGF0IGNhbiBzZXQgc2VsZWN0aW9uIGJhc2VkIG9uIHRoZSB2YWx1ZSBvZiB0aGUgc291cmNlIGVsZW1lbnQKICAgICAgICAgICAgICAgIC8vIHdlIG1vbml0b3IgdGhlIGNoYW5nZSBldmVudCBvbiB0aGUgZWxlbWVudCBhbmQgdHJpZ2dlciBpdCwgYWxsb3dpbmcgZm9yIHR3byB3YXkgc3luY2hyb25pemF0aW9uCiAgICAgICAgICAgICAgICB0aGlzLm1vbml0b3JTb3VyY2UoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKG9wdHMubWF4aW11bUlucHV0TGVuZ3RoICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNlYXJjaC5hdHRyKCJtYXhsZW5ndGgiLCBvcHRzLm1heGltdW1JbnB1dExlbmd0aCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBkaXNhYmxlZCA9IG9wdHMuZWxlbWVudC5wcm9wKCJkaXNhYmxlZCIpOwogICAgICAgICAgICBpZiAoZGlzYWJsZWQgPT09IHVuZGVmaW5lZCkgZGlzYWJsZWQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5lbmFibGUoIWRpc2FibGVkKTsKCiAgICAgICAgICAgIHZhciByZWFkb25seSA9IG9wdHMuZWxlbWVudC5wcm9wKCJyZWFkb25seSIpOwogICAgICAgICAgICBpZiAocmVhZG9ubHkgPT09IHVuZGVmaW5lZCkgcmVhZG9ubHkgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5yZWFkb25seShyZWFkb25seSk7CgogICAgICAgICAgICAvLyBDYWxjdWxhdGUgc2l6ZSBvZiBzY3JvbGxiYXIKICAgICAgICAgICAgc2Nyb2xsQmFyRGltZW5zaW9ucyA9IHNjcm9sbEJhckRpbWVuc2lvbnMgfHwgbWVhc3VyZVNjcm9sbGJhcigpOwoKICAgICAgICAgICAgdGhpcy5hdXRvZm9jdXMgPSBvcHRzLmVsZW1lbnQucHJvcCgiYXV0b2ZvY3VzIik7CiAgICAgICAgICAgIG9wdHMuZWxlbWVudC5wcm9wKCJhdXRvZm9jdXMiLCBmYWxzZSk7CiAgICAgICAgICAgIGlmICh0aGlzLmF1dG9mb2N1cykgdGhpcy5mb2N1cygpOwoKICAgICAgICAgICAgdGhpcy5zZWFyY2guYXR0cigicGxhY2Vob2xkZXIiLCBvcHRzLnNlYXJjaElucHV0UGxhY2Vob2xkZXIpOwogICAgICAgIH0sCgogICAgICAgIC8vIGFic3RyYWN0CiAgICAgICAgZGVzdHJveTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgZWxlbWVudD10aGlzLm9wdHMuZWxlbWVudCwgc2VsZWN0MiA9IGVsZW1lbnQuZGF0YSgic2VsZWN0MiIpOwoKICAgICAgICAgICAgdGhpcy5jbG9zZSgpOwoKICAgICAgICAgICAgaWYgKGVsZW1lbnQubGVuZ3RoICYmIGVsZW1lbnRbMF0uZGV0YWNoRXZlbnQpIHsKICAgICAgICAgICAgICAgIGVsZW1lbnQuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kZXRhY2hFdmVudCgib25wcm9wZXJ0eWNoYW5nZSIsIHRoaXMuX3N5bmMpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMucHJvcGVydHlPYnNlcnZlcikgewogICAgICAgICAgICAgICAgdGhpcy5wcm9wZXJ0eU9ic2VydmVyLmRpc2Nvbm5lY3QoKTsKICAgICAgICAgICAgICAgIHRoaXMucHJvcGVydHlPYnNlcnZlciA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5fc3luYyA9IG51bGw7CgogICAgICAgICAgICBpZiAoc2VsZWN0MiAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBzZWxlY3QyLmNvbnRhaW5lci5yZW1vdmUoKTsKICAgICAgICAgICAgICAgIHNlbGVjdDIubGl2ZVJlZ2lvbi5yZW1vdmUoKTsKICAgICAgICAgICAgICAgIHNlbGVjdDIuZHJvcGRvd24ucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICBlbGVtZW50CiAgICAgICAgICAgICAgICAgICAgLnJlbW92ZUNsYXNzKCJzZWxlY3QyLW9mZnNjcmVlbiIpCiAgICAgICAgICAgICAgICAgICAgLnJlbW92ZURhdGEoInNlbGVjdDIiKQogICAgICAgICAgICAgICAgICAgIC5vZmYoIi5zZWxlY3QyIikKICAgICAgICAgICAgICAgICAgICAucHJvcCgiYXV0b2ZvY3VzIiwgdGhpcy5hdXRvZm9jdXMgfHwgZmFsc2UpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZWxlbWVudFRhYkluZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5hdHRyKHt0YWJpbmRleDogdGhpcy5lbGVtZW50VGFiSW5kZXh9KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5yZW1vdmVBdHRyKCJ0YWJpbmRleCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxlbWVudC5zaG93KCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNsZWFudXBKUXVlcnlFbGVtZW50cy5jYWxsKHRoaXMsCiAgICAgICAgICAgICAgICAiY29udGFpbmVyIiwKICAgICAgICAgICAgICAgICJsaXZlUmVnaW9uIiwKICAgICAgICAgICAgICAgICJkcm9wZG93biIsCiAgICAgICAgICAgICAgICAicmVzdWx0cyIsCiAgICAgICAgICAgICAgICAic2VhcmNoIgogICAgICAgICAgICApOwogICAgICAgIH0sCgogICAgICAgIC8vIGFic3RyYWN0CiAgICAgICAgb3B0aW9uVG9EYXRhOiBmdW5jdGlvbihlbGVtZW50KSB7CiAgICAgICAgICAgIGlmIChlbGVtZW50LmlzKCJvcHRpb24iKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICBpZDplbGVtZW50LnByb3AoInZhbHVlIiksCiAgICAgICAgICAgICAgICAgICAgdGV4dDplbGVtZW50LnRleHQoKSwKICAgICAgICAgICAgICAgICAgICBlbGVtZW50OiBlbGVtZW50LmdldCgpLAogICAgICAgICAgICAgICAgICAgIGNzczogZWxlbWVudC5hdHRyKCJjbGFzcyIpLAogICAgICAgICAgICAgICAgICAgIGRpc2FibGVkOiBlbGVtZW50LnByb3AoImRpc2FibGVkIiksCiAgICAgICAgICAgICAgICAgICAgbG9ja2VkOiBlcXVhbChlbGVtZW50LmF0dHIoImxvY2tlZCIpLCAibG9ja2VkIikgfHwgZXF1YWwoZWxlbWVudC5kYXRhKCJsb2NrZWQiKSwgdHJ1ZSkKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZWxlbWVudC5pcygib3B0Z3JvdXAiKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICB0ZXh0OmVsZW1lbnQuYXR0cigibGFiZWwiKSwKICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbjpbXSwKICAgICAgICAgICAgICAgICAgICBlbGVtZW50OiBlbGVtZW50LmdldCgpLAogICAgICAgICAgICAgICAgICAgIGNzczogZWxlbWVudC5hdHRyKCJjbGFzcyIpCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLy8gYWJzdHJhY3QKICAgICAgICBwcmVwYXJlT3B0czogZnVuY3Rpb24gKG9wdHMpIHsKICAgICAgICAgICAgdmFyIGVsZW1lbnQsIHNlbGVjdCwgaWRLZXksIGFqYXhVcmwsIHNlbGYgPSB0aGlzOwoKICAgICAgICAgICAgZWxlbWVudCA9IG9wdHMuZWxlbWVudDsKCiAgICAgICAgICAgIGlmIChlbGVtZW50LmdldCgwKS50YWdOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJzZWxlY3QiKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdCA9IHNlbGVjdCA9IG9wdHMuZWxlbWVudDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHNlbGVjdCkgewogICAgICAgICAgICAgICAgLy8gdGhlc2Ugb3B0aW9ucyBhcmUgbm90IGFsbG93ZWQgd2hlbiBhdHRhY2hlZCB0byBhIHNlbGVjdCBiZWNhdXNlIHRoZXkgYXJlIHBpY2tlZCB1cCBvZmYgdGhlIGVsZW1lbnQgaXRzZWxmCiAgICAgICAgICAgICAgICAkLmVhY2goWyJpZCIsICJtdWx0aXBsZSIsICJhamF4IiwgInF1ZXJ5IiwgImNyZWF0ZVNlYXJjaENob2ljZSIsICJpbml0U2VsZWN0aW9uIiwgImRhdGEiLCAidGFncyJdLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMgaW4gb3B0cykgewogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk9wdGlvbiAnIiArIHRoaXMgKyAiJyBpcyBub3QgYWxsb3dlZCBmb3IgU2VsZWN0MiB3aGVuIGF0dGFjaGVkIHRvIGEgPHNlbGVjdD4gZWxlbWVudC4iKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgb3B0cyA9ICQuZXh0ZW5kKHt9LCB7CiAgICAgICAgICAgICAgICBwb3B1bGF0ZVJlc3VsdHM6IGZ1bmN0aW9uKGNvbnRhaW5lciwgcmVzdWx0cywgcXVlcnkpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcG9wdWxhdGUsIGlkPXRoaXMub3B0cy5pZCwgbGl2ZVJlZ2lvbj10aGlzLmxpdmVSZWdpb247CgogICAgICAgICAgICAgICAgICAgIHBvcHVsYXRlPWZ1bmN0aW9uKHJlc3VsdHMsIGNvbnRhaW5lciwgZGVwdGgpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpLCBsLCByZXN1bHQsIHNlbGVjdGFibGUsIGRpc2FibGVkLCBjb21wb3VuZCwgbm9kZSwgbGFiZWwsIGlubmVyQ29udGFpbmVyLCBmb3JtYXR0ZWQ7CgogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzID0gb3B0cy5zb3J0UmVzdWx0cyhyZXN1bHRzLCBjb250YWluZXIsIHF1ZXJ5KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNvbGxlY3QgdGhlIGNyZWF0ZWQgbm9kZXMgZm9yIGJ1bGsgYXBwZW5kCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBub2RlcyA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBsID0gcmVzdWx0cy5sZW5ndGg7IGkgPCBsOyBpID0gaSArIDEpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQ9cmVzdWx0c1tpXTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNhYmxlZCA9IChyZXN1bHQuZGlzYWJsZWQgPT09IHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0YWJsZSA9ICghZGlzYWJsZWQpICYmIChpZChyZXN1bHQpICE9PSB1bmRlZmluZWQpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBvdW5kPXJlc3VsdC5jaGlsZHJlbiAmJiByZXN1bHQuY2hpbGRyZW4ubGVuZ3RoID4gMDsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlPSQoIjxsaT48L2xpPiIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5hZGRDbGFzcygic2VsZWN0Mi1yZXN1bHRzLWRlcHQtIitkZXB0aCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLmFkZENsYXNzKCJzZWxlY3QyLXJlc3VsdCIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5hZGRDbGFzcyhzZWxlY3RhYmxlID8gInNlbGVjdDItcmVzdWx0LXNlbGVjdGFibGUiIDogInNlbGVjdDItcmVzdWx0LXVuc2VsZWN0YWJsZSIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRpc2FibGVkKSB7IG5vZGUuYWRkQ2xhc3MoInNlbGVjdDItZGlzYWJsZWQiKTsgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbXBvdW5kKSB7IG5vZGUuYWRkQ2xhc3MoInNlbGVjdDItcmVzdWx0LXdpdGgtY2hpbGRyZW4iKTsgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5hZGRDbGFzcyhzZWxmLm9wdHMuZm9ybWF0UmVzdWx0Q3NzQ2xhc3MocmVzdWx0KSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLmF0dHIoInJvbGUiLCAicHJlc2VudGF0aW9uIik7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw9JChkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbC5hZGRDbGFzcygic2VsZWN0Mi1yZXN1bHQtbGFiZWwiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsLmF0dHIoImlkIiwgInNlbGVjdDItcmVzdWx0LWxhYmVsLSIgKyBuZXh0VWlkKCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWwuYXR0cigicm9sZSIsICJvcHRpb24iKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtYXR0ZWQ9b3B0cy5mb3JtYXRSZXN1bHQocmVzdWx0LCBsYWJlbCwgcXVlcnksIHNlbGYub3B0cy5lc2NhcGVNYXJrdXApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZvcm1hdHRlZCE9PXVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsLmh0bWwoZm9ybWF0dGVkKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLmFwcGVuZChsYWJlbCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb21wb3VuZCkgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbm5lckNvbnRhaW5lcj0kKCI8dWw+PC91bD4iKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbm5lckNvbnRhaW5lci5hZGRDbGFzcygic2VsZWN0Mi1yZXN1bHQtc3ViIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9wdWxhdGUocmVzdWx0LmNoaWxkcmVuLCBpbm5lckNvbnRhaW5lciwgZGVwdGgrMSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5hcHBlbmQoaW5uZXJDb250YWluZXIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuZGF0YSgic2VsZWN0Mi1kYXRhIiwgcmVzdWx0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVzLnB1c2gobm9kZVswXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGJ1bGsgYXBwZW5kIHRoZSBjcmVhdGVkIG5vZGVzCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lci5hcHBlbmQobm9kZXMpOwogICAgICAgICAgICAgICAgICAgICAgICBsaXZlUmVnaW9uLnRleHQob3B0cy5mb3JtYXRNYXRjaGVzKHJlc3VsdHMubGVuZ3RoKSk7CiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgcG9wdWxhdGUocmVzdWx0cywgY29udGFpbmVyLCAwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgJC5mbi5zZWxlY3QyLmRlZmF1bHRzLCBvcHRzKTsKCiAgICAgICAgICAgIGlmICh0eXBlb2Yob3B0cy5pZCkgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGlkS2V5ID0gb3B0cy5pZDsKICAgICAgICAgICAgICAgIG9wdHMuaWQgPSBmdW5jdGlvbiAoZSkgeyByZXR1cm4gZVtpZEtleV07IH07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICgkLmlzQXJyYXkob3B0cy5lbGVtZW50LmRhdGEoInNlbGVjdDJUYWdzIikpKSB7CiAgICAgICAgICAgICAgICBpZiAoInRhZ3MiIGluIG9wdHMpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyAidGFncyBzcGVjaWZpZWQgYXMgYm90aCBhbiBhdHRyaWJ1dGUgJ2RhdGEtc2VsZWN0Mi10YWdzJyBhbmQgaW4gb3B0aW9ucyBvZiBTZWxlY3QyICIgKyBvcHRzLmVsZW1lbnQuYXR0cigiaWQiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG9wdHMudGFncz1vcHRzLmVsZW1lbnQuZGF0YSgic2VsZWN0MlRhZ3MiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHNlbGVjdCkgewogICAgICAgICAgICAgICAgb3B0cy5xdWVyeSA9IHRoaXMuYmluZChmdW5jdGlvbiAocXVlcnkpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZGF0YSA9IHsgcmVzdWx0czogW10sIG1vcmU6IGZhbHNlIH0sCiAgICAgICAgICAgICAgICAgICAgICAgIHRlcm0gPSBxdWVyeS50ZXJtLAogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbiwgcGxhY2Vob2xkZXJPcHRpb24sIHByb2Nlc3M7CgogICAgICAgICAgICAgICAgICAgIHByb2Nlc3M9ZnVuY3Rpb24oZWxlbWVudCwgY29sbGVjdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZ3JvdXA7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbGVtZW50LmlzKCJvcHRpb24iKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHF1ZXJ5Lm1hdGNoZXIodGVybSwgZWxlbWVudC50ZXh0KCksIGVsZW1lbnQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sbGVjdGlvbi5wdXNoKHNlbGYub3B0aW9uVG9EYXRhKGVsZW1lbnQpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChlbGVtZW50LmlzKCJvcHRncm91cCIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm91cD1zZWxmLm9wdGlvblRvRGF0YShlbGVtZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuY2hpbGRyZW4oKS5lYWNoMihmdW5jdGlvbihpLCBlbG0pIHsgcHJvY2VzcyhlbG0sIGdyb3VwLmNoaWxkcmVuKTsgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZ3JvdXAuY2hpbGRyZW4ubGVuZ3RoPjApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xsZWN0aW9uLnB1c2goZ3JvdXApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgY2hpbGRyZW49ZWxlbWVudC5jaGlsZHJlbigpOwoKICAgICAgICAgICAgICAgICAgICAvLyBpZ25vcmUgdGhlIHBsYWNlaG9sZGVyIG9wdGlvbiBpZiB0aGVyZSBpcyBvbmUKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXRQbGFjZWhvbGRlcigpICE9PSB1bmRlZmluZWQgJiYgY2hpbGRyZW4ubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBwbGFjZWhvbGRlck9wdGlvbiA9IHRoaXMuZ2V0UGxhY2Vob2xkZXJPcHRpb24oKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBsYWNlaG9sZGVyT3B0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbj1jaGlsZHJlbi5ub3QocGxhY2Vob2xkZXJPcHRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbi5lYWNoMihmdW5jdGlvbihpLCBlbG0pIHsgcHJvY2VzcyhlbG0sIGRhdGEucmVzdWx0cyk7IH0pOwoKICAgICAgICAgICAgICAgICAgICBxdWVyeS5jYWxsYmFjayhkYXRhKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgLy8gdGhpcyBpcyBuZWVkZWQgYmVjYXVzZSBpbnNpZGUgdmFsKCkgd2UgY29uc3RydWN0IGNob2ljZXMgZnJvbSBvcHRpb25zIGFuZCB0aGVyZSBpZCBpcyBoYXJkY29kZWQKICAgICAgICAgICAgICAgIG9wdHMuaWQ9ZnVuY3Rpb24oZSkgeyByZXR1cm4gZS5pZDsgfTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICghKCJxdWVyeSIgaW4gb3B0cykpIHsKCiAgICAgICAgICAgICAgICAgICAgaWYgKCJhamF4IiBpbiBvcHRzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFqYXhVcmwgPSBvcHRzLmVsZW1lbnQuZGF0YSgiYWpheC11cmwiKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFqYXhVcmwgJiYgYWpheFVybC5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRzLmFqYXgudXJsID0gYWpheFVybDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBvcHRzLnF1ZXJ5ID0gYWpheC5jYWxsKG9wdHMuZWxlbWVudCwgb3B0cy5hamF4KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCJkYXRhIiBpbiBvcHRzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG9wdHMucXVlcnkgPSBsb2NhbChvcHRzLmRhdGEpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoInRhZ3MiIGluIG9wdHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgb3B0cy5xdWVyeSA9IHRhZ3Mob3B0cy50YWdzKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9wdHMuY3JlYXRlU2VhcmNoQ2hvaWNlID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdHMuY3JlYXRlU2VhcmNoQ2hvaWNlID0gZnVuY3Rpb24gKHRlcm0pIHsgcmV0dXJuIHtpZDogJC50cmltKHRlcm0pLCB0ZXh0OiAkLnRyaW0odGVybSl9OyB9OwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHRzLmluaXRTZWxlY3Rpb24gPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0cy5pbml0U2VsZWN0aW9uID0gZnVuY3Rpb24gKGVsZW1lbnQsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGRhdGEgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKHNwbGl0VmFsKGVsZW1lbnQudmFsKCksIG9wdHMuc2VwYXJhdG9yKSkuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBvYmogPSB7IGlkOiB0aGlzLCB0ZXh0OiB0aGlzIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YWdzID0gb3B0cy50YWdzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoJC5pc0Z1bmN0aW9uKHRhZ3MpKSB0YWdzPXRhZ3MoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJCh0YWdzKS5lYWNoKGZ1bmN0aW9uKCkgeyBpZiAoZXF1YWwodGhpcy5pZCwgb2JqLmlkKSkgeyBvYmogPSB0aGlzOyByZXR1cm4gZmFsc2U7IH0gfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEucHVzaChvYmopOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhkYXRhKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZihvcHRzLnF1ZXJ5KSAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgdGhyb3cgInF1ZXJ5IGZ1bmN0aW9uIG5vdCBkZWZpbmVkIGZvciBTZWxlY3QyICIgKyBvcHRzLmVsZW1lbnQuYXR0cigiaWQiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKG9wdHMuY3JlYXRlU2VhcmNoQ2hvaWNlUG9zaXRpb24gPT09ICd0b3AnKSB7CiAgICAgICAgICAgICAgICBvcHRzLmNyZWF0ZVNlYXJjaENob2ljZVBvc2l0aW9uID0gZnVuY3Rpb24obGlzdCwgaXRlbSkgeyBsaXN0LnVuc2hpZnQoaXRlbSk7IH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAob3B0cy5jcmVhdGVTZWFyY2hDaG9pY2VQb3NpdGlvbiA9PT0gJ2JvdHRvbScpIHsKICAgICAgICAgICAgICAgIG9wdHMuY3JlYXRlU2VhcmNoQ2hvaWNlUG9zaXRpb24gPSBmdW5jdGlvbihsaXN0LCBpdGVtKSB7IGxpc3QucHVzaChpdGVtKTsgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmICh0eXBlb2Yob3B0cy5jcmVhdGVTZWFyY2hDaG9pY2VQb3NpdGlvbikgIT09ICJmdW5jdGlvbiIpICB7CiAgICAgICAgICAgICAgICB0aHJvdyAiaW52YWxpZCBjcmVhdGVTZWFyY2hDaG9pY2VQb3NpdGlvbiBvcHRpb24gbXVzdCBiZSAndG9wJywgJ2JvdHRvbScgb3IgYSBjdXN0b20gZnVuY3Rpb24iOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gb3B0czsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBNb25pdG9yIHRoZSBvcmlnaW5hbCBlbGVtZW50IGZvciBjaGFuZ2VzIGFuZCB1cGRhdGUgc2VsZWN0MiBhY2NvcmRpbmdseQogICAgICAgICAqLwogICAgICAgIC8vIGFic3RyYWN0CiAgICAgICAgbW9uaXRvclNvdXJjZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgZWwgPSB0aGlzLm9wdHMuZWxlbWVudCwgb2JzZXJ2ZXIsIHNlbGYgPSB0aGlzOwoKICAgICAgICAgICAgZWwub24oImNoYW5nZS5zZWxlY3QyIiwgdGhpcy5iaW5kKGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5vcHRzLmVsZW1lbnQuZGF0YSgic2VsZWN0Mi1jaGFuZ2UtdHJpZ2dlcmVkIikgIT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmluaXRTZWxlY3Rpb24oKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSkpOwoKICAgICAgICAgICAgdGhpcy5fc3luYyA9IHRoaXMuYmluZChmdW5jdGlvbiAoKSB7CgogICAgICAgICAgICAgICAgLy8gc3luYyBlbmFibGVkIHN0YXRlCiAgICAgICAgICAgICAgICB2YXIgZGlzYWJsZWQgPSBlbC5wcm9wKCJkaXNhYmxlZCIpOwogICAgICAgICAgICAgICAgaWYgKGRpc2FibGVkID09PSB1bmRlZmluZWQpIGRpc2FibGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLmVuYWJsZSghZGlzYWJsZWQpOwoKICAgICAgICAgICAgICAgIHZhciByZWFkb25seSA9IGVsLnByb3AoInJlYWRvbmx5Iik7CiAgICAgICAgICAgICAgICBpZiAocmVhZG9ubHkgPT09IHVuZGVmaW5lZCkgcmVhZG9ubHkgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMucmVhZG9ubHkocmVhZG9ubHkpOwoKICAgICAgICAgICAgICAgIHN5bmNDc3NDbGFzc2VzKHRoaXMuY29udGFpbmVyLCB0aGlzLm9wdHMuZWxlbWVudCwgdGhpcy5vcHRzLmFkYXB0Q29udGFpbmVyQ3NzQ2xhc3MpOwogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkQ2xhc3MoZXZhbHVhdGUodGhpcy5vcHRzLmNvbnRhaW5lckNzc0NsYXNzLCB0aGlzLm9wdHMuZWxlbWVudCkpOwoKICAgICAgICAgICAgICAgIHN5bmNDc3NDbGFzc2VzKHRoaXMuZHJvcGRvd24sIHRoaXMub3B0cy5lbGVtZW50LCB0aGlzLm9wdHMuYWRhcHREcm9wZG93bkNzc0NsYXNzKTsKICAgICAgICAgICAgICAgIHRoaXMuZHJvcGRvd24uYWRkQ2xhc3MoZXZhbHVhdGUodGhpcy5vcHRzLmRyb3Bkb3duQ3NzQ2xhc3MsIHRoaXMub3B0cy5lbGVtZW50KSk7CgogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIElFOC0xMCAoSUU5LzEwIHdvbid0IGZpcmUgcHJvcGVydHlDaGFuZ2UgdmlhIGF0dGFjaEV2ZW50TGlzdGVuZXIpCiAgICAgICAgICAgIGlmIChlbC5sZW5ndGggJiYgZWxbMF0uYXR0YWNoRXZlbnQpIHsKICAgICAgICAgICAgICAgIGVsLmVhY2goZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hdHRhY2hFdmVudCgib25wcm9wZXJ0eWNoYW5nZSIsIHNlbGYuX3N5bmMpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIHNhZmFyaSwgY2hyb21lLCBmaXJlZm94LCBJRTExCiAgICAgICAgICAgIG9ic2VydmVyID0gd2luZG93Lk11dGF0aW9uT2JzZXJ2ZXIgfHwgd2luZG93LldlYktpdE11dGF0aW9uT2JzZXJ2ZXJ8fCB3aW5kb3cuTW96TXV0YXRpb25PYnNlcnZlcjsKICAgICAgICAgICAgaWYgKG9ic2VydmVyICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnByb3BlcnR5T2JzZXJ2ZXIpIHsgZGVsZXRlIHRoaXMucHJvcGVydHlPYnNlcnZlcjsgdGhpcy5wcm9wZXJ0eU9ic2VydmVyID0gbnVsbDsgfQogICAgICAgICAgICAgICAgdGhpcy5wcm9wZXJ0eU9ic2VydmVyID0gbmV3IG9ic2VydmVyKGZ1bmN0aW9uIChtdXRhdGlvbnMpIHsKICAgICAgICAgICAgICAgICAgICAkLmVhY2gobXV0YXRpb25zLCBzZWxmLl9zeW5jKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgdGhpcy5wcm9wZXJ0eU9ic2VydmVyLm9ic2VydmUoZWwuZ2V0KDApLCB7IGF0dHJpYnV0ZXM6dHJ1ZSwgc3VidHJlZTpmYWxzZSB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8vIGFic3RyYWN0CiAgICAgICAgdHJpZ2dlclNlbGVjdDogZnVuY3Rpb24oZGF0YSkgewogICAgICAgICAgICB2YXIgZXZ0ID0gJC5FdmVudCgic2VsZWN0Mi1zZWxlY3RpbmciLCB7IHZhbDogdGhpcy5pZChkYXRhKSwgb2JqZWN0OiBkYXRhLCBjaG9pY2U6IGRhdGEgfSk7CiAgICAgICAgICAgIHRoaXMub3B0cy5lbGVtZW50LnRyaWdnZXIoZXZ0KTsKICAgICAgICAgICAgcmV0dXJuICFldnQuaXNEZWZhdWx0UHJldmVudGVkKCk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogVHJpZ2dlcnMgdGhlIGNoYW5nZSBldmVudCBvbiB0aGUgc291cmNlIGVsZW1lbnQKICAgICAgICAgKi8KICAgICAgICAvLyBhYnN0cmFjdAogICAgICAgIHRyaWdnZXJDaGFuZ2U6IGZ1bmN0aW9uIChkZXRhaWxzKSB7CgogICAgICAgICAgICBkZXRhaWxzID0gZGV0YWlscyB8fCB7fTsKICAgICAgICAgICAgZGV0YWlscz0gJC5leHRlbmQoe30sIGRldGFpbHMsIHsgdHlwZTogImNoYW5nZSIsIHZhbDogdGhpcy52YWwoKSB9KTsKICAgICAgICAgICAgLy8gcHJldmVudHMgcmVjdXJzaXZlIHRyaWdnZXJpbmcKICAgICAgICAgICAgdGhpcy5vcHRzLmVsZW1lbnQuZGF0YSgic2VsZWN0Mi1jaGFuZ2UtdHJpZ2dlcmVkIiwgdHJ1ZSk7CiAgICAgICAgICAgIHRoaXMub3B0cy5lbGVtZW50LnRyaWdnZXIoZGV0YWlscyk7CiAgICAgICAgICAgIHRoaXMub3B0cy5lbGVtZW50LmRhdGEoInNlbGVjdDItY2hhbmdlLXRyaWdnZXJlZCIsIGZhbHNlKTsKCiAgICAgICAgICAgIC8vIHNvbWUgdmFsaWRhdGlvbiBmcmFtZXdvcmtzIGlnbm9yZSB0aGUgY2hhbmdlIGV2ZW50IGFuZCBsaXN0ZW4gaW5zdGVhZCB0byBrZXl1cCwgY2xpY2sgZm9yIHNlbGVjdHMKICAgICAgICAgICAgLy8gc28gaGVyZSB3ZSB0cmlnZ2VyIHRoZSBjbGljayBldmVudCBtYW51YWxseQogICAgICAgICAgICB0aGlzLm9wdHMuZWxlbWVudC5jbGljaygpOwoKICAgICAgICAgICAgLy8gVmFsaWRhdGlvbkVuZ2luZSBpZ25vcmVzIHRoZSBjaGFuZ2UgZXZlbnQgYW5kIGxpc3RlbnMgaW5zdGVhZCB0byBibHVyCiAgICAgICAgICAgIC8vIHNvIGhlcmUgd2UgdHJpZ2dlciB0aGUgYmx1ciBldmVudCBtYW51YWxseSBpZiBzbyBkZXNpcmVkCiAgICAgICAgICAgIGlmICh0aGlzLm9wdHMuYmx1ck9uQ2hhbmdlKQogICAgICAgICAgICAgICAgdGhpcy5vcHRzLmVsZW1lbnQuYmx1cigpOwogICAgICAgIH0sCgogICAgICAgIC8vYWJzdHJhY3QKICAgICAgICBpc0ludGVyZmFjZUVuYWJsZWQ6IGZ1bmN0aW9uKCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmVuYWJsZWRJbnRlcmZhY2UgPT09IHRydWU7CiAgICAgICAgfSwKCiAgICAgICAgLy8gYWJzdHJhY3QKICAgICAgICBlbmFibGVJbnRlcmZhY2U6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgZW5hYmxlZCA9IHRoaXMuX2VuYWJsZWQgJiYgIXRoaXMuX3JlYWRvbmx5LAogICAgICAgICAgICAgICAgZGlzYWJsZWQgPSAhZW5hYmxlZDsKCiAgICAgICAgICAgIGlmIChlbmFibGVkID09PSB0aGlzLmVuYWJsZWRJbnRlcmZhY2UpIHJldHVybiBmYWxzZTsKCiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnRvZ2dsZUNsYXNzKCJzZWxlY3QyLWNvbnRhaW5lci1kaXNhYmxlZCIsIGRpc2FibGVkKTsKICAgICAgICAgICAgdGhpcy5jbG9zZSgpOwogICAgICAgICAgICB0aGlzLmVuYWJsZWRJbnRlcmZhY2UgPSBlbmFibGVkOwoKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSwKCiAgICAgICAgLy8gYWJzdHJhY3QKICAgICAgICBlbmFibGU6IGZ1bmN0aW9uKGVuYWJsZWQpIHsKICAgICAgICAgICAgaWYgKGVuYWJsZWQgPT09IHVuZGVmaW5lZCkgZW5hYmxlZCA9IHRydWU7CiAgICAgICAgICAgIGlmICh0aGlzLl9lbmFibGVkID09PSBlbmFibGVkKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuX2VuYWJsZWQgPSBlbmFibGVkOwoKICAgICAgICAgICAgdGhpcy5vcHRzLmVsZW1lbnQucHJvcCgiZGlzYWJsZWQiLCAhZW5hYmxlZCk7CiAgICAgICAgICAgIHRoaXMuZW5hYmxlSW50ZXJmYWNlKCk7CiAgICAgICAgfSwKCiAgICAgICAgLy8gYWJzdHJhY3QKICAgICAgICBkaXNhYmxlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5lbmFibGUoZmFsc2UpOwogICAgICAgIH0sCgogICAgICAgIC8vIGFic3RyYWN0CiAgICAgICAgcmVhZG9ubHk6IGZ1bmN0aW9uKGVuYWJsZWQpIHsKICAgICAgICAgICAgaWYgKGVuYWJsZWQgPT09IHVuZGVmaW5lZCkgZW5hYmxlZCA9IGZhbHNlOwogICAgICAgICAgICBpZiAodGhpcy5fcmVhZG9ubHkgPT09IGVuYWJsZWQpIHJldHVybjsKICAgICAgICAgICAgdGhpcy5fcmVhZG9ubHkgPSBlbmFibGVkOwoKICAgICAgICAgICAgdGhpcy5vcHRzLmVsZW1lbnQucHJvcCgicmVhZG9ubHkiLCBlbmFibGVkKTsKICAgICAgICAgICAgdGhpcy5lbmFibGVJbnRlcmZhY2UoKTsKICAgICAgICB9LAoKICAgICAgICAvLyBhYnN0cmFjdAogICAgICAgIG9wZW5lZDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gKHRoaXMuY29udGFpbmVyKSA/IHRoaXMuY29udGFpbmVyLmhhc0NsYXNzKCJzZWxlY3QyLWRyb3Bkb3duLW9wZW4iKSA6IGZhbHNlOwogICAgICAgIH0sCgogICAgICAgIC8vIGFic3RyYWN0CiAgICAgICAgcG9zaXRpb25Ecm9wZG93bjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciAkZHJvcGRvd24gPSB0aGlzLmRyb3Bkb3duLAogICAgICAgICAgICAgICAgb2Zmc2V0ID0gdGhpcy5jb250YWluZXIub2Zmc2V0KCksCiAgICAgICAgICAgICAgICBoZWlnaHQgPSB0aGlzLmNvbnRhaW5lci5vdXRlckhlaWdodChmYWxzZSksCiAgICAgICAgICAgICAgICB3aWR0aCA9IHRoaXMuY29udGFpbmVyLm91dGVyV2lkdGgoZmFsc2UpLAogICAgICAgICAgICAgICAgZHJvcEhlaWdodCA9ICRkcm9wZG93bi5vdXRlckhlaWdodChmYWxzZSksCiAgICAgICAgICAgICAgICAkd2luZG93ID0gJCh3aW5kb3cpLAogICAgICAgICAgICAgICAgd2luZG93V2lkdGggPSAkd2luZG93LndpZHRoKCksCiAgICAgICAgICAgICAgICB3aW5kb3dIZWlnaHQgPSAkd2luZG93LmhlaWdodCgpLAogICAgICAgICAgICAgICAgdmlld1BvcnRSaWdodCA9ICR3aW5kb3cuc2Nyb2xsTGVmdCgpICsgd2luZG93V2lkdGgsCiAgICAgICAgICAgICAgICB2aWV3cG9ydEJvdHRvbSA9ICR3aW5kb3cuc2Nyb2xsVG9wKCkgKyB3aW5kb3dIZWlnaHQsCiAgICAgICAgICAgICAgICBkcm9wVG9wID0gb2Zmc2V0LnRvcCArIGhlaWdodCwKICAgICAgICAgICAgICAgIGRyb3BMZWZ0ID0gb2Zmc2V0LmxlZnQsCiAgICAgICAgICAgICAgICBlbm91Z2hSb29tQmVsb3cgPSBkcm9wVG9wICsgZHJvcEhlaWdodCA8PSB2aWV3cG9ydEJvdHRvbSwKICAgICAgICAgICAgICAgIGVub3VnaFJvb21BYm92ZSA9IChvZmZzZXQudG9wIC0gZHJvcEhlaWdodCkgPj0gJHdpbmRvdy5zY3JvbGxUb3AoKSwKICAgICAgICAgICAgICAgIGRyb3BXaWR0aCA9ICRkcm9wZG93bi5vdXRlcldpZHRoKGZhbHNlKSwKICAgICAgICAgICAgICAgIGVub3VnaFJvb21PblJpZ2h0ID0gZHJvcExlZnQgKyBkcm9wV2lkdGggPD0gdmlld1BvcnRSaWdodCwKICAgICAgICAgICAgICAgIGFib3ZlTm93ID0gJGRyb3Bkb3duLmhhc0NsYXNzKCJzZWxlY3QyLWRyb3AtYWJvdmUiKSwKICAgICAgICAgICAgICAgIGJvZHlPZmZzZXQsCiAgICAgICAgICAgICAgICBhYm92ZSwKICAgICAgICAgICAgICAgIGNoYW5nZURpcmVjdGlvbiwKICAgICAgICAgICAgICAgIGNzcywKICAgICAgICAgICAgICAgIHJlc3VsdHNMaXN0Tm9kZTsKCiAgICAgICAgICAgIC8vIGFsd2F5cyBwcmVmZXIgdGhlIGN1cnJlbnQgYWJvdmUvYmVsb3cgYWxpZ25tZW50LCB1bmxlc3MgdGhlcmUgaXMgbm90IGVub3VnaCByb29tCiAgICAgICAgICAgIGlmIChhYm92ZU5vdykgewogICAgICAgICAgICAgICAgYWJvdmUgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKCFlbm91Z2hSb29tQWJvdmUgJiYgZW5vdWdoUm9vbUJlbG93KSB7CiAgICAgICAgICAgICAgICAgICAgY2hhbmdlRGlyZWN0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBhYm92ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYWJvdmUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIGlmICghZW5vdWdoUm9vbUJlbG93ICYmIGVub3VnaFJvb21BYm92ZSkgewogICAgICAgICAgICAgICAgICAgIGNoYW5nZURpcmVjdGlvbiA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgYWJvdmUgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvL2lmIHdlIGFyZSBjaGFuZ2luZyBkaXJlY3Rpb24gd2UgbmVlZCB0byBnZXQgcG9zaXRpb25zIHdoZW4gZHJvcGRvd24gaXMgaGlkZGVuOwogICAgICAgICAgICBpZiAoY2hhbmdlRGlyZWN0aW9uKSB7CiAgICAgICAgICAgICAgICAkZHJvcGRvd24uaGlkZSgpOwogICAgICAgICAgICAgICAgb2Zmc2V0ID0gdGhpcy5jb250YWluZXIub2Zmc2V0KCk7CiAgICAgICAgICAgICAgICBoZWlnaHQgPSB0aGlzLmNvbnRhaW5lci5vdXRlckhlaWdodChmYWxzZSk7CiAgICAgICAgICAgICAgICB3aWR0aCA9IHRoaXMuY29udGFpbmVyLm91dGVyV2lkdGgoZmFsc2UpOwogICAgICAgICAgICAgICAgZHJvcEhlaWdodCA9ICRkcm9wZG93bi5vdXRlckhlaWdodChmYWxzZSk7CiAgICAgICAgICAgICAgICB2aWV3UG9ydFJpZ2h0ID0gJHdpbmRvdy5zY3JvbGxMZWZ0KCkgKyB3aW5kb3dXaWR0aDsKICAgICAgICAgICAgICAgIHZpZXdwb3J0Qm90dG9tID0gJHdpbmRvdy5zY3JvbGxUb3AoKSArIHdpbmRvd0hlaWdodDsKICAgICAgICAgICAgICAgIGRyb3BUb3AgPSBvZmZzZXQudG9wICsgaGVpZ2h0OwogICAgICAgICAgICAgICAgZHJvcExlZnQgPSBvZmZzZXQubGVmdDsKICAgICAgICAgICAgICAgIGRyb3BXaWR0aCA9ICRkcm9wZG93bi5vdXRlcldpZHRoKGZhbHNlKTsKICAgICAgICAgICAgICAgIGVub3VnaFJvb21PblJpZ2h0ID0gZHJvcExlZnQgKyBkcm9wV2lkdGggPD0gdmlld1BvcnRSaWdodDsKICAgICAgICAgICAgICAgICRkcm9wZG93bi5zaG93KCk7CgogICAgICAgICAgICAgICAgLy8gZml4IHNvIHRoZSBjdXJzb3IgZG9lcyBub3QgbW92ZSB0byB0aGUgbGVmdCB3aXRoaW4gdGhlIHNlYXJjaC10ZXh0Ym94IGluIElFCiAgICAgICAgICAgICAgICB0aGlzLmZvY3VzU2VhcmNoKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLm9wdHMuZHJvcGRvd25BdXRvV2lkdGgpIHsKICAgICAgICAgICAgICAgIHJlc3VsdHNMaXN0Tm9kZSA9ICQoJy5zZWxlY3QyLXJlc3VsdHMnLCAkZHJvcGRvd24pWzBdOwogICAgICAgICAgICAgICAgJGRyb3Bkb3duLmFkZENsYXNzKCdzZWxlY3QyLWRyb3AtYXV0by13aWR0aCcpOwogICAgICAgICAgICAgICAgJGRyb3Bkb3duLmNzcygnd2lkdGgnLCAnJyk7CiAgICAgICAgICAgICAgICAvLyBBZGQgc2Nyb2xsYmFyIHdpZHRoIHRvIGRyb3Bkb3duIGlmIHZlcnRpY2FsIHNjcm9sbGJhciBpcyBwcmVzZW50CiAgICAgICAgICAgICAgICBkcm9wV2lkdGggPSAkZHJvcGRvd24ub3V0ZXJXaWR0aChmYWxzZSkgKyAocmVzdWx0c0xpc3ROb2RlLnNjcm9sbEhlaWdodCA9PT0gcmVzdWx0c0xpc3ROb2RlLmNsaWVudEhlaWdodCA/IDAgOiBzY3JvbGxCYXJEaW1lbnNpb25zLndpZHRoKTsKICAgICAgICAgICAgICAgIGRyb3BXaWR0aCA+IHdpZHRoID8gd2lkdGggPSBkcm9wV2lkdGggOiBkcm9wV2lkdGggPSB3aWR0aDsKICAgICAgICAgICAgICAgIGRyb3BIZWlnaHQgPSAkZHJvcGRvd24ub3V0ZXJIZWlnaHQoZmFsc2UpOwogICAgICAgICAgICAgICAgZW5vdWdoUm9vbU9uUmlnaHQgPSBkcm9wTGVmdCArIGRyb3BXaWR0aCA8PSB2aWV3UG9ydFJpZ2h0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIucmVtb3ZlQ2xhc3MoJ3NlbGVjdDItZHJvcC1hdXRvLXdpZHRoJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vY29uc29sZS5sb2coImJlbG93LyBkcm9wdG9wOiIsIGRyb3BUb3AsICJkcm9wSGVpZ2h0IiwgZHJvcEhlaWdodCwgInN1bSIsIChkcm9wVG9wK2Ryb3BIZWlnaHQpKyIgdmlld3BvcnQgYm90dG9tIiwgdmlld3BvcnRCb3R0b20sICJlbm91Z2g/IiwgZW5vdWdoUm9vbUJlbG93KTsKICAgICAgICAgICAgLy9jb25zb2xlLmxvZygiYWJvdmUvIG9mZnNldC50b3AiLCBvZmZzZXQudG9wLCAiZHJvcEhlaWdodCIsIGRyb3BIZWlnaHQsICJ0b3AiLCAob2Zmc2V0LnRvcC1kcm9wSGVpZ2h0KSwgInNjcm9sbFRvcCIsIHRoaXMuYm9keS5zY3JvbGxUb3AoKSwgImVub3VnaD8iLCBlbm91Z2hSb29tQWJvdmUpOwoKICAgICAgICAgICAgLy8gZml4IHBvc2l0aW9uaW5nIHdoZW4gYm9keSBoYXMgYW4gb2Zmc2V0IGFuZCBpcyBub3QgcG9zaXRpb246IHN0YXRpYwogICAgICAgICAgICBpZiAodGhpcy5ib2R5LmNzcygncG9zaXRpb24nKSAhPT0gJ3N0YXRpYycpIHsKICAgICAgICAgICAgICAgIGJvZHlPZmZzZXQgPSB0aGlzLmJvZHkub2Zmc2V0KCk7CiAgICAgICAgICAgICAgICBkcm9wVG9wIC09IGJvZHlPZmZzZXQudG9wOwogICAgICAgICAgICAgICAgZHJvcExlZnQgLT0gYm9keU9mZnNldC5sZWZ0OwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIWVub3VnaFJvb21PblJpZ2h0KSB7CiAgICAgICAgICAgICAgICBkcm9wTGVmdCA9IG9mZnNldC5sZWZ0ICsgdGhpcy5jb250YWluZXIub3V0ZXJXaWR0aChmYWxzZSkgLSBkcm9wV2lkdGg7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNzcyA9ICB7CiAgICAgICAgICAgICAgICBsZWZ0OiBkcm9wTGVmdCwKICAgICAgICAgICAgICAgIHdpZHRoOiB3aWR0aAogICAgICAgICAgICB9OwoKICAgICAgICAgICAgaWYgKGFib3ZlKSB7CiAgICAgICAgICAgICAgICBjc3MudG9wID0gb2Zmc2V0LnRvcCAtIGRyb3BIZWlnaHQ7CiAgICAgICAgICAgICAgICBjc3MuYm90dG9tID0gJ2F1dG8nOwogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkQ2xhc3MoInNlbGVjdDItZHJvcC1hYm92ZSIpOwogICAgICAgICAgICAgICAgJGRyb3Bkb3duLmFkZENsYXNzKCJzZWxlY3QyLWRyb3AtYWJvdmUiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIGNzcy50b3AgPSBkcm9wVG9wOwogICAgICAgICAgICAgICAgY3NzLmJvdHRvbSA9ICdhdXRvJzsKICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnJlbW92ZUNsYXNzKCJzZWxlY3QyLWRyb3AtYWJvdmUiKTsKICAgICAgICAgICAgICAgICRkcm9wZG93bi5yZW1vdmVDbGFzcygic2VsZWN0Mi1kcm9wLWFib3ZlIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY3NzID0gJC5leHRlbmQoY3NzLCBldmFsdWF0ZSh0aGlzLm9wdHMuZHJvcGRvd25Dc3MsIHRoaXMub3B0cy5lbGVtZW50KSk7CgogICAgICAgICAgICAkZHJvcGRvd24uY3NzKGNzcyk7CiAgICAgICAgfSwKCiAgICAgICAgLy8gYWJzdHJhY3QKICAgICAgICBzaG91bGRPcGVuOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGV2ZW50OwoKICAgICAgICAgICAgaWYgKHRoaXMub3BlbmVkKCkpIHJldHVybiBmYWxzZTsKCiAgICAgICAgICAgIGlmICh0aGlzLl9lbmFibGVkID09PSBmYWxzZSB8fCB0aGlzLl9yZWFkb25seSA9PT0gdHJ1ZSkgcmV0dXJuIGZhbHNlOwoKICAgICAgICAgICAgZXZlbnQgPSAkLkV2ZW50KCJzZWxlY3QyLW9wZW5pbmciKTsKICAgICAgICAgICAgdGhpcy5vcHRzLmVsZW1lbnQudHJpZ2dlcihldmVudCk7CiAgICAgICAgICAgIHJldHVybiAhZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCk7CiAgICAgICAgfSwKCiAgICAgICAgLy8gYWJzdHJhY3QKICAgICAgICBjbGVhckRyb3Bkb3duQWxpZ25tZW50UHJlZmVyZW5jZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIC8vIGNsZWFyIHRoZSBjbGFzc2VzIHVzZWQgdG8gZmlndXJlIG91dCB0aGUgcHJlZmVyZW5jZSBvZiB3aGVyZSB0aGUgZHJvcGRvd24gc2hvdWxkIGJlIG9wZW5lZAogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5yZW1vdmVDbGFzcygic2VsZWN0Mi1kcm9wLWFib3ZlIik7CiAgICAgICAgICAgIHRoaXMuZHJvcGRvd24ucmVtb3ZlQ2xhc3MoInNlbGVjdDItZHJvcC1hYm92ZSIpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIE9wZW5zIHRoZSBkcm9wZG93bgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybiB7Qm9vbGVhbn0gd2hldGhlciBvciBub3QgZHJvcGRvd24gd2FzIG9wZW5lZC4gVGhpcyBtZXRob2Qgd2lsbCByZXR1cm4gZmFsc2UgaWYsIGZvciBleGFtcGxlLAogICAgICAgICAqIHRoZSBkcm9wZG93biBpcyBhbHJlYWR5IG9wZW4sIG9yIGlmIHRoZSAnb3BlbicgZXZlbnQgbGlzdGVuZXIgb24gdGhlIGVsZW1lbnQgY2FsbGVkIHByZXZlbnREZWZhdWx0KCkuCiAgICAgICAgICovCiAgICAgICAgLy8gYWJzdHJhY3QKICAgICAgICBvcGVuOiBmdW5jdGlvbiAoKSB7CgogICAgICAgICAgICBpZiAoIXRoaXMuc2hvdWxkT3BlbigpKSByZXR1cm4gZmFsc2U7CgogICAgICAgICAgICB0aGlzLm9wZW5pbmcoKTsKCiAgICAgICAgICAgIC8vIE9ubHkgYmluZCB0aGUgZG9jdW1lbnQgbW91c2Vtb3ZlIHdoZW4gdGhlIGRyb3Bkb3duIGlzIHZpc2libGUKICAgICAgICAgICAgJGRvY3VtZW50Lm9uKCJtb3VzZW1vdmUuc2VsZWN0MkV2ZW50IiwgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICAgIGxhc3RNb3VzZVBvc2l0aW9uLnggPSBlLnBhZ2VYOwogICAgICAgICAgICAgICAgbGFzdE1vdXNlUG9zaXRpb24ueSA9IGUucGFnZVk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUGVyZm9ybXMgdGhlIG9wZW5pbmcgb2YgdGhlIGRyb3Bkb3duCiAgICAgICAgICovCiAgICAgICAgLy8gYWJzdHJhY3QKICAgICAgICBvcGVuaW5nOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGNpZCA9IHRoaXMuY29udGFpbmVyRXZlbnROYW1lLAogICAgICAgICAgICAgICAgc2Nyb2xsID0gInNjcm9sbC4iICsgY2lkLAogICAgICAgICAgICAgICAgcmVzaXplID0gInJlc2l6ZS4iK2NpZCwKICAgICAgICAgICAgICAgIG9yaWVudCA9ICJvcmllbnRhdGlvbmNoYW5nZS4iK2NpZCwKICAgICAgICAgICAgICAgIG1hc2s7CgogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGRDbGFzcygic2VsZWN0Mi1kcm9wZG93bi1vcGVuIikuYWRkQ2xhc3MoInNlbGVjdDItY29udGFpbmVyLWFjdGl2ZSIpOwoKICAgICAgICAgICAgdGhpcy5jbGVhckRyb3Bkb3duQWxpZ25tZW50UHJlZmVyZW5jZSgpOwoKICAgICAgICAgICAgaWYodGhpcy5kcm9wZG93blswXSAhPT0gdGhpcy5ib2R5LmNoaWxkcmVuKCkubGFzdCgpWzBdKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRyb3Bkb3duLmRldGFjaCgpLmFwcGVuZFRvKHRoaXMuYm9keSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGNyZWF0ZSB0aGUgZHJvcGRvd24gbWFzayBpZiBkb2Vzbid0IGFscmVhZHkgZXhpc3QKICAgICAgICAgICAgbWFzayA9ICQoIiNzZWxlY3QyLWRyb3AtbWFzayIpOwogICAgICAgICAgICBpZiAobWFzay5sZW5ndGggPT0gMCkgewogICAgICAgICAgICAgICAgbWFzayA9ICQoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikpOwogICAgICAgICAgICAgICAgbWFzay5hdHRyKCJpZCIsInNlbGVjdDItZHJvcC1tYXNrIikuYXR0cigiY2xhc3MiLCJzZWxlY3QyLWRyb3AtbWFzayIpOwogICAgICAgICAgICAgICAgbWFzay5oaWRlKCk7CiAgICAgICAgICAgICAgICBtYXNrLmFwcGVuZFRvKHRoaXMuYm9keSk7CiAgICAgICAgICAgICAgICBtYXNrLm9uKCJtb3VzZWRvd24gdG91Y2hzdGFydCBjbGljayIsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gUHJldmVudCBJRSBmcm9tIGdlbmVyYXRpbmcgYSBjbGljayBldmVudCBvbiB0aGUgYm9keQogICAgICAgICAgICAgICAgICAgIHJlaW5zZXJ0RWxlbWVudChtYXNrKTsKCiAgICAgICAgICAgICAgICAgICAgdmFyIGRyb3Bkb3duID0gJCgiI3NlbGVjdDItZHJvcCIpLCBzZWxmOwogICAgICAgICAgICAgICAgICAgIGlmIChkcm9wZG93bi5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGY9ZHJvcGRvd24uZGF0YSgic2VsZWN0MiIpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZi5vcHRzLnNlbGVjdE9uQmx1cikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zZWxlY3RIaWdobGlnaHRlZCh7bm9Gb2N1czogdHJ1ZX0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuY2xvc2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBlbnN1cmUgdGhlIG1hc2sgaXMgYWx3YXlzIHJpZ2h0IGJlZm9yZSB0aGUgZHJvcGRvd24KICAgICAgICAgICAgaWYgKHRoaXMuZHJvcGRvd24ucHJldigpWzBdICE9PSBtYXNrWzBdKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRyb3Bkb3duLmJlZm9yZShtYXNrKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gbW92ZSB0aGUgZ2xvYmFsIGlkIHRvIHRoZSBjb3JyZWN0IGRyb3Bkb3duCiAgICAgICAgICAgICQoIiNzZWxlY3QyLWRyb3AiKS5yZW1vdmVBdHRyKCJpZCIpOwogICAgICAgICAgICB0aGlzLmRyb3Bkb3duLmF0dHIoImlkIiwgInNlbGVjdDItZHJvcCIpOwoKICAgICAgICAgICAgLy8gc2hvdyB0aGUgZWxlbWVudHMKICAgICAgICAgICAgbWFzay5zaG93KCk7CgogICAgICAgICAgICB0aGlzLnBvc2l0aW9uRHJvcGRvd24oKTsKICAgICAgICAgICAgdGhpcy5kcm9wZG93bi5zaG93KCk7CiAgICAgICAgICAgIHRoaXMucG9zaXRpb25Ecm9wZG93bigpOwoKICAgICAgICAgICAgdGhpcy5kcm9wZG93bi5hZGRDbGFzcygic2VsZWN0Mi1kcm9wLWFjdGl2ZSIpOwoKICAgICAgICAgICAgLy8gYXR0YWNoIGxpc3RlbmVycyB0byBldmVudHMgdGhhdCBjYW4gY2hhbmdlIHRoZSBwb3NpdGlvbiBvZiB0aGUgY29udGFpbmVyIGFuZCB0aHVzIHJlcXVpcmUKICAgICAgICAgICAgLy8gdGhlIHBvc2l0aW9uIG9mIHRoZSBkcm9wZG93biB0byBiZSB1cGRhdGVkIGFzIHdlbGwgc28gaXQgZG9lcyBub3QgY29tZSB1bmdsdWVkIGZyb20gdGhlIGNvbnRhaW5lcgogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnBhcmVudHMoKS5hZGQod2luZG93KS5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICQodGhpcykub24ocmVzaXplKyIgIitzY3JvbGwrIiAiK29yaWVudCwgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhhdC5vcGVuZWQoKSkgdGhhdC5wb3NpdGlvbkRyb3Bkb3duKCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSk7CgoKICAgICAgICB9LAoKICAgICAgICAvLyBhYnN0cmFjdAogICAgICAgIGNsb3NlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5vcGVuZWQoKSkgcmV0dXJuOwoKICAgICAgICAgICAgdmFyIGNpZCA9IHRoaXMuY29udGFpbmVyRXZlbnROYW1lLAogICAgICAgICAgICAgICAgc2Nyb2xsID0gInNjcm9sbC4iICsgY2lkLAogICAgICAgICAgICAgICAgcmVzaXplID0gInJlc2l6ZS4iK2NpZCwKICAgICAgICAgICAgICAgIG9yaWVudCA9ICJvcmllbnRhdGlvbmNoYW5nZS4iK2NpZDsKCiAgICAgICAgICAgIC8vIHVuYmluZCBldmVudCBsaXN0ZW5lcnMKICAgICAgICAgICAgdGhpcy5jb250YWluZXIucGFyZW50cygpLmFkZCh3aW5kb3cpLmVhY2goZnVuY3Rpb24gKCkgeyAkKHRoaXMpLm9mZihzY3JvbGwpLm9mZihyZXNpemUpLm9mZihvcmllbnQpOyB9KTsKCiAgICAgICAgICAgIHRoaXMuY2xlYXJEcm9wZG93bkFsaWdubWVudFByZWZlcmVuY2UoKTsKCiAgICAgICAgICAgICQoIiNzZWxlY3QyLWRyb3AtbWFzayIpLmhpZGUoKTsKICAgICAgICAgICAgdGhpcy5kcm9wZG93bi5yZW1vdmVBdHRyKCJpZCIpOyAvLyBvbmx5IHRoZSBhY3RpdmUgZHJvcGRvd24gaGFzIHRoZSBzZWxlY3QyLWRyb3AgaWQKICAgICAgICAgICAgdGhpcy5kcm9wZG93bi5oaWRlKCk7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnJlbW92ZUNsYXNzKCJzZWxlY3QyLWRyb3Bkb3duLW9wZW4iKS5yZW1vdmVDbGFzcygic2VsZWN0Mi1jb250YWluZXItYWN0aXZlIik7CiAgICAgICAgICAgIHRoaXMucmVzdWx0cy5lbXB0eSgpOwoKICAgICAgICAgICAgLy8gTm93IHRoYXQgdGhlIGRyb3Bkb3duIGlzIGNsb3NlZCwgdW5iaW5kIHRoZSBnbG9iYWwgZG9jdW1lbnQgbW91c2Vtb3ZlIGV2ZW50CiAgICAgICAgICAgICRkb2N1bWVudC5vZmYoIm1vdXNlbW92ZS5zZWxlY3QyRXZlbnQiKTsKCiAgICAgICAgICAgIHRoaXMuY2xlYXJTZWFyY2goKTsKICAgICAgICAgICAgdGhpcy5zZWFyY2gucmVtb3ZlQ2xhc3MoInNlbGVjdDItYWN0aXZlIik7CiAgICAgICAgICAgIHRoaXMub3B0cy5lbGVtZW50LnRyaWdnZXIoJC5FdmVudCgic2VsZWN0Mi1jbG9zZSIpKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBPcGVucyBjb250cm9sLCBzZXRzIGlucHV0IHZhbHVlLCBhbmQgdXBkYXRlcyByZXN1bHRzLgogICAgICAgICAqLwogICAgICAgIC8vIGFic3RyYWN0CiAgICAgICAgZXh0ZXJuYWxTZWFyY2g6IGZ1bmN0aW9uICh0ZXJtKSB7CiAgICAgICAgICAgIHRoaXMub3BlbigpOwogICAgICAgICAgICB0aGlzLnNlYXJjaC52YWwodGVybSk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlUmVzdWx0cyhmYWxzZSk7CiAgICAgICAgfSwKCiAgICAgICAgLy8gYWJzdHJhY3QKICAgICAgICBjbGVhclNlYXJjaDogZnVuY3Rpb24gKCkgewoKICAgICAgICB9LAoKICAgICAgICAvL2Fic3RyYWN0CiAgICAgICAgZ2V0TWF4aW11bVNlbGVjdGlvblNpemU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gZXZhbHVhdGUodGhpcy5vcHRzLm1heGltdW1TZWxlY3Rpb25TaXplLCB0aGlzLm9wdHMuZWxlbWVudCk7CiAgICAgICAgfSwKCiAgICAgICAgLy8gYWJzdHJhY3QKICAgICAgICBlbnN1cmVIaWdobGlnaHRWaXNpYmxlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciByZXN1bHRzID0gdGhpcy5yZXN1bHRzLCBjaGlsZHJlbiwgaW5kZXgsIGNoaWxkLCBoYiwgcmIsIHksIG1vcmUsIHRvcE9mZnNldDsKCiAgICAgICAgICAgIGluZGV4ID0gdGhpcy5oaWdobGlnaHQoKTsKCiAgICAgICAgICAgIGlmIChpbmRleCA8IDApIHJldHVybjsKCiAgICAgICAgICAgIGlmIChpbmRleCA9PSAwKSB7CgogICAgICAgICAgICAgICAgLy8gaWYgdGhlIGZpcnN0IGVsZW1lbnQgaXMgaGlnaGxpZ2h0ZWQgc2Nyb2xsIGFsbCB0aGUgd2F5IHRvIHRoZSB0b3AsCiAgICAgICAgICAgICAgICAvLyB0aGF0IHdheSBhbnkgdW5zZWxlY3RhYmxlIGhlYWRlcnMgYWJvdmUgaXQgd2lsbCBhbHNvIGJlIHNjcm9sbGVkCiAgICAgICAgICAgICAgICAvLyBpbnRvIHZpZXcKCiAgICAgICAgICAgICAgICByZXN1bHRzLnNjcm9sbFRvcCgwKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY2hpbGRyZW4gPSB0aGlzLmZpbmRIaWdobGlnaHRhYmxlQ2hvaWNlcygpLmZpbmQoJy5zZWxlY3QyLXJlc3VsdC1sYWJlbCcpOwoKICAgICAgICAgICAgY2hpbGQgPSAkKGNoaWxkcmVuW2luZGV4XSk7CgogICAgICAgICAgICB0b3BPZmZzZXQgPSAoY2hpbGQub2Zmc2V0KCkgfHwge30pLnRvcCB8fCAwOwoKICAgICAgICAgICAgaGIgPSB0b3BPZmZzZXQgKyBjaGlsZC5vdXRlckhlaWdodCh0cnVlKTsKCiAgICAgICAgICAgIC8vIGlmIHRoaXMgaXMgdGhlIGxhc3QgY2hpbGQgbGV0cyBhbHNvIG1ha2Ugc3VyZSBzZWxlY3QyLW1vcmUtcmVzdWx0cyBpcyB2aXNpYmxlCiAgICAgICAgICAgIGlmIChpbmRleCA9PT0gY2hpbGRyZW4ubGVuZ3RoIC0gMSkgewogICAgICAgICAgICAgICAgbW9yZSA9IHJlc3VsdHMuZmluZCgibGkuc2VsZWN0Mi1tb3JlLXJlc3VsdHMiKTsKICAgICAgICAgICAgICAgIGlmIChtb3JlLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICBoYiA9IG1vcmUub2Zmc2V0KCkudG9wICsgbW9yZS5vdXRlckhlaWdodCh0cnVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmIgPSByZXN1bHRzLm9mZnNldCgpLnRvcCArIHJlc3VsdHMub3V0ZXJIZWlnaHQodHJ1ZSk7CiAgICAgICAgICAgIGlmIChoYiA+IHJiKSB7CiAgICAgICAgICAgICAgICByZXN1bHRzLnNjcm9sbFRvcChyZXN1bHRzLnNjcm9sbFRvcCgpICsgKGhiIC0gcmIpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB5ID0gdG9wT2Zmc2V0IC0gcmVzdWx0cy5vZmZzZXQoKS50b3A7CgogICAgICAgICAgICAvLyBtYWtlIHN1cmUgdGhlIHRvcCBvZiB0aGUgZWxlbWVudCBpcyB2aXNpYmxlCiAgICAgICAgICAgIGlmICh5IDwgMCAmJiBjaGlsZC5jc3MoJ2Rpc3BsYXknKSAhPSAnbm9uZScgKSB7CiAgICAgICAgICAgICAgICByZXN1bHRzLnNjcm9sbFRvcChyZXN1bHRzLnNjcm9sbFRvcCgpICsgeSk7IC8vIHkgaXMgbmVnYXRpdmUKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8vIGFic3RyYWN0CiAgICAgICAgZmluZEhpZ2hsaWdodGFibGVDaG9pY2VzOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMucmVzdWx0cy5maW5kKCIuc2VsZWN0Mi1yZXN1bHQtc2VsZWN0YWJsZTpub3QoLnNlbGVjdDItZGlzYWJsZWQpOm5vdCguc2VsZWN0Mi1zZWxlY3RlZCkiKTsKICAgICAgICB9LAoKICAgICAgICAvLyBhYnN0cmFjdAogICAgICAgIG1vdmVIaWdobGlnaHQ6IGZ1bmN0aW9uIChkZWx0YSkgewogICAgICAgICAgICB2YXIgY2hvaWNlcyA9IHRoaXMuZmluZEhpZ2hsaWdodGFibGVDaG9pY2VzKCksCiAgICAgICAgICAgICAgICBpbmRleCA9IHRoaXMuaGlnaGxpZ2h0KCk7CgogICAgICAgICAgICB3aGlsZSAoaW5kZXggPiAtMSAmJiBpbmRleCA8IGNob2ljZXMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBpbmRleCArPSBkZWx0YTsKICAgICAgICAgICAgICAgIHZhciBjaG9pY2UgPSAkKGNob2ljZXNbaW5kZXhdKTsKICAgICAgICAgICAgICAgIGlmIChjaG9pY2UuaGFzQ2xhc3MoInNlbGVjdDItcmVzdWx0LXNlbGVjdGFibGUiKSAmJiAhY2hvaWNlLmhhc0NsYXNzKCJzZWxlY3QyLWRpc2FibGVkIikgJiYgIWNob2ljZS5oYXNDbGFzcygic2VsZWN0Mi1zZWxlY3RlZCIpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5oaWdobGlnaHQoaW5kZXgpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLy8gYWJzdHJhY3QKICAgICAgICBoaWdobGlnaHQ6IGZ1bmN0aW9uIChpbmRleCkgewogICAgICAgICAgICB2YXIgY2hvaWNlcyA9IHRoaXMuZmluZEhpZ2hsaWdodGFibGVDaG9pY2VzKCksCiAgICAgICAgICAgICAgICBjaG9pY2UsCiAgICAgICAgICAgICAgICBkYXRhOwoKICAgICAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgIHJldHVybiBpbmRleE9mKGNob2ljZXMuZmlsdGVyKCIuc2VsZWN0Mi1oaWdobGlnaHRlZCIpWzBdLCBjaG9pY2VzLmdldCgpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGluZGV4ID49IGNob2ljZXMubGVuZ3RoKSBpbmRleCA9IGNob2ljZXMubGVuZ3RoIC0gMTsKICAgICAgICAgICAgaWYgKGluZGV4IDwgMCkgaW5kZXggPSAwOwoKICAgICAgICAgICAgdGhpcy5yZW1vdmVIaWdobGlnaHQoKTsKCiAgICAgICAgICAgIGNob2ljZSA9ICQoY2hvaWNlc1tpbmRleF0pOwogICAgICAgICAgICBjaG9pY2UuYWRkQ2xhc3MoInNlbGVjdDItaGlnaGxpZ2h0ZWQiKTsKCiAgICAgICAgICAgIC8vIGVuc3VyZSBhc3Npc3RpdmUgdGVjaG5vbG9neSBjYW4gZGV0ZXJtaW5lIHRoZSBhY3RpdmUgY2hvaWNlCiAgICAgICAgICAgIHRoaXMuc2VhcmNoLmF0dHIoImFyaWEtYWN0aXZlZGVzY2VuZGFudCIsIGNob2ljZS5maW5kKCIuc2VsZWN0Mi1yZXN1bHQtbGFiZWwiKS5hdHRyKCJpZCIpKTsKCiAgICAgICAgICAgIHRoaXMuZW5zdXJlSGlnaGxpZ2h0VmlzaWJsZSgpOwoKICAgICAgICAgICAgdGhpcy5saXZlUmVnaW9uLnRleHQoY2hvaWNlLnRleHQoKSk7CgogICAgICAgICAgICBkYXRhID0gY2hvaWNlLmRhdGEoInNlbGVjdDItZGF0YSIpOwogICAgICAgICAgICBpZiAoZGF0YSkgewogICAgICAgICAgICAgICAgdGhpcy5vcHRzLmVsZW1lbnQudHJpZ2dlcih7IHR5cGU6ICJzZWxlY3QyLWhpZ2hsaWdodCIsIHZhbDogdGhpcy5pZChkYXRhKSwgY2hvaWNlOiBkYXRhIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgcmVtb3ZlSGlnaGxpZ2h0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5yZXN1bHRzLmZpbmQoIi5zZWxlY3QyLWhpZ2hsaWdodGVkIikucmVtb3ZlQ2xhc3MoInNlbGVjdDItaGlnaGxpZ2h0ZWQiKTsKICAgICAgICB9LAoKICAgICAgICB0b3VjaE1vdmVkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5fdG91Y2hNb3ZlZCA9IHRydWU7CiAgICAgICAgfSwKCiAgICAgICAgY2xlYXJUb3VjaE1vdmVkOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHRoaXMuX3RvdWNoTW92ZWQgPSBmYWxzZTsKICAgICAgICB9LAoKICAgICAgICAvLyBhYnN0cmFjdAogICAgICAgIGNvdW50U2VsZWN0YWJsZVJlc3VsdHM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5maW5kSGlnaGxpZ2h0YWJsZUNob2ljZXMoKS5sZW5ndGg7CiAgICAgICAgfSwKCiAgICAgICAgLy8gYWJzdHJhY3QKICAgICAgICBoaWdobGlnaHRVbmRlckV2ZW50OiBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgdmFyIGVsID0gJChldmVudC50YXJnZXQpLmNsb3Nlc3QoIi5zZWxlY3QyLXJlc3VsdC1zZWxlY3RhYmxlIik7CiAgICAgICAgICAgIGlmIChlbC5sZW5ndGggPiAwICYmICFlbC5pcygiLnNlbGVjdDItaGlnaGxpZ2h0ZWQiKSkgewogICAgICAgICAgICAgICAgdmFyIGNob2ljZXMgPSB0aGlzLmZpbmRIaWdobGlnaHRhYmxlQ2hvaWNlcygpOwogICAgICAgICAgICAgICAgdGhpcy5oaWdobGlnaHQoY2hvaWNlcy5pbmRleChlbCkpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGVsLmxlbmd0aCA9PSAwKSB7CiAgICAgICAgICAgICAgICAvLyBpZiB3ZSBhcmUgb3ZlciBhbiB1bnNlbGVjdGFibGUgaXRlbSByZW1vdmUgYWxsIGhpZ2hsaWdodHMKICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlSGlnaGxpZ2h0KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvLyBhYnN0cmFjdAogICAgICAgIGxvYWRNb3JlSWZOZWVkZWQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIHJlc3VsdHMgPSB0aGlzLnJlc3VsdHMsCiAgICAgICAgICAgICAgICBtb3JlID0gcmVzdWx0cy5maW5kKCJsaS5zZWxlY3QyLW1vcmUtcmVzdWx0cyIpLAogICAgICAgICAgICAgICAgYmVsb3csIC8vIHBpeGVscyB0aGUgZWxlbWVudCBpcyBiZWxvdyB0aGUgc2Nyb2xsIGZvbGQsIGJlbG93PT0wIGlzIHdoZW4gdGhlIGVsZW1lbnQgaXMgc3RhcnRpbmcgdG8gYmUgdmlzaWJsZQogICAgICAgICAgICAgICAgcGFnZSA9IHRoaXMucmVzdWx0c1BhZ2UgKyAxLAogICAgICAgICAgICAgICAgc2VsZj10aGlzLAogICAgICAgICAgICAgICAgdGVybT10aGlzLnNlYXJjaC52YWwoKSwKICAgICAgICAgICAgICAgIGNvbnRleHQ9dGhpcy5jb250ZXh0OwoKICAgICAgICAgICAgaWYgKG1vcmUubGVuZ3RoID09PSAwKSByZXR1cm47CiAgICAgICAgICAgIGJlbG93ID0gbW9yZS5vZmZzZXQoKS50b3AgLSByZXN1bHRzLm9mZnNldCgpLnRvcCAtIHJlc3VsdHMuaGVpZ2h0KCk7CgogICAgICAgICAgICBpZiAoYmVsb3cgPD0gdGhpcy5vcHRzLmxvYWRNb3JlUGFkZGluZykgewogICAgICAgICAgICAgICAgbW9yZS5hZGRDbGFzcygic2VsZWN0Mi1hY3RpdmUiKTsKICAgICAgICAgICAgICAgIHRoaXMub3B0cy5xdWVyeSh7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQ6IHRoaXMub3B0cy5lbGVtZW50LAogICAgICAgICAgICAgICAgICAgICAgICB0ZXJtOiB0ZXJtLAogICAgICAgICAgICAgICAgICAgICAgICBwYWdlOiBwYWdlLAogICAgICAgICAgICAgICAgICAgICAgICBjb250ZXh0OiBjb250ZXh0LAogICAgICAgICAgICAgICAgICAgICAgICBtYXRjaGVyOiB0aGlzLm9wdHMubWF0Y2hlciwKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2s6IHRoaXMuYmluZChmdW5jdGlvbiAoZGF0YSkgewoKICAgICAgICAgICAgICAgICAgICAvLyBpZ25vcmUgYSByZXNwb25zZSBpZiB0aGUgc2VsZWN0MiBoYXMgYmVlbiBjbG9zZWQgYmVmb3JlIGl0IHdhcyByZWNlaXZlZAogICAgICAgICAgICAgICAgICAgIGlmICghc2VsZi5vcGVuZWQoKSkgcmV0dXJuOwoKCiAgICAgICAgICAgICAgICAgICAgc2VsZi5vcHRzLnBvcHVsYXRlUmVzdWx0cy5jYWxsKHRoaXMsIHJlc3VsdHMsIGRhdGEucmVzdWx0cywge3Rlcm06IHRlcm0sIHBhZ2U6IHBhZ2UsIGNvbnRleHQ6Y29udGV4dH0pOwogICAgICAgICAgICAgICAgICAgIHNlbGYucG9zdHByb2Nlc3NSZXN1bHRzKGRhdGEsIGZhbHNlLCBmYWxzZSk7CgogICAgICAgICAgICAgICAgICAgIGlmIChkYXRhLm1vcmU9PT10cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1vcmUuZGV0YWNoKCkuYXBwZW5kVG8ocmVzdWx0cykudGV4dChldmFsdWF0ZShzZWxmLm9wdHMuZm9ybWF0TG9hZE1vcmUsIHNlbGYub3B0cy5lbGVtZW50LCBwYWdlKzEpKTsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7IHNlbGYubG9hZE1vcmVJZk5lZWRlZCgpOyB9LCAxMCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgbW9yZS5yZW1vdmUoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgc2VsZi5wb3NpdGlvbkRyb3Bkb3duKCk7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5yZXN1bHRzUGFnZSA9IHBhZ2U7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5jb250ZXh0ID0gZGF0YS5jb250ZXh0OwogICAgICAgICAgICAgICAgICAgIHRoaXMub3B0cy5lbGVtZW50LnRyaWdnZXIoeyB0eXBlOiAic2VsZWN0Mi1sb2FkZWQiLCBpdGVtczogZGF0YSB9KTsKICAgICAgICAgICAgICAgIH0pfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBEZWZhdWx0IHRva2VuaXplciBmdW5jdGlvbiB3aGljaCBkb2VzIG5vdGhpbmcKICAgICAgICAgKi8KICAgICAgICB0b2tlbml6ZTogZnVuY3Rpb24oKSB7CgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBwYXJhbSBpbml0aWFsIHdoZXRoZXIgb3Igbm90IHRoaXMgaXMgdGhlIGNhbGwgdG8gdGhpcyBtZXRob2QgcmlnaHQgYWZ0ZXIgdGhlIGRyb3Bkb3duIGhhcyBiZWVuIG9wZW5lZAogICAgICAgICAqLwogICAgICAgIC8vIGFic3RyYWN0CiAgICAgICAgdXBkYXRlUmVzdWx0czogZnVuY3Rpb24gKGluaXRpYWwpIHsKICAgICAgICAgICAgdmFyIHNlYXJjaCA9IHRoaXMuc2VhcmNoLAogICAgICAgICAgICAgICAgcmVzdWx0cyA9IHRoaXMucmVzdWx0cywKICAgICAgICAgICAgICAgIG9wdHMgPSB0aGlzLm9wdHMsCiAgICAgICAgICAgICAgICBkYXRhLAogICAgICAgICAgICAgICAgc2VsZiA9IHRoaXMsCiAgICAgICAgICAgICAgICBpbnB1dCwKICAgICAgICAgICAgICAgIHRlcm0gPSBzZWFyY2gudmFsKCksCiAgICAgICAgICAgICAgICBsYXN0VGVybSA9ICQuZGF0YSh0aGlzLmNvbnRhaW5lciwgInNlbGVjdDItbGFzdC10ZXJtIiksCiAgICAgICAgICAgICAgICAvLyBzZXF1ZW5jZSBudW1iZXIgdXNlZCB0byBkcm9wIG91dC1vZi1vcmRlciByZXNwb25zZXMKICAgICAgICAgICAgICAgIHF1ZXJ5TnVtYmVyOwoKICAgICAgICAgICAgLy8gcHJldmVudCBkdXBsaWNhdGUgcXVlcmllcyBhZ2FpbnN0IHRoZSBzYW1lIHRlcm0KICAgICAgICAgICAgaWYgKGluaXRpYWwgIT09IHRydWUgJiYgbGFzdFRlcm0gJiYgZXF1YWwodGVybSwgbGFzdFRlcm0pKSByZXR1cm47CgogICAgICAgICAgICAkLmRhdGEodGhpcy5jb250YWluZXIsICJzZWxlY3QyLWxhc3QtdGVybSIsIHRlcm0pOwoKICAgICAgICAgICAgLy8gaWYgdGhlIHNlYXJjaCBpcyBjdXJyZW50bHkgaGlkZGVuIHdlIGRvIG5vdCBhbHRlciB0aGUgcmVzdWx0cwogICAgICAgICAgICBpZiAoaW5pdGlhbCAhPT0gdHJ1ZSAmJiAodGhpcy5zaG93U2VhcmNoSW5wdXQgPT09IGZhbHNlIHx8ICF0aGlzLm9wZW5lZCgpKSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiBwb3N0UmVuZGVyKCkgewogICAgICAgICAgICAgICAgc2VhcmNoLnJlbW92ZUNsYXNzKCJzZWxlY3QyLWFjdGl2ZSIpOwogICAgICAgICAgICAgICAgc2VsZi5wb3NpdGlvbkRyb3Bkb3duKCk7CiAgICAgICAgICAgICAgICBpZiAocmVzdWx0cy5maW5kKCcuc2VsZWN0Mi1uby1yZXN1bHRzLC5zZWxlY3QyLXNlbGVjdGlvbi1saW1pdCwuc2VsZWN0Mi1zZWFyY2hpbmcnKS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBzZWxmLmxpdmVSZWdpb24udGV4dChyZXN1bHRzLnRleHQoKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBzZWxmLmxpdmVSZWdpb24udGV4dChzZWxmLm9wdHMuZm9ybWF0TWF0Y2hlcyhyZXN1bHRzLmZpbmQoJy5zZWxlY3QyLXJlc3VsdC1zZWxlY3RhYmxlJykubGVuZ3RoKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIHJlbmRlcihodG1sKSB7CiAgICAgICAgICAgICAgICByZXN1bHRzLmh0bWwoaHRtbCk7CiAgICAgICAgICAgICAgICBwb3N0UmVuZGVyKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHF1ZXJ5TnVtYmVyID0gKyt0aGlzLnF1ZXJ5Q291bnQ7CgogICAgICAgICAgICB2YXIgbWF4U2VsU2l6ZSA9IHRoaXMuZ2V0TWF4aW11bVNlbGVjdGlvblNpemUoKTsKICAgICAgICAgICAgaWYgKG1heFNlbFNpemUgPj0xKSB7CiAgICAgICAgICAgICAgICBkYXRhID0gdGhpcy5kYXRhKCk7CiAgICAgICAgICAgICAgICBpZiAoJC5pc0FycmF5KGRhdGEpICYmIGRhdGEubGVuZ3RoID49IG1heFNlbFNpemUgJiYgY2hlY2tGb3JtYXR0ZXIob3B0cy5mb3JtYXRTZWxlY3Rpb25Ub29CaWcsICJmb3JtYXRTZWxlY3Rpb25Ub29CaWciKSkgewogICAgICAgICAgICAgICAgICAgIHJlbmRlcigiPGxpIGNsYXNzPSdzZWxlY3QyLXNlbGVjdGlvbi1saW1pdCc+IiArIGV2YWx1YXRlKG9wdHMuZm9ybWF0U2VsZWN0aW9uVG9vQmlnLCBvcHRzLmVsZW1lbnQsIG1heFNlbFNpemUpICsgIjwvbGk+Iik7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoc2VhcmNoLnZhbCgpLmxlbmd0aCA8IG9wdHMubWluaW11bUlucHV0TGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBpZiAoY2hlY2tGb3JtYXR0ZXIob3B0cy5mb3JtYXRJbnB1dFRvb1Nob3J0LCAiZm9ybWF0SW5wdXRUb29TaG9ydCIpKSB7CiAgICAgICAgICAgICAgICAgICAgcmVuZGVyKCI8bGkgY2xhc3M9J3NlbGVjdDItbm8tcmVzdWx0cyc+IiArIGV2YWx1YXRlKG9wdHMuZm9ybWF0SW5wdXRUb29TaG9ydCwgb3B0cy5lbGVtZW50LCBzZWFyY2gudmFsKCksIG9wdHMubWluaW11bUlucHV0TGVuZ3RoKSArICI8L2xpPiIpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZW5kZXIoIiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGluaXRpYWwgJiYgdGhpcy5zaG93U2VhcmNoKSB0aGlzLnNob3dTZWFyY2godHJ1ZSk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChvcHRzLm1heGltdW1JbnB1dExlbmd0aCAmJiBzZWFyY2gudmFsKCkubGVuZ3RoID4gb3B0cy5tYXhpbXVtSW5wdXRMZW5ndGgpIHsKICAgICAgICAgICAgICAgIGlmIChjaGVja0Zvcm1hdHRlcihvcHRzLmZvcm1hdElucHV0VG9vTG9uZywgImZvcm1hdElucHV0VG9vTG9uZyIpKSB7CiAgICAgICAgICAgICAgICAgICAgcmVuZGVyKCI8bGkgY2xhc3M9J3NlbGVjdDItbm8tcmVzdWx0cyc+IiArIGV2YWx1YXRlKG9wdHMuZm9ybWF0SW5wdXRUb29Mb25nLCBvcHRzLmVsZW1lbnQsIHNlYXJjaC52YWwoKSwgb3B0cy5tYXhpbXVtSW5wdXRMZW5ndGgpICsgIjwvbGk+Iik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJlbmRlcigiIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChvcHRzLmZvcm1hdFNlYXJjaGluZyAmJiB0aGlzLmZpbmRIaWdobGlnaHRhYmxlQ2hvaWNlcygpLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgcmVuZGVyKCI8bGkgY2xhc3M9J3NlbGVjdDItc2VhcmNoaW5nJz4iICsgZXZhbHVhdGUob3B0cy5mb3JtYXRTZWFyY2hpbmcsIG9wdHMuZWxlbWVudCkgKyAiPC9saT4iKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgc2VhcmNoLmFkZENsYXNzKCJzZWxlY3QyLWFjdGl2ZSIpOwoKICAgICAgICAgICAgdGhpcy5yZW1vdmVIaWdobGlnaHQoKTsKCiAgICAgICAgICAgIC8vIGdpdmUgdGhlIHRva2VuaXplciBhIGNoYW5jZSB0byBwcmUtcHJvY2VzcyB0aGUgaW5wdXQKICAgICAgICAgICAgaW5wdXQgPSB0aGlzLnRva2VuaXplKCk7CiAgICAgICAgICAgIGlmIChpbnB1dCAhPSB1bmRlZmluZWQgJiYgaW5wdXQgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgc2VhcmNoLnZhbChpbnB1dCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMucmVzdWx0c1BhZ2UgPSAxOwoKICAgICAgICAgICAgb3B0cy5xdWVyeSh7CiAgICAgICAgICAgICAgICBlbGVtZW50OiBvcHRzLmVsZW1lbnQsCiAgICAgICAgICAgICAgICAgICAgdGVybTogc2VhcmNoLnZhbCgpLAogICAgICAgICAgICAgICAgICAgIHBhZ2U6IHRoaXMucmVzdWx0c1BhZ2UsCiAgICAgICAgICAgICAgICAgICAgY29udGV4dDogbnVsbCwKICAgICAgICAgICAgICAgICAgICBtYXRjaGVyOiBvcHRzLm1hdGNoZXIsCiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2s6IHRoaXMuYmluZChmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICAgICAgdmFyIGRlZjsgLy8gZGVmYXVsdCBjaG9pY2UKCiAgICAgICAgICAgICAgICAvLyBpZ25vcmUgb2xkIHJlc3BvbnNlcwogICAgICAgICAgICAgICAgaWYgKHF1ZXJ5TnVtYmVyICE9IHRoaXMucXVlcnlDb3VudCkgewogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gaWdub3JlIGEgcmVzcG9uc2UgaWYgdGhlIHNlbGVjdDIgaGFzIGJlZW4gY2xvc2VkIGJlZm9yZSBpdCB3YXMgcmVjZWl2ZWQKICAgICAgICAgICAgICAgIGlmICghdGhpcy5vcGVuZWQoKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc2VhcmNoLnJlbW92ZUNsYXNzKCJzZWxlY3QyLWFjdGl2ZSIpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBzYXZlIGNvbnRleHQsIGlmIGFueQogICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0ID0gKGRhdGEuY29udGV4dD09PXVuZGVmaW5lZCkgPyBudWxsIDogZGF0YS5jb250ZXh0OwogICAgICAgICAgICAgICAgLy8gY3JlYXRlIGEgZGVmYXVsdCBjaG9pY2UgYW5kIHByZXBlbmQgaXQgdG8gdGhlIGxpc3QKICAgICAgICAgICAgICAgIGlmICh0aGlzLm9wdHMuY3JlYXRlU2VhcmNoQ2hvaWNlICYmIHNlYXJjaC52YWwoKSAhPT0gIiIpIHsKICAgICAgICAgICAgICAgICAgICBkZWYgPSB0aGlzLm9wdHMuY3JlYXRlU2VhcmNoQ2hvaWNlLmNhbGwoc2VsZiwgc2VhcmNoLnZhbCgpLCBkYXRhLnJlc3VsdHMpOwogICAgICAgICAgICAgICAgICAgIGlmIChkZWYgIT09IHVuZGVmaW5lZCAmJiBkZWYgIT09IG51bGwgJiYgc2VsZi5pZChkZWYpICE9PSB1bmRlZmluZWQgJiYgc2VsZi5pZChkZWYpICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkKGRhdGEucmVzdWx0cykuZmlsdGVyKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBlcXVhbChzZWxmLmlkKHRoaXMpLCBzZWxmLmlkKGRlZikpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9wdHMuY3JlYXRlU2VhcmNoQ2hvaWNlUG9zaXRpb24oZGF0YS5yZXN1bHRzLCBkZWYpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChkYXRhLnJlc3VsdHMubGVuZ3RoID09PSAwICYmIGNoZWNrRm9ybWF0dGVyKG9wdHMuZm9ybWF0Tm9NYXRjaGVzLCAiZm9ybWF0Tm9NYXRjaGVzIikpIHsKICAgICAgICAgICAgICAgICAgICByZW5kZXIoIjxsaSBjbGFzcz0nc2VsZWN0Mi1uby1yZXN1bHRzJz4iICsgZXZhbHVhdGUob3B0cy5mb3JtYXROb01hdGNoZXMsIG9wdHMuZWxlbWVudCwgc2VhcmNoLnZhbCgpKSArICI8L2xpPiIpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXN1bHRzLmVtcHR5KCk7CiAgICAgICAgICAgICAgICBzZWxmLm9wdHMucG9wdWxhdGVSZXN1bHRzLmNhbGwodGhpcywgcmVzdWx0cywgZGF0YS5yZXN1bHRzLCB7dGVybTogc2VhcmNoLnZhbCgpLCBwYWdlOiB0aGlzLnJlc3VsdHNQYWdlLCBjb250ZXh0Om51bGx9KTsKCiAgICAgICAgICAgICAgICBpZiAoZGF0YS5tb3JlID09PSB0cnVlICYmIGNoZWNrRm9ybWF0dGVyKG9wdHMuZm9ybWF0TG9hZE1vcmUsICJmb3JtYXRMb2FkTW9yZSIpKSB7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0cy5hcHBlbmQoIjxsaSBjbGFzcz0nc2VsZWN0Mi1tb3JlLXJlc3VsdHMnPiIgKyBvcHRzLmVzY2FwZU1hcmt1cChldmFsdWF0ZShvcHRzLmZvcm1hdExvYWRNb3JlLCBvcHRzLmVsZW1lbnQsIHRoaXMucmVzdWx0c1BhZ2UpKSArICI8L2xpPiIpOwogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgeyBzZWxmLmxvYWRNb3JlSWZOZWVkZWQoKTsgfSwgMTApOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXMucG9zdHByb2Nlc3NSZXN1bHRzKGRhdGEsIGluaXRpYWwpOwoKICAgICAgICAgICAgICAgIHBvc3RSZW5kZXIoKTsKCiAgICAgICAgICAgICAgICB0aGlzLm9wdHMuZWxlbWVudC50cmlnZ2VyKHsgdHlwZTogInNlbGVjdDItbG9hZGVkIiwgaXRlbXM6IGRhdGEgfSk7CiAgICAgICAgICAgIH0pfSk7CiAgICAgICAgfSwKCiAgICAgICAgLy8gYWJzdHJhY3QKICAgICAgICBjYW5jZWw6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdGhpcy5jbG9zZSgpOwogICAgICAgIH0sCgogICAgICAgIC8vIGFic3RyYWN0CiAgICAgICAgYmx1cjogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAvLyBpZiBzZWxlY3RPbkJsdXIgPT0gdHJ1ZSwgc2VsZWN0IHRoZSBjdXJyZW50bHkgaGlnaGxpZ2h0ZWQgb3B0aW9uCiAgICAgICAgICAgIGlmICh0aGlzLm9wdHMuc2VsZWN0T25CbHVyKQogICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RIaWdobGlnaHRlZCh7bm9Gb2N1czogdHJ1ZX0pOwoKICAgICAgICAgICAgdGhpcy5jbG9zZSgpOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5yZW1vdmVDbGFzcygic2VsZWN0Mi1jb250YWluZXItYWN0aXZlIik7CiAgICAgICAgICAgIC8vIHN5bm9ueW1vdXMgdG8gLmlzKCc6Zm9jdXMnKSwgd2hpY2ggaXMgYXZhaWxhYmxlIGluIGpxdWVyeSA+PSAxLjYKICAgICAgICAgICAgaWYgKHRoaXMuc2VhcmNoWzBdID09PSBkb2N1bWVudC5hY3RpdmVFbGVtZW50KSB7IHRoaXMuc2VhcmNoLmJsdXIoKTsgfQogICAgICAgICAgICB0aGlzLmNsZWFyU2VhcmNoKCk7CiAgICAgICAgICAgIHRoaXMuc2VsZWN0aW9uLmZpbmQoIi5zZWxlY3QyLXNlYXJjaC1jaG9pY2UtZm9jdXMiKS5yZW1vdmVDbGFzcygic2VsZWN0Mi1zZWFyY2gtY2hvaWNlLWZvY3VzIik7CiAgICAgICAgfSwKCiAgICAgICAgLy8gYWJzdHJhY3QKICAgICAgICBmb2N1c1NlYXJjaDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICBmb2N1cyh0aGlzLnNlYXJjaCk7CiAgICAgICAgfSwKCiAgICAgICAgLy8gYWJzdHJhY3QKICAgICAgICBzZWxlY3RIaWdobGlnaHRlZDogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgICAgICAgaWYgKHRoaXMuX3RvdWNoTW92ZWQpIHsKICAgICAgICAgICAgICB0aGlzLmNsZWFyVG91Y2hNb3ZlZCgpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaW5kZXg9dGhpcy5oaWdobGlnaHQoKSwKICAgICAgICAgICAgICAgIGhpZ2hsaWdodGVkPXRoaXMucmVzdWx0cy5maW5kKCIuc2VsZWN0Mi1oaWdobGlnaHRlZCIpLAogICAgICAgICAgICAgICAgZGF0YSA9IGhpZ2hsaWdodGVkLmNsb3Nlc3QoJy5zZWxlY3QyLXJlc3VsdCcpLmRhdGEoInNlbGVjdDItZGF0YSIpOwoKICAgICAgICAgICAgaWYgKGRhdGEpIHsKICAgICAgICAgICAgICAgIHRoaXMuaGlnaGxpZ2h0KGluZGV4KTsKICAgICAgICAgICAgICAgIHRoaXMub25TZWxlY3QoZGF0YSwgb3B0aW9ucyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAob3B0aW9ucyAmJiBvcHRpb25zLm5vRm9jdXMpIHsKICAgICAgICAgICAgICAgIHRoaXMuY2xvc2UoKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8vIGFic3RyYWN0CiAgICAgICAgZ2V0UGxhY2Vob2xkZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIHBsYWNlaG9sZGVyT3B0aW9uOwogICAgICAgICAgICByZXR1cm4gdGhpcy5vcHRzLmVsZW1lbnQuYXR0cigicGxhY2Vob2xkZXIiKSB8fAogICAgICAgICAgICAgICAgdGhpcy5vcHRzLmVsZW1lbnQuYXR0cigiZGF0YS1wbGFjZWhvbGRlciIpIHx8IC8vIGpxdWVyeSAxLjQgY29tcGF0CiAgICAgICAgICAgICAgICB0aGlzLm9wdHMuZWxlbWVudC5kYXRhKCJwbGFjZWhvbGRlciIpIHx8CiAgICAgICAgICAgICAgICB0aGlzLm9wdHMucGxhY2Vob2xkZXIgfHwKICAgICAgICAgICAgICAgICgocGxhY2Vob2xkZXJPcHRpb24gPSB0aGlzLmdldFBsYWNlaG9sZGVyT3B0aW9uKCkpICE9PSB1bmRlZmluZWQgPyBwbGFjZWhvbGRlck9wdGlvbi50ZXh0KCkgOiB1bmRlZmluZWQpOwogICAgICAgIH0sCgogICAgICAgIC8vIGFic3RyYWN0CiAgICAgICAgZ2V0UGxhY2Vob2xkZXJPcHRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAodGhpcy5zZWxlY3QpIHsKICAgICAgICAgICAgICAgIHZhciBmaXJzdE9wdGlvbiA9IHRoaXMuc2VsZWN0LmNoaWxkcmVuKCdvcHRpb24nKS5maXJzdCgpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMub3B0cy5wbGFjZWhvbGRlck9wdGlvbiAhPT0gdW5kZWZpbmVkICkgewogICAgICAgICAgICAgICAgICAgIC8vRGV0ZXJtaW5lIHRoZSBwbGFjZWhvbGRlciBvcHRpb24gYmFzZWQgb24gdGhlIHNwZWNpZmllZCBwbGFjZWhvbGRlck9wdGlvbiBzZXR0aW5nCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICh0aGlzLm9wdHMucGxhY2Vob2xkZXJPcHRpb24gPT09ICJmaXJzdCIgJiYgZmlyc3RPcHRpb24pIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICh0eXBlb2YgdGhpcy5vcHRzLnBsYWNlaG9sZGVyT3B0aW9uID09PSAiZnVuY3Rpb24iICYmIHRoaXMub3B0cy5wbGFjZWhvbGRlck9wdGlvbih0aGlzLnNlbGVjdCkpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICgkLnRyaW0oZmlyc3RPcHRpb24udGV4dCgpKSA9PT0gIiIgJiYgZmlyc3RPcHRpb24udmFsKCkgPT09ICIiKSB7CiAgICAgICAgICAgICAgICAgICAgLy9ObyBleHBsaWNpdCBwbGFjZWhvbGRlciBvcHRpb24gc3BlY2lmaWVkLCB1c2UgdGhlIGZpcnN0IGlmIGl0J3MgYmxhbmsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmlyc3RPcHRpb247CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBHZXQgdGhlIGRlc2lyZWQgd2lkdGggZm9yIHRoZSBjb250YWluZXIgZWxlbWVudC4gIFRoaXMgaXMKICAgICAgICAgKiBkZXJpdmVkIGZpcnN0IGZyb20gb3B0aW9uIGB3aWR0aGAgcGFzc2VkIHRvIHNlbGVjdDIsIHRoZW4KICAgICAgICAgKiB0aGUgaW5saW5lICdzdHlsZScgb24gdGhlIG9yaWdpbmFsIGVsZW1lbnQsIGFuZCBmaW5hbGx5CiAgICAgICAgICogZmFsbHMgYmFjayB0byB0aGUgalF1ZXJ5IGNhbGN1bGF0ZWQgZWxlbWVudCB3aWR0aC4KICAgICAgICAgKi8KICAgICAgICAvLyBhYnN0cmFjdAogICAgICAgIGluaXRDb250YWluZXJXaWR0aDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICBmdW5jdGlvbiByZXNvbHZlQ29udGFpbmVyV2lkdGgoKSB7CiAgICAgICAgICAgICAgICB2YXIgc3R5bGUsIGF0dHJzLCBtYXRjaGVzLCBpLCBsLCBhdHRyOwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLm9wdHMud2lkdGggPT09ICJvZmYiKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMub3B0cy53aWR0aCA9PT0gImVsZW1lbnQiKXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5vcHRzLmVsZW1lbnQub3V0ZXJXaWR0aChmYWxzZSkgPT09IDAgPyAnYXV0bycgOiB0aGlzLm9wdHMuZWxlbWVudC5vdXRlcldpZHRoKGZhbHNlKSArICdweCc7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMub3B0cy53aWR0aCA9PT0gImNvcHkiIHx8IHRoaXMub3B0cy53aWR0aCA9PT0gInJlc29sdmUiKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gY2hlY2sgaWYgdGhlcmUgaXMgaW5saW5lIHN0eWxlIG9uIHRoZSBlbGVtZW50IHRoYXQgY29udGFpbnMgd2lkdGgKICAgICAgICAgICAgICAgICAgICBzdHlsZSA9IHRoaXMub3B0cy5lbGVtZW50LmF0dHIoJ3N0eWxlJyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHN0eWxlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXR0cnMgPSBzdHlsZS5zcGxpdCgnOycpOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBsID0gYXR0cnMubGVuZ3RoOyBpIDwgbDsgaSA9IGkgKyAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRyID0gYXR0cnNbaV0ucmVwbGFjZSgvXHMvZywgJycpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2hlcyA9IGF0dHIubWF0Y2goL153aWR0aDooKFstK10/KFswLTldKlwuKT9bMC05XSspKHB4fGVtfGV4fCV8aW58Y218bW18cHR8cGMpKS9pKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYXRjaGVzICE9PSBudWxsICYmIG1hdGNoZXMubGVuZ3RoID49IDEpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1hdGNoZXNbMV07CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLm9wdHMud2lkdGggPT09ICJyZXNvbHZlIikgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBuZXh0IGNoZWNrIGlmIGNzcygnd2lkdGgnKSBjYW4gcmVzb2x2ZSBhIHdpZHRoIHRoYXQgaXMgcGVyY2VudCBiYXNlZCwgdGhpcyBpcyBzb21ldGltZXMgcG9zc2libGUKICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2hlbiBhdHRhY2hlZCB0byBpbnB1dCB0eXBlPWhpZGRlbiBvciBlbGVtZW50cyBoaWRkZW4gdmlhIGNzcwogICAgICAgICAgICAgICAgICAgICAgICBzdHlsZSA9IHRoaXMub3B0cy5lbGVtZW50LmNzcygnd2lkdGgnKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0eWxlLmluZGV4T2YoIiUiKSA+IDApIHJldHVybiBzdHlsZTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGZpbmFsbHksIGZhbGxiYWNrIG9uIHRoZSBjYWxjdWxhdGVkIHdpZHRoIG9mIHRoZSBlbGVtZW50CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAodGhpcy5vcHRzLmVsZW1lbnQub3V0ZXJXaWR0aChmYWxzZSkgPT09IDAgPyAnYXV0bycgOiB0aGlzLm9wdHMuZWxlbWVudC5vdXRlcldpZHRoKGZhbHNlKSArICdweCcpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCQuaXNGdW5jdGlvbih0aGlzLm9wdHMud2lkdGgpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMub3B0cy53aWR0aCgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5vcHRzLndpZHRoOwogICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB2YXIgd2lkdGggPSByZXNvbHZlQ29udGFpbmVyV2lkdGguY2FsbCh0aGlzKTsKICAgICAgICAgICAgaWYgKHdpZHRoICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5jc3MoIndpZHRoIiwgd2lkdGgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSk7CgogICAgU2luZ2xlU2VsZWN0MiA9IGNsYXp6KEFic3RyYWN0U2VsZWN0MiwgewoKICAgICAgICAvLyBzaW5nbGUKCiAgICAgICAgY3JlYXRlQ29udGFpbmVyOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBjb250YWluZXIgPSAkKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpKS5hdHRyKHsKICAgICAgICAgICAgICAgICJjbGFzcyI6ICJzZWxlY3QyLWNvbnRhaW5lciIKICAgICAgICAgICAgfSkuaHRtbChbCiAgICAgICAgICAgICAgICAiPGEgaHJlZj0namF2YXNjcmlwdDp2b2lkKDApJyBjbGFzcz0nc2VsZWN0Mi1jaG9pY2UnIHRhYmluZGV4PSctMSc+IiwKICAgICAgICAgICAgICAgICIgICA8c3BhbiBjbGFzcz0nc2VsZWN0Mi1jaG9zZW4nPiYjMTYwOzwvc3Bhbj48YWJiciBjbGFzcz0nc2VsZWN0Mi1zZWFyY2gtY2hvaWNlLWNsb3NlJz48L2FiYnI+IiwKICAgICAgICAgICAgICAgICIgICA8c3BhbiBjbGFzcz0nc2VsZWN0Mi1hcnJvdycgcm9sZT0ncHJlc2VudGF0aW9uJz48YiByb2xlPSdwcmVzZW50YXRpb24nPjwvYj48L3NwYW4+IiwKICAgICAgICAgICAgICAgICI8L2E+IiwKICAgICAgICAgICAgICAgICI8bGFiZWwgZm9yPScnIGNsYXNzPSdzZWxlY3QyLW9mZnNjcmVlbic+PC9sYWJlbD4iLAogICAgICAgICAgICAgICAgIjxpbnB1dCBjbGFzcz0nc2VsZWN0Mi1mb2N1c3NlciBzZWxlY3QyLW9mZnNjcmVlbicgdHlwZT0ndGV4dCcgYXJpYS1oYXNwb3B1cD0ndHJ1ZScgcm9sZT0nYnV0dG9uJyAvPiIsCiAgICAgICAgICAgICAgICAiPGRpdiBjbGFzcz0nc2VsZWN0Mi1kcm9wIHNlbGVjdDItZGlzcGxheS1ub25lJz4iLAogICAgICAgICAgICAgICAgIiAgIDxkaXYgY2xhc3M9J3NlbGVjdDItc2VhcmNoJz4iLAogICAgICAgICAgICAgICAgIiAgICAgICA8bGFiZWwgZm9yPScnIGNsYXNzPSdzZWxlY3QyLW9mZnNjcmVlbic+PC9sYWJlbD4iLAogICAgICAgICAgICAgICAgIiAgICAgICA8aW5wdXQgdHlwZT0ndGV4dCcgYXV0b2NvbXBsZXRlPSdvZmYnIGF1dG9jb3JyZWN0PSdvZmYnIGF1dG9jYXBpdGFsaXplPSdvZmYnIHNwZWxsY2hlY2s9J2ZhbHNlJyBjbGFzcz0nc2VsZWN0Mi1pbnB1dCcgcm9sZT0nY29tYm9ib3gnIGFyaWEtZXhwYW5kZWQ9J3RydWUnIiwKICAgICAgICAgICAgICAgICIgICAgICAgYXJpYS1hdXRvY29tcGxldGU9J2xpc3QnIC8+IiwKICAgICAgICAgICAgICAgICIgICA8L2Rpdj4iLAogICAgICAgICAgICAgICAgIiAgIDx1bCBjbGFzcz0nc2VsZWN0Mi1yZXN1bHRzJyByb2xlPSdsaXN0Ym94Jz4iLAogICAgICAgICAgICAgICAgIiAgIDwvdWw+IiwKICAgICAgICAgICAgICAgICI8L2Rpdj4iXS5qb2luKCIiKSk7CiAgICAgICAgICAgIHJldHVybiBjb250YWluZXI7CiAgICAgICAgfSwKCiAgICAgICAgLy8gc2luZ2xlCiAgICAgICAgZW5hYmxlSW50ZXJmYWNlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKHRoaXMucGFyZW50LmVuYWJsZUludGVyZmFjZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpKSB7CiAgICAgICAgICAgICAgICB0aGlzLmZvY3Vzc2VyLnByb3AoImRpc2FibGVkIiwgIXRoaXMuaXNJbnRlcmZhY2VFbmFibGVkKCkpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLy8gc2luZ2xlCiAgICAgICAgb3BlbmluZzogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgZWwsIHJhbmdlLCBsZW47CgogICAgICAgICAgICBpZiAodGhpcy5vcHRzLm1pbmltdW1SZXN1bHRzRm9yU2VhcmNoID49IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuc2hvd1NlYXJjaCh0cnVlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5wYXJlbnQub3BlbmluZy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICAgICAgICAgICAgaWYgKHRoaXMuc2hvd1NlYXJjaElucHV0ICE9PSBmYWxzZSkgewogICAgICAgICAgICAgICAgLy8gSUUgYXBwZW5kcyBmb2N1c3Nlci52YWwoKSBhdCB0aGUgZW5kIG9mIGZpZWxkIDovIHNvIHdlIG1hbnVhbGx5IGluc2VydCBpdCBhdCB0aGUgYmVnaW5uaW5nIHVzaW5nIGEgcmFuZ2UKICAgICAgICAgICAgICAgIC8vIGFsbCBvdGhlciBicm93c2VycyBoYW5kbGUgdGhpcyBqdXN0IGZpbmUKCiAgICAgICAgICAgICAgICB0aGlzLnNlYXJjaC52YWwodGhpcy5mb2N1c3Nlci52YWwoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMub3B0cy5zaG91bGRGb2N1c0lucHV0KHRoaXMpKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNlYXJjaC5mb2N1cygpOwogICAgICAgICAgICAgICAgLy8gbW92ZSB0aGUgY3Vyc29yIHRvIHRoZSBlbmQgYWZ0ZXIgZm9jdXNzaW5nLCBvdGhlcndpc2UgaXQgd2lsbCBiZSBhdCB0aGUgYmVnaW5uaW5nIGFuZAogICAgICAgICAgICAgICAgLy8gbmV3IHRleHQgd2lsbCBhcHBlYXIgKmJlZm9yZSogZm9jdXNzZXIudmFsKCkKICAgICAgICAgICAgICAgIGVsID0gdGhpcy5zZWFyY2guZ2V0KDApOwogICAgICAgICAgICAgICAgaWYgKGVsLmNyZWF0ZVRleHRSYW5nZSkgewogICAgICAgICAgICAgICAgICAgIHJhbmdlID0gZWwuY3JlYXRlVGV4dFJhbmdlKCk7CiAgICAgICAgICAgICAgICAgICAgcmFuZ2UuY29sbGFwc2UoZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIHJhbmdlLnNlbGVjdCgpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChlbC5zZXRTZWxlY3Rpb25SYW5nZSkgewogICAgICAgICAgICAgICAgICAgIGxlbiA9IHRoaXMuc2VhcmNoLnZhbCgpLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICBlbC5zZXRTZWxlY3Rpb25SYW5nZShsZW4sIGxlbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGluaXRpYWxpemVzIHNlYXJjaCdzIHZhbHVlIHdpdGggbmV4dFNlYXJjaFRlcm0gKGlmIGRlZmluZWQgYnkgdXNlcikKICAgICAgICAgICAgLy8gaWdub3JlIG5leHRTZWFyY2hUZXJtIGlmIHRoZSBkcm9wZG93biBpcyBvcGVuZWQgYnkgdGhlIHVzZXIgcHJlc3NpbmcgYSBsZXR0ZXIKICAgICAgICAgICAgaWYodGhpcy5zZWFyY2gudmFsKCkgPT09ICIiKSB7CiAgICAgICAgICAgICAgICBpZih0aGlzLm5leHRTZWFyY2hUZXJtICE9IHVuZGVmaW5lZCl7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWFyY2gudmFsKHRoaXMubmV4dFNlYXJjaFRlcm0pOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc2VhcmNoLnNlbGVjdCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmZvY3Vzc2VyLnByb3AoImRpc2FibGVkIiwgdHJ1ZSkudmFsKCIiKTsKICAgICAgICAgICAgdGhpcy51cGRhdGVSZXN1bHRzKHRydWUpOwogICAgICAgICAgICB0aGlzLm9wdHMuZWxlbWVudC50cmlnZ2VyKCQuRXZlbnQoInNlbGVjdDItb3BlbiIpKTsKICAgICAgICB9LAoKICAgICAgICAvLyBzaW5nbGUKICAgICAgICBjbG9zZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICBpZiAoIXRoaXMub3BlbmVkKCkpIHJldHVybjsKICAgICAgICAgICAgdGhpcy5wYXJlbnQuY2xvc2UuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgICAgICAgICAgIHRoaXMuZm9jdXNzZXIucHJvcCgiZGlzYWJsZWQiLCBmYWxzZSk7CgogICAgICAgICAgICBpZiAodGhpcy5vcHRzLnNob3VsZEZvY3VzSW5wdXQodGhpcykpIHsKICAgICAgICAgICAgICAgIHRoaXMuZm9jdXNzZXIuZm9jdXMoKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8vIHNpbmdsZQogICAgICAgIGZvY3VzOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLm9wZW5lZCgpKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNsb3NlKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmZvY3Vzc2VyLnByb3AoImRpc2FibGVkIiwgZmFsc2UpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMub3B0cy5zaG91bGRGb2N1c0lucHV0KHRoaXMpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5mb2N1c3Nlci5mb2N1cygpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLy8gc2luZ2xlCiAgICAgICAgaXNGb2N1c2VkOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmNvbnRhaW5lci5oYXNDbGFzcygic2VsZWN0Mi1jb250YWluZXItYWN0aXZlIik7CiAgICAgICAgfSwKCiAgICAgICAgLy8gc2luZ2xlCiAgICAgICAgY2FuY2VsOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHRoaXMucGFyZW50LmNhbmNlbC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICB0aGlzLmZvY3Vzc2VyLnByb3AoImRpc2FibGVkIiwgZmFsc2UpOwoKICAgICAgICAgICAgaWYgKHRoaXMub3B0cy5zaG91bGRGb2N1c0lucHV0KHRoaXMpKSB7CiAgICAgICAgICAgICAgICB0aGlzLmZvY3Vzc2VyLmZvY3VzKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvLyBzaW5nbGUKICAgICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgJCgibGFiZWxbZm9yPSciICsgdGhpcy5mb2N1c3Nlci5hdHRyKCdpZCcpICsgIiddIikKICAgICAgICAgICAgICAgIC5hdHRyKCdmb3InLCB0aGlzLm9wdHMuZWxlbWVudC5hdHRyKCJpZCIpKTsKICAgICAgICAgICAgdGhpcy5wYXJlbnQuZGVzdHJveS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICAgICAgICAgICAgY2xlYW51cEpRdWVyeUVsZW1lbnRzLmNhbGwodGhpcywKICAgICAgICAgICAgICAgICJzZWxlY3Rpb24iLAogICAgICAgICAgICAgICAgImZvY3Vzc2VyIgogICAgICAgICAgICApOwogICAgICAgIH0sCgogICAgICAgIC8vIHNpbmdsZQogICAgICAgIGluaXRDb250YWluZXI6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgICAgIHZhciBzZWxlY3Rpb24sCiAgICAgICAgICAgICAgICBjb250YWluZXIgPSB0aGlzLmNvbnRhaW5lciwKICAgICAgICAgICAgICAgIGRyb3Bkb3duID0gdGhpcy5kcm9wZG93biwKICAgICAgICAgICAgICAgIGlkU3VmZml4ID0gbmV4dFVpZCgpLAogICAgICAgICAgICAgICAgZWxlbWVudExhYmVsOwoKICAgICAgICAgICAgaWYgKHRoaXMub3B0cy5taW5pbXVtUmVzdWx0c0ZvclNlYXJjaCA8IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuc2hvd1NlYXJjaChmYWxzZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNob3dTZWFyY2godHJ1ZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuc2VsZWN0aW9uID0gc2VsZWN0aW9uID0gY29udGFpbmVyLmZpbmQoIi5zZWxlY3QyLWNob2ljZSIpOwoKICAgICAgICAgICAgdGhpcy5mb2N1c3NlciA9IGNvbnRhaW5lci5maW5kKCIuc2VsZWN0Mi1mb2N1c3NlciIpOwoKICAgICAgICAgICAgLy8gYWRkIGFyaWEgYXNzb2NpYXRpb25zCiAgICAgICAgICAgIHNlbGVjdGlvbi5maW5kKCIuc2VsZWN0Mi1jaG9zZW4iKS5hdHRyKCJpZCIsICJzZWxlY3QyLWNob3Nlbi0iK2lkU3VmZml4KTsKICAgICAgICAgICAgdGhpcy5mb2N1c3Nlci5hdHRyKCJhcmlhLWxhYmVsbGVkYnkiLCAic2VsZWN0Mi1jaG9zZW4tIitpZFN1ZmZpeCk7CiAgICAgICAgICAgIHRoaXMucmVzdWx0cy5hdHRyKCJpZCIsICJzZWxlY3QyLXJlc3VsdHMtIitpZFN1ZmZpeCk7CiAgICAgICAgICAgIHRoaXMuc2VhcmNoLmF0dHIoImFyaWEtb3ducyIsICJzZWxlY3QyLXJlc3VsdHMtIitpZFN1ZmZpeCk7CgogICAgICAgICAgICAvLyByZXdyaXRlIGxhYmVscyBmcm9tIG9yaWdpbmFsIGVsZW1lbnQgdG8gZm9jdXNzZXIKICAgICAgICAgICAgdGhpcy5mb2N1c3Nlci5hdHRyKCJpZCIsICJzMmlkX2F1dG9nZW4iK2lkU3VmZml4KTsKCiAgICAgICAgICAgIGVsZW1lbnRMYWJlbCA9ICQoImxhYmVsW2Zvcj0nIiArIHRoaXMub3B0cy5lbGVtZW50LmF0dHIoImlkIikgKyAiJ10iKTsKCiAgICAgICAgICAgIHRoaXMuZm9jdXNzZXIucHJldigpCiAgICAgICAgICAgICAgICAudGV4dChlbGVtZW50TGFiZWwudGV4dCgpKQogICAgICAgICAgICAgICAgLmF0dHIoJ2ZvcicsIHRoaXMuZm9jdXNzZXIuYXR0cignaWQnKSk7CgogICAgICAgICAgICAvLyBFbnN1cmUgdGhlIG9yaWdpbmFsIGVsZW1lbnQgcmV0YWlucyBhbiBhY2Nlc3NpYmxlIG5hbWUKICAgICAgICAgICAgdmFyIG9yaWdpbmFsVGl0bGUgPSB0aGlzLm9wdHMuZWxlbWVudC5hdHRyKCJ0aXRsZSIpOwogICAgICAgICAgICB0aGlzLm9wdHMuZWxlbWVudC5hdHRyKCJ0aXRsZSIsIChvcmlnaW5hbFRpdGxlIHx8IGVsZW1lbnRMYWJlbC50ZXh0KCkpKTsKCiAgICAgICAgICAgIHRoaXMuZm9jdXNzZXIuYXR0cigidGFiaW5kZXgiLCB0aGlzLmVsZW1lbnRUYWJJbmRleCk7CgogICAgICAgICAgICAvLyB3cml0ZSBsYWJlbCBmb3Igc2VhcmNoIGZpZWxkIHVzaW5nIHRoZSBsYWJlbCBmcm9tIHRoZSBmb2N1c3NlciBlbGVtZW50CiAgICAgICAgICAgIHRoaXMuc2VhcmNoLmF0dHIoImlkIiwgdGhpcy5mb2N1c3Nlci5hdHRyKCdpZCcpICsgJ19zZWFyY2gnKTsKCiAgICAgICAgICAgIHRoaXMuc2VhcmNoLnByZXYoKQogICAgICAgICAgICAgICAgLnRleHQoJCgibGFiZWxbZm9yPSciICsgdGhpcy5mb2N1c3Nlci5hdHRyKCdpZCcpICsgIiddIikudGV4dCgpKQogICAgICAgICAgICAgICAgLmF0dHIoJ2ZvcicsIHRoaXMuc2VhcmNoLmF0dHIoJ2lkJykpOwoKICAgICAgICAgICAgdGhpcy5zZWFyY2gub24oImtleWRvd24iLCB0aGlzLmJpbmQoZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICAgIGlmICghdGhpcy5pc0ludGVyZmFjZUVuYWJsZWQoKSkgcmV0dXJuOwoKICAgICAgICAgICAgICAgIGlmIChlLndoaWNoID09PSBLRVkuUEFHRV9VUCB8fCBlLndoaWNoID09PSBLRVkuUEFHRV9ET1dOKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gcHJldmVudCB0aGUgcGFnZSBmcm9tIHNjcm9sbGluZwogICAgICAgICAgICAgICAgICAgIGtpbGxFdmVudChlKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgc3dpdGNoIChlLndoaWNoKSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSBLRVkuVVA6CiAgICAgICAgICAgICAgICAgICAgY2FzZSBLRVkuRE9XTjoKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tb3ZlSGlnaGxpZ2h0KChlLndoaWNoID09PSBLRVkuVVApID8gLTEgOiAxKTsKICAgICAgICAgICAgICAgICAgICAgICAga2lsbEV2ZW50KGUpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgY2FzZSBLRVkuRU5URVI6CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0SGlnaGxpZ2h0ZWQoKTsKICAgICAgICAgICAgICAgICAgICAgICAga2lsbEV2ZW50KGUpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgY2FzZSBLRVkuVEFCOgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdEhpZ2hsaWdodGVkKHtub0ZvY3VzOiB0cnVlfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICBjYXNlIEtFWS5FU0M6CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2FuY2VsKGUpOwogICAgICAgICAgICAgICAgICAgICAgICBraWxsRXZlbnQoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSkpOwoKICAgICAgICAgICAgdGhpcy5zZWFyY2gub24oImJsdXIiLCB0aGlzLmJpbmQoZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgLy8gYSB3b3JrYXJvdW5kIGZvciBjaHJvbWUgdG8ga2VlcCB0aGUgc2VhcmNoIGZpZWxkIGZvY3Vzc2VkIHdoZW4gdGhlIHNjcm9sbCBiYXIgaXMgdXNlZCB0byBzY3JvbGwgdGhlIGRyb3Bkb3duLgogICAgICAgICAgICAgICAgLy8gd2l0aG91dCB0aGlzIHRoZSBzZWFyY2ggZmllbGQgbG9zZXMgZm9jdXMgd2hpY2ggaXMgYW5ub3lpbmcKICAgICAgICAgICAgICAgIGlmIChkb2N1bWVudC5hY3RpdmVFbGVtZW50ID09PSB0aGlzLmJvZHkuZ2V0KDApKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LnNldFRpbWVvdXQodGhpcy5iaW5kKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5vcGVuZWQoKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWFyY2guZm9jdXMoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pLCAwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSkpOwoKICAgICAgICAgICAgdGhpcy5mb2N1c3Nlci5vbigia2V5ZG93biIsIHRoaXMuYmluZChmdW5jdGlvbiAoZSkgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLmlzSW50ZXJmYWNlRW5hYmxlZCgpKSByZXR1cm47CgogICAgICAgICAgICAgICAgaWYgKGUud2hpY2ggPT09IEtFWS5UQUIgfHwgS0VZLmlzQ29udHJvbChlKSB8fCBLRVkuaXNGdW5jdGlvbktleShlKSB8fCBlLndoaWNoID09PSBLRVkuRVNDKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICh0aGlzLm9wdHMub3Blbk9uRW50ZXIgPT09IGZhbHNlICYmIGUud2hpY2ggPT09IEtFWS5FTlRFUikgewogICAgICAgICAgICAgICAgICAgIGtpbGxFdmVudChlKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGUud2hpY2ggPT0gS0VZLkRPV04gfHwgZS53aGljaCA9PSBLRVkuVVAKICAgICAgICAgICAgICAgICAgICB8fCAoZS53aGljaCA9PSBLRVkuRU5URVIgJiYgdGhpcy5vcHRzLm9wZW5PbkVudGVyKSkgewoKICAgICAgICAgICAgICAgICAgICBpZiAoZS5hbHRLZXkgfHwgZS5jdHJsS2V5IHx8IGUuc2hpZnRLZXkgfHwgZS5tZXRhS2V5KSByZXR1cm47CgogICAgICAgICAgICAgICAgICAgIHRoaXMub3BlbigpOwogICAgICAgICAgICAgICAgICAgIGtpbGxFdmVudChlKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGUud2hpY2ggPT0gS0VZLkRFTEVURSB8fCBlLndoaWNoID09IEtFWS5CQUNLU1BBQ0UpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5vcHRzLmFsbG93Q2xlYXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jbGVhcigpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBraWxsRXZlbnQoZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KSk7CgoKICAgICAgICAgICAgaW5zdGFsbEtleVVwQ2hhbmdlRXZlbnQodGhpcy5mb2N1c3Nlcik7CiAgICAgICAgICAgIHRoaXMuZm9jdXNzZXIub24oImtleXVwLWNoYW5nZSBpbnB1dCIsIHRoaXMuYmluZChmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5vcHRzLm1pbmltdW1SZXN1bHRzRm9yU2VhcmNoID49IDApIHsKICAgICAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLm9wZW5lZCgpKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vcGVuKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pKTsKCiAgICAgICAgICAgIHNlbGVjdGlvbi5vbigibW91c2Vkb3duIHRvdWNoc3RhcnQiLCAiYWJiciIsIHRoaXMuYmluZChmdW5jdGlvbiAoZSkgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLmlzSW50ZXJmYWNlRW5hYmxlZCgpKSByZXR1cm47CiAgICAgICAgICAgICAgICB0aGlzLmNsZWFyKCk7CiAgICAgICAgICAgICAgICBraWxsRXZlbnRJbW1lZGlhdGVseShlKTsKICAgICAgICAgICAgICAgIHRoaXMuY2xvc2UoKTsKICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0aW9uLmZvY3VzKCk7CiAgICAgICAgICAgIH0pKTsKCiAgICAgICAgICAgIHNlbGVjdGlvbi5vbigibW91c2Vkb3duIHRvdWNoc3RhcnQiLCB0aGlzLmJpbmQoZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICAgIC8vIFByZXZlbnQgSUUgZnJvbSBnZW5lcmF0aW5nIGEgY2xpY2sgZXZlbnQgb24gdGhlIGJvZHkKICAgICAgICAgICAgICAgIHJlaW5zZXJ0RWxlbWVudChzZWxlY3Rpb24pOwoKICAgICAgICAgICAgICAgIGlmICghdGhpcy5jb250YWluZXIuaGFzQ2xhc3MoInNlbGVjdDItY29udGFpbmVyLWFjdGl2ZSIpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vcHRzLmVsZW1lbnQudHJpZ2dlcigkLkV2ZW50KCJzZWxlY3QyLWZvY3VzIikpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICh0aGlzLm9wZW5lZCgpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jbG9zZSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzSW50ZXJmYWNlRW5hYmxlZCgpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vcGVuKCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAga2lsbEV2ZW50KGUpOwogICAgICAgICAgICB9KSk7CgogICAgICAgICAgICBkcm9wZG93bi5vbigibW91c2Vkb3duIHRvdWNoc3RhcnQiLCB0aGlzLmJpbmQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5vcHRzLnNob3VsZEZvY3VzSW5wdXQodGhpcykpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNlYXJjaC5mb2N1cygpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KSk7CgogICAgICAgICAgICBzZWxlY3Rpb24ub24oImZvY3VzIiwgdGhpcy5iaW5kKGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgIGtpbGxFdmVudChlKTsKICAgICAgICAgICAgfSkpOwoKICAgICAgICAgICAgdGhpcy5mb2N1c3Nlci5vbigiZm9jdXMiLCB0aGlzLmJpbmQoZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgIGlmICghdGhpcy5jb250YWluZXIuaGFzQ2xhc3MoInNlbGVjdDItY29udGFpbmVyLWFjdGl2ZSIpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vcHRzLmVsZW1lbnQudHJpZ2dlcigkLkV2ZW50KCJzZWxlY3QyLWZvY3VzIikpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkQ2xhc3MoInNlbGVjdDItY29udGFpbmVyLWFjdGl2ZSIpOwogICAgICAgICAgICB9KSkub24oImJsdXIiLCB0aGlzLmJpbmQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMub3BlbmVkKCkpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5yZW1vdmVDbGFzcygic2VsZWN0Mi1jb250YWluZXItYWN0aXZlIik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vcHRzLmVsZW1lbnQudHJpZ2dlcigkLkV2ZW50KCJzZWxlY3QyLWJsdXIiKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pKTsKICAgICAgICAgICAgdGhpcy5zZWFyY2gub24oImZvY3VzIiwgdGhpcy5iaW5kKGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuY29udGFpbmVyLmhhc0NsYXNzKCJzZWxlY3QyLWNvbnRhaW5lci1hY3RpdmUiKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMub3B0cy5lbGVtZW50LnRyaWdnZXIoJC5FdmVudCgic2VsZWN0Mi1mb2N1cyIpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZENsYXNzKCJzZWxlY3QyLWNvbnRhaW5lci1hY3RpdmUiKTsKICAgICAgICAgICAgfSkpOwoKICAgICAgICAgICAgdGhpcy5pbml0Q29udGFpbmVyV2lkdGgoKTsKICAgICAgICAgICAgdGhpcy5vcHRzLmVsZW1lbnQuYWRkQ2xhc3MoInNlbGVjdDItb2Zmc2NyZWVuIik7CiAgICAgICAgICAgIHRoaXMuc2V0UGxhY2Vob2xkZXIoKTsKCiAgICAgICAgfSwKCiAgICAgICAgLy8gc2luZ2xlCiAgICAgICAgY2xlYXI6IGZ1bmN0aW9uKHRyaWdnZXJDaGFuZ2UpIHsKICAgICAgICAgICAgdmFyIGRhdGE9dGhpcy5zZWxlY3Rpb24uZGF0YSgic2VsZWN0Mi1kYXRhIik7CiAgICAgICAgICAgIGlmIChkYXRhKSB7IC8vIGd1YXJkIGFnYWluc3QgcXVldWVkIHF1aWNrIGNvbnNlY3V0aXZlIGNsaWNrcwogICAgICAgICAgICAgICAgdmFyIGV2dCA9ICQuRXZlbnQoInNlbGVjdDItY2xlYXJpbmciKTsKICAgICAgICAgICAgICAgIHRoaXMub3B0cy5lbGVtZW50LnRyaWdnZXIoZXZ0KTsKICAgICAgICAgICAgICAgIGlmIChldnQuaXNEZWZhdWx0UHJldmVudGVkKCkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgcGxhY2Vob2xkZXJPcHRpb24gPSB0aGlzLmdldFBsYWNlaG9sZGVyT3B0aW9uKCk7CiAgICAgICAgICAgICAgICB0aGlzLm9wdHMuZWxlbWVudC52YWwocGxhY2Vob2xkZXJPcHRpb24gPyBwbGFjZWhvbGRlck9wdGlvbi52YWwoKSA6ICIiKTsKICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0aW9uLmZpbmQoIi5zZWxlY3QyLWNob3NlbiIpLmVtcHR5KCk7CiAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGlvbi5yZW1vdmVEYXRhKCJzZWxlY3QyLWRhdGEiKTsKICAgICAgICAgICAgICAgIHRoaXMuc2V0UGxhY2Vob2xkZXIoKTsKCiAgICAgICAgICAgICAgICBpZiAodHJpZ2dlckNoYW5nZSAhPT0gZmFsc2UpewogICAgICAgICAgICAgICAgICAgIHRoaXMub3B0cy5lbGVtZW50LnRyaWdnZXIoeyB0eXBlOiAic2VsZWN0Mi1yZW1vdmVkIiwgdmFsOiB0aGlzLmlkKGRhdGEpLCBjaG9pY2U6IGRhdGEgfSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyQ2hhbmdlKHtyZW1vdmVkOmRhdGF9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFNldHMgc2VsZWN0aW9uIGJhc2VkIG9uIHNvdXJjZSBlbGVtZW50J3MgdmFsdWUKICAgICAgICAgKi8KICAgICAgICAvLyBzaW5nbGUKICAgICAgICBpbml0U2VsZWN0aW9uOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBzZWxlY3RlZDsKICAgICAgICAgICAgaWYgKHRoaXMuaXNQbGFjZWhvbGRlck9wdGlvblNlbGVjdGVkKCkpIHsKICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlU2VsZWN0aW9uKG51bGwpOwogICAgICAgICAgICAgICAgdGhpcy5jbG9zZSgpOwogICAgICAgICAgICAgICAgdGhpcy5zZXRQbGFjZWhvbGRlcigpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAgICAgICAgICAgdGhpcy5vcHRzLmluaXRTZWxlY3Rpb24uY2FsbChudWxsLCB0aGlzLm9wdHMuZWxlbWVudCwgZnVuY3Rpb24oc2VsZWN0ZWQpewogICAgICAgICAgICAgICAgICAgIGlmIChzZWxlY3RlZCAhPT0gdW5kZWZpbmVkICYmIHNlbGVjdGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYudXBkYXRlU2VsZWN0aW9uKHNlbGVjdGVkKTsKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5jbG9zZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnNldFBsYWNlaG9sZGVyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubmV4dFNlYXJjaFRlcm0gPSBzZWxmLm9wdHMubmV4dFNlYXJjaFRlcm0oc2VsZWN0ZWQsIHNlbGYuc2VhcmNoLnZhbCgpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIGlzUGxhY2Vob2xkZXJPcHRpb25TZWxlY3RlZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBwbGFjZWhvbGRlck9wdGlvbjsKICAgICAgICAgICAgaWYgKHRoaXMuZ2V0UGxhY2Vob2xkZXIoKSA9PT0gdW5kZWZpbmVkKSByZXR1cm4gZmFsc2U7IC8vIG5vIHBsYWNlaG9sZGVyIHNwZWNpZmllZCBzbyBubyBvcHRpb24gc2hvdWxkIGJlIGNvbnNpZGVyZWQKICAgICAgICAgICAgcmV0dXJuICgocGxhY2Vob2xkZXJPcHRpb24gPSB0aGlzLmdldFBsYWNlaG9sZGVyT3B0aW9uKCkpICE9PSB1bmRlZmluZWQgJiYgcGxhY2Vob2xkZXJPcHRpb24ucHJvcCgic2VsZWN0ZWQiKSkKICAgICAgICAgICAgICAgIHx8ICh0aGlzLm9wdHMuZWxlbWVudC52YWwoKSA9PT0gIiIpCiAgICAgICAgICAgICAgICB8fCAodGhpcy5vcHRzLmVsZW1lbnQudmFsKCkgPT09IHVuZGVmaW5lZCkKICAgICAgICAgICAgICAgIHx8ICh0aGlzLm9wdHMuZWxlbWVudC52YWwoKSA9PT0gbnVsbCk7CiAgICAgICAgfSwKCiAgICAgICAgLy8gc2luZ2xlCiAgICAgICAgcHJlcGFyZU9wdHM6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIG9wdHMgPSB0aGlzLnBhcmVudC5wcmVwYXJlT3B0cy5hcHBseSh0aGlzLCBhcmd1bWVudHMpLAogICAgICAgICAgICAgICAgc2VsZj10aGlzOwoKICAgICAgICAgICAgaWYgKG9wdHMuZWxlbWVudC5nZXQoMCkudGFnTmFtZS50b0xvd2VyQ2FzZSgpID09PSAic2VsZWN0IikgewogICAgICAgICAgICAgICAgLy8gaW5zdGFsbCB0aGUgc2VsZWN0aW9uIGluaXRpYWxpemVyCiAgICAgICAgICAgICAgICBvcHRzLmluaXRTZWxlY3Rpb24gPSBmdW5jdGlvbiAoZWxlbWVudCwgY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgICB2YXIgc2VsZWN0ZWQgPSBlbGVtZW50LmZpbmQoIm9wdGlvbiIpLmZpbHRlcihmdW5jdGlvbigpIHsgcmV0dXJuIHRoaXMuc2VsZWN0ZWQgJiYgIXRoaXMuZGlzYWJsZWQgfSk7CiAgICAgICAgICAgICAgICAgICAgLy8gYSBzaW5nbGUgc2VsZWN0IGJveCBhbHdheXMgaGFzIGEgdmFsdWUsIG5vIG5lZWQgdG8gbnVsbCBjaGVjayAnc2VsZWN0ZWQnCiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soc2VsZi5vcHRpb25Ub0RhdGEoc2VsZWN0ZWQpKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0gZWxzZSBpZiAoImRhdGEiIGluIG9wdHMpIHsKICAgICAgICAgICAgICAgIC8vIGluc3RhbGwgZGVmYXVsdCBpbml0U2VsZWN0aW9uIHdoZW4gYXBwbGllZCB0byBoaWRkZW4gaW5wdXQgYW5kIGRhdGEgaXMgbG9jYWwKICAgICAgICAgICAgICAgIG9wdHMuaW5pdFNlbGVjdGlvbiA9IG9wdHMuaW5pdFNlbGVjdGlvbiB8fCBmdW5jdGlvbiAoZWxlbWVudCwgY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaWQgPSBlbGVtZW50LnZhbCgpOwogICAgICAgICAgICAgICAgICAgIC8vc2VhcmNoIGluIGRhdGEgYnkgaWQsIHN0b3JpbmcgdGhlIGFjdHVhbCBtYXRjaGluZyBpdGVtCiAgICAgICAgICAgICAgICAgICAgdmFyIG1hdGNoID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICBvcHRzLnF1ZXJ5KHsKICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2hlcjogZnVuY3Rpb24odGVybSwgdGV4dCwgZWwpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGlzX21hdGNoID0gZXF1YWwoaWQsIG9wdHMuaWQoZWwpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc19tYXRjaCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoID0gZWw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaXNfbWF0Y2g7CiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrOiAhJC5pc0Z1bmN0aW9uKGNhbGxiYWNrKSA/ICQubm9vcCA6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sobWF0Y2gpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gb3B0czsKICAgICAgICB9LAoKICAgICAgICAvLyBzaW5nbGUKICAgICAgICBnZXRQbGFjZWhvbGRlcjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIC8vIGlmIGEgcGxhY2Vob2xkZXIgaXMgc3BlY2lmaWVkIG9uIGEgc2luZ2xlIHNlbGVjdCB3aXRob3V0IGEgdmFsaWQgcGxhY2Vob2xkZXIgb3B0aW9uIGlnbm9yZSBpdAogICAgICAgICAgICBpZiAodGhpcy5zZWxlY3QpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdldFBsYWNlaG9sZGVyT3B0aW9uKCkgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB0aGlzLnBhcmVudC5nZXRQbGFjZWhvbGRlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH0sCgogICAgICAgIC8vIHNpbmdsZQogICAgICAgIHNldFBsYWNlaG9sZGVyOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBwbGFjZWhvbGRlciA9IHRoaXMuZ2V0UGxhY2Vob2xkZXIoKTsKCiAgICAgICAgICAgIGlmICh0aGlzLmlzUGxhY2Vob2xkZXJPcHRpb25TZWxlY3RlZCgpICYmIHBsYWNlaG9sZGVyICE9PSB1bmRlZmluZWQpIHsKCiAgICAgICAgICAgICAgICAvLyBjaGVjayBmb3IgYSBwbGFjZWhvbGRlciBvcHRpb24gaWYgYXR0YWNoZWQgdG8gYSBzZWxlY3QKICAgICAgICAgICAgICAgIGlmICh0aGlzLnNlbGVjdCAmJiB0aGlzLmdldFBsYWNlaG9sZGVyT3B0aW9uKCkgPT09IHVuZGVmaW5lZCkgcmV0dXJuOwoKICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0aW9uLmZpbmQoIi5zZWxlY3QyLWNob3NlbiIpLmh0bWwodGhpcy5vcHRzLmVzY2FwZU1hcmt1cChwbGFjZWhvbGRlcikpOwoKICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0aW9uLmFkZENsYXNzKCJzZWxlY3QyLWRlZmF1bHQiKTsKCiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5yZW1vdmVDbGFzcygic2VsZWN0Mi1hbGxvd2NsZWFyIik7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvLyBzaW5nbGUKICAgICAgICBwb3N0cHJvY2Vzc1Jlc3VsdHM6IGZ1bmN0aW9uIChkYXRhLCBpbml0aWFsLCBub0hpZ2hsaWdodFVwZGF0ZSkgewogICAgICAgICAgICB2YXIgc2VsZWN0ZWQgPSAwLCBzZWxmID0gdGhpcywgc2hvd1NlYXJjaElucHV0ID0gdHJ1ZTsKCiAgICAgICAgICAgIC8vIGZpbmQgdGhlIHNlbGVjdGVkIGVsZW1lbnQgaW4gdGhlIHJlc3VsdCBsaXN0CgogICAgICAgICAgICB0aGlzLmZpbmRIaWdobGlnaHRhYmxlQ2hvaWNlcygpLmVhY2gyKGZ1bmN0aW9uIChpLCBlbG0pIHsKICAgICAgICAgICAgICAgIGlmIChlcXVhbChzZWxmLmlkKGVsbS5kYXRhKCJzZWxlY3QyLWRhdGEiKSksIHNlbGYub3B0cy5lbGVtZW50LnZhbCgpKSkgewogICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkID0gaTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gYW5kIGhpZ2hsaWdodCBpdAogICAgICAgICAgICBpZiAobm9IaWdobGlnaHRVcGRhdGUgIT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICBpZiAoaW5pdGlhbCA9PT0gdHJ1ZSAmJiBzZWxlY3RlZCA+PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5oaWdobGlnaHQoc2VsZWN0ZWQpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmhpZ2hsaWdodCgwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gaGlkZSB0aGUgc2VhcmNoIGJveCBpZiB0aGlzIGlzIHRoZSBmaXJzdCB3ZSBnb3QgdGhlIHJlc3VsdHMgYW5kIHRoZXJlIGFyZSBlbm91Z2ggb2YgdGhlbSBmb3Igc2VhcmNoCgogICAgICAgICAgICBpZiAoaW5pdGlhbCA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgdmFyIG1pbiA9IHRoaXMub3B0cy5taW5pbXVtUmVzdWx0c0ZvclNlYXJjaDsKICAgICAgICAgICAgICAgIGlmIChtaW4gPj0gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd1NlYXJjaChjb3VudFJlc3VsdHMoZGF0YS5yZXN1bHRzKSA+PSBtaW4pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLy8gc2luZ2xlCiAgICAgICAgc2hvd1NlYXJjaDogZnVuY3Rpb24oc2hvd1NlYXJjaElucHV0KSB7CiAgICAgICAgICAgIGlmICh0aGlzLnNob3dTZWFyY2hJbnB1dCA9PT0gc2hvd1NlYXJjaElucHV0KSByZXR1cm47CgogICAgICAgICAgICB0aGlzLnNob3dTZWFyY2hJbnB1dCA9IHNob3dTZWFyY2hJbnB1dDsKCiAgICAgICAgICAgIHRoaXMuZHJvcGRvd24uZmluZCgiLnNlbGVjdDItc2VhcmNoIikudG9nZ2xlQ2xhc3MoInNlbGVjdDItc2VhcmNoLWhpZGRlbiIsICFzaG93U2VhcmNoSW5wdXQpOwogICAgICAgICAgICB0aGlzLmRyb3Bkb3duLmZpbmQoIi5zZWxlY3QyLXNlYXJjaCIpLnRvZ2dsZUNsYXNzKCJzZWxlY3QyLW9mZnNjcmVlbiIsICFzaG93U2VhcmNoSW5wdXQpOwogICAgICAgICAgICAvL2FkZCAic2VsZWN0Mi13aXRoLXNlYXJjaGJveCIgdG8gdGhlIGNvbnRhaW5lciBpZiBzZWFyY2ggYm94IGlzIHNob3duCiAgICAgICAgICAgICQodGhpcy5kcm9wZG93biwgdGhpcy5jb250YWluZXIpLnRvZ2dsZUNsYXNzKCJzZWxlY3QyLXdpdGgtc2VhcmNoYm94Iiwgc2hvd1NlYXJjaElucHV0KTsKICAgICAgICB9LAoKICAgICAgICAvLyBzaW5nbGUKICAgICAgICBvblNlbGVjdDogZnVuY3Rpb24gKGRhdGEsIG9wdGlvbnMpIHsKCiAgICAgICAgICAgIGlmICghdGhpcy50cmlnZ2VyU2VsZWN0KGRhdGEpKSB7IHJldHVybjsgfQoKICAgICAgICAgICAgdmFyIG9sZCA9IHRoaXMub3B0cy5lbGVtZW50LnZhbCgpLAogICAgICAgICAgICAgICAgb2xkRGF0YSA9IHRoaXMuZGF0YSgpOwoKICAgICAgICAgICAgdGhpcy5vcHRzLmVsZW1lbnQudmFsKHRoaXMuaWQoZGF0YSkpOwogICAgICAgICAgICB0aGlzLnVwZGF0ZVNlbGVjdGlvbihkYXRhKTsKCiAgICAgICAgICAgIHRoaXMub3B0cy5lbGVtZW50LnRyaWdnZXIoeyB0eXBlOiAic2VsZWN0Mi1zZWxlY3RlZCIsIHZhbDogdGhpcy5pZChkYXRhKSwgY2hvaWNlOiBkYXRhIH0pOwoKICAgICAgICAgICAgdGhpcy5uZXh0U2VhcmNoVGVybSA9IHRoaXMub3B0cy5uZXh0U2VhcmNoVGVybShkYXRhLCB0aGlzLnNlYXJjaC52YWwoKSk7CiAgICAgICAgICAgIHRoaXMuY2xvc2UoKTsKCiAgICAgICAgICAgIGlmICgoIW9wdGlvbnMgfHwgIW9wdGlvbnMubm9Gb2N1cykgJiYgdGhpcy5vcHRzLnNob3VsZEZvY3VzSW5wdXQodGhpcykpIHsKICAgICAgICAgICAgICAgIHRoaXMuZm9jdXNzZXIuZm9jdXMoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFlcXVhbChvbGQsIHRoaXMuaWQoZGF0YSkpKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXJDaGFuZ2UoeyBhZGRlZDogZGF0YSwgcmVtb3ZlZDogb2xkRGF0YSB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8vIHNpbmdsZQogICAgICAgIHVwZGF0ZVNlbGVjdGlvbjogZnVuY3Rpb24gKGRhdGEpIHsKCiAgICAgICAgICAgIHZhciBjb250YWluZXI9dGhpcy5zZWxlY3Rpb24uZmluZCgiLnNlbGVjdDItY2hvc2VuIiksIGZvcm1hdHRlZCwgY3NzQ2xhc3M7CgogICAgICAgICAgICB0aGlzLnNlbGVjdGlvbi5kYXRhKCJzZWxlY3QyLWRhdGEiLCBkYXRhKTsKCiAgICAgICAgICAgIGNvbnRhaW5lci5lbXB0eSgpOwogICAgICAgICAgICBpZiAoZGF0YSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgZm9ybWF0dGVkPXRoaXMub3B0cy5mb3JtYXRTZWxlY3Rpb24oZGF0YSwgY29udGFpbmVyLCB0aGlzLm9wdHMuZXNjYXBlTWFya3VwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZm9ybWF0dGVkICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIGNvbnRhaW5lci5hcHBlbmQoZm9ybWF0dGVkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjc3NDbGFzcz10aGlzLm9wdHMuZm9ybWF0U2VsZWN0aW9uQ3NzQ2xhc3MoZGF0YSwgY29udGFpbmVyKTsKICAgICAgICAgICAgaWYgKGNzc0NsYXNzICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIGNvbnRhaW5lci5hZGRDbGFzcyhjc3NDbGFzcyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuc2VsZWN0aW9uLnJlbW92ZUNsYXNzKCJzZWxlY3QyLWRlZmF1bHQiKTsKCiAgICAgICAgICAgIGlmICh0aGlzLm9wdHMuYWxsb3dDbGVhciAmJiB0aGlzLmdldFBsYWNlaG9sZGVyKCkgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkQ2xhc3MoInNlbGVjdDItYWxsb3djbGVhciIpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLy8gc2luZ2xlCiAgICAgICAgdmFsOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciB2YWwsCiAgICAgICAgICAgICAgICB0cmlnZ2VyQ2hhbmdlID0gZmFsc2UsCiAgICAgICAgICAgICAgICBkYXRhID0gbnVsbCwKICAgICAgICAgICAgICAgIHNlbGYgPSB0aGlzLAogICAgICAgICAgICAgICAgb2xkRGF0YSA9IHRoaXMuZGF0YSgpOwoKICAgICAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm9wdHMuZWxlbWVudC52YWwoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFsID0gYXJndW1lbnRzWzBdOwoKICAgICAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgICB0cmlnZ2VyQ2hhbmdlID0gYXJndW1lbnRzWzFdOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5zZWxlY3QpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0CiAgICAgICAgICAgICAgICAgICAgLnZhbCh2YWwpCiAgICAgICAgICAgICAgICAgICAgLmZpbmQoIm9wdGlvbiIpLmZpbHRlcihmdW5jdGlvbigpIHsgcmV0dXJuIHRoaXMuc2VsZWN0ZWQgfSkuZWFjaDIoZnVuY3Rpb24gKGksIGVsbSkgewogICAgICAgICAgICAgICAgICAgICAgICBkYXRhID0gc2VsZi5vcHRpb25Ub0RhdGEoZWxtKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVTZWxlY3Rpb24oZGF0YSk7CiAgICAgICAgICAgICAgICB0aGlzLnNldFBsYWNlaG9sZGVyKCk7CiAgICAgICAgICAgICAgICBpZiAodHJpZ2dlckNoYW5nZSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlckNoYW5nZSh7YWRkZWQ6IGRhdGEsIHJlbW92ZWQ6b2xkRGF0YX0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gdmFsIGlzIGFuIGlkLiAhdmFsIGlzIHRydWUgZm9yIFt1bmRlZmluZWQsbnVsbCwnJywwXSAtIDAgaXMgbGVnYWwKICAgICAgICAgICAgICAgIGlmICghdmFsICYmIHZhbCAhPT0gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY2xlYXIodHJpZ2dlckNoYW5nZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHRoaXMub3B0cy5pbml0U2VsZWN0aW9uID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImNhbm5vdCBjYWxsIHZhbCgpIGlmIGluaXRTZWxlY3Rpb24oKSBpcyBub3QgZGVmaW5lZCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5vcHRzLmVsZW1lbnQudmFsKHZhbCk7CiAgICAgICAgICAgICAgICB0aGlzLm9wdHMuaW5pdFNlbGVjdGlvbih0aGlzLm9wdHMuZWxlbWVudCwgZnVuY3Rpb24oZGF0YSl7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5vcHRzLmVsZW1lbnQudmFsKCFkYXRhID8gIiIgOiBzZWxmLmlkKGRhdGEpKTsKICAgICAgICAgICAgICAgICAgICBzZWxmLnVwZGF0ZVNlbGVjdGlvbihkYXRhKTsKICAgICAgICAgICAgICAgICAgICBzZWxmLnNldFBsYWNlaG9sZGVyKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRyaWdnZXJDaGFuZ2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi50cmlnZ2VyQ2hhbmdlKHthZGRlZDogZGF0YSwgcmVtb3ZlZDpvbGREYXRhfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvLyBzaW5nbGUKICAgICAgICBjbGVhclNlYXJjaDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB0aGlzLnNlYXJjaC52YWwoIiIpOwogICAgICAgICAgICB0aGlzLmZvY3Vzc2VyLnZhbCgiIik7CiAgICAgICAgfSwKCiAgICAgICAgLy8gc2luZ2xlCiAgICAgICAgZGF0YTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgdmFyIGRhdGEsCiAgICAgICAgICAgICAgICB0cmlnZ2VyQ2hhbmdlID0gZmFsc2U7CgogICAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgZGF0YSA9IHRoaXMuc2VsZWN0aW9uLmRhdGEoInNlbGVjdDItZGF0YSIpOwogICAgICAgICAgICAgICAgaWYgKGRhdGEgPT0gdW5kZWZpbmVkKSBkYXRhID0gbnVsbDsKICAgICAgICAgICAgICAgIHJldHVybiBkYXRhOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgICAgICAgdHJpZ2dlckNoYW5nZSA9IGFyZ3VtZW50c1sxXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICghdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNsZWFyKHRyaWdnZXJDaGFuZ2UpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBkYXRhID0gdGhpcy5kYXRhKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vcHRzLmVsZW1lbnQudmFsKCF2YWx1ZSA/ICIiIDogdGhpcy5pZCh2YWx1ZSkpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlU2VsZWN0aW9uKHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICBpZiAodHJpZ2dlckNoYW5nZSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXJDaGFuZ2Uoe2FkZGVkOiB2YWx1ZSwgcmVtb3ZlZDpkYXRhfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSk7CgogICAgTXVsdGlTZWxlY3QyID0gY2xhenooQWJzdHJhY3RTZWxlY3QyLCB7CgogICAgICAgIC8vIG11bHRpCiAgICAgICAgY3JlYXRlQ29udGFpbmVyOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBjb250YWluZXIgPSAkKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpKS5hdHRyKHsKICAgICAgICAgICAgICAgICJjbGFzcyI6ICJzZWxlY3QyLWNvbnRhaW5lciBzZWxlY3QyLWNvbnRhaW5lci1tdWx0aSIKICAgICAgICAgICAgfSkuaHRtbChbCiAgICAgICAgICAgICAgICAiPHVsIGNsYXNzPSdzZWxlY3QyLWNob2ljZXMnPiIsCiAgICAgICAgICAgICAgICAiICA8bGkgY2xhc3M9J3NlbGVjdDItc2VhcmNoLWZpZWxkJz4iLAogICAgICAgICAgICAgICAgIiAgICA8bGFiZWwgZm9yPScnIGNsYXNzPSdzZWxlY3QyLW9mZnNjcmVlbic+PC9sYWJlbD4iLAogICAgICAgICAgICAgICAgIiAgICA8aW5wdXQgdHlwZT0ndGV4dCcgYXV0b2NvbXBsZXRlPSdvZmYnIGF1dG9jb3JyZWN0PSdvZmYnIGF1dG9jYXBpdGFsaXplPSdvZmYnIHNwZWxsY2hlY2s9J2ZhbHNlJyBjbGFzcz0nc2VsZWN0Mi1pbnB1dCc+IiwKICAgICAgICAgICAgICAgICIgIDwvbGk+IiwKICAgICAgICAgICAgICAgICI8L3VsPiIsCiAgICAgICAgICAgICAgICAiPGRpdiBjbGFzcz0nc2VsZWN0Mi1kcm9wIHNlbGVjdDItZHJvcC1tdWx0aSBzZWxlY3QyLWRpc3BsYXktbm9uZSc+IiwKICAgICAgICAgICAgICAgICIgICA8dWwgY2xhc3M9J3NlbGVjdDItcmVzdWx0cyc+IiwKICAgICAgICAgICAgICAgICIgICA8L3VsPiIsCiAgICAgICAgICAgICAgICAiPC9kaXY+Il0uam9pbigiIikpOwogICAgICAgICAgICByZXR1cm4gY29udGFpbmVyOwogICAgICAgIH0sCgogICAgICAgIC8vIG11bHRpCiAgICAgICAgcHJlcGFyZU9wdHM6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIG9wdHMgPSB0aGlzLnBhcmVudC5wcmVwYXJlT3B0cy5hcHBseSh0aGlzLCBhcmd1bWVudHMpLAogICAgICAgICAgICAgICAgc2VsZj10aGlzOwoKICAgICAgICAgICAgLy8gVE9ETyB2YWxpZGF0ZSBwbGFjZWhvbGRlciBpcyBhIHN0cmluZyBpZiBzcGVjaWZpZWQKCiAgICAgICAgICAgIGlmIChvcHRzLmVsZW1lbnQuZ2V0KDApLnRhZ05hbWUudG9Mb3dlckNhc2UoKSA9PT0gInNlbGVjdCIpIHsKICAgICAgICAgICAgICAgIC8vIGluc3RhbGwgdGhlIHNlbGVjdGlvbiBpbml0aWFsaXplcgogICAgICAgICAgICAgICAgb3B0cy5pbml0U2VsZWN0aW9uID0gZnVuY3Rpb24gKGVsZW1lbnQsIGNhbGxiYWNrKSB7CgogICAgICAgICAgICAgICAgICAgIHZhciBkYXRhID0gW107CgogICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuZmluZCgib3B0aW9uIikuZmlsdGVyKGZ1bmN0aW9uKCkgeyByZXR1cm4gdGhpcy5zZWxlY3RlZCAmJiAhdGhpcy5kaXNhYmxlZCB9KS5lYWNoMihmdW5jdGlvbiAoaSwgZWxtKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEucHVzaChzZWxmLm9wdGlvblRvRGF0YShlbG0pKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhkYXRhKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0gZWxzZSBpZiAoImRhdGEiIGluIG9wdHMpIHsKICAgICAgICAgICAgICAgIC8vIGluc3RhbGwgZGVmYXVsdCBpbml0U2VsZWN0aW9uIHdoZW4gYXBwbGllZCB0byBoaWRkZW4gaW5wdXQgYW5kIGRhdGEgaXMgbG9jYWwKICAgICAgICAgICAgICAgIG9wdHMuaW5pdFNlbGVjdGlvbiA9IG9wdHMuaW5pdFNlbGVjdGlvbiB8fCBmdW5jdGlvbiAoZWxlbWVudCwgY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaWRzID0gc3BsaXRWYWwoZWxlbWVudC52YWwoKSwgb3B0cy5zZXBhcmF0b3IpOwogICAgICAgICAgICAgICAgICAgIC8vc2VhcmNoIGluIGRhdGEgYnkgYXJyYXkgb2YgaWRzLCBzdG9yaW5nIG1hdGNoaW5nIGl0ZW1zIGluIGEgbGlzdAogICAgICAgICAgICAgICAgICAgIHZhciBtYXRjaGVzID0gW107CiAgICAgICAgICAgICAgICAgICAgb3B0cy5xdWVyeSh7CiAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoZXI6IGZ1bmN0aW9uKHRlcm0sIHRleHQsIGVsKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpc19tYXRjaCA9ICQuZ3JlcChpZHMsIGZ1bmN0aW9uKGlkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVxdWFsKGlkLCBvcHRzLmlkKGVsKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KS5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNfbWF0Y2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXRjaGVzLnB1c2goZWwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlzX21hdGNoOwogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjazogISQuaXNGdW5jdGlvbihjYWxsYmFjaykgPyAkLm5vb3AgOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJlb3JkZXIgbWF0Y2hlcyBiYXNlZCBvbiB0aGUgb3JkZXIgdGhleSBhcHBlYXIgaW4gdGhlIGlkcyBhcnJheSBiZWNhdXNlIHJpZ2h0IG5vdwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdGhleSBhcmUgaW4gdGhlIG9yZGVyIGluIHdoaWNoIHRoZXkgYXBwZWFyIGluIGRhdGEgYXJyYXkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBvcmRlcmVkID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGlkcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpZCA9IGlkc1tpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IG1hdGNoZXMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG1hdGNoID0gbWF0Y2hlc1tqXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVxdWFsKGlkLCBvcHRzLmlkKG1hdGNoKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9yZGVyZWQucHVzaChtYXRjaCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXRjaGVzLnNwbGljZShqLCAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sob3JkZXJlZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBvcHRzOwogICAgICAgIH0sCgogICAgICAgIC8vIG11bHRpCiAgICAgICAgc2VsZWN0Q2hvaWNlOiBmdW5jdGlvbiAoY2hvaWNlKSB7CgogICAgICAgICAgICB2YXIgc2VsZWN0ZWQgPSB0aGlzLmNvbnRhaW5lci5maW5kKCIuc2VsZWN0Mi1zZWFyY2gtY2hvaWNlLWZvY3VzIik7CiAgICAgICAgICAgIGlmIChzZWxlY3RlZC5sZW5ndGggJiYgY2hvaWNlICYmIGNob2ljZVswXSA9PSBzZWxlY3RlZFswXSkgewoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChzZWxlY3RlZC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLm9wdHMuZWxlbWVudC50cmlnZ2VyKCJjaG9pY2UtZGVzZWxlY3RlZCIsIHNlbGVjdGVkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHNlbGVjdGVkLnJlbW92ZUNsYXNzKCJzZWxlY3QyLXNlYXJjaC1jaG9pY2UtZm9jdXMiKTsKICAgICAgICAgICAgICAgIGlmIChjaG9pY2UgJiYgY2hvaWNlLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY2xvc2UoKTsKICAgICAgICAgICAgICAgICAgICBjaG9pY2UuYWRkQ2xhc3MoInNlbGVjdDItc2VhcmNoLWNob2ljZS1mb2N1cyIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMub3B0cy5lbGVtZW50LnRyaWdnZXIoImNob2ljZS1zZWxlY3RlZCIsIGNob2ljZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvLyBtdWx0aQogICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAkKCJsYWJlbFtmb3I9JyIgKyB0aGlzLnNlYXJjaC5hdHRyKCdpZCcpICsgIiddIikKICAgICAgICAgICAgICAgIC5hdHRyKCdmb3InLCB0aGlzLm9wdHMuZWxlbWVudC5hdHRyKCJpZCIpKTsKICAgICAgICAgICAgdGhpcy5wYXJlbnQuZGVzdHJveS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICAgICAgICAgICAgY2xlYW51cEpRdWVyeUVsZW1lbnRzLmNhbGwodGhpcywKICAgICAgICAgICAgICAgICJzZWFyY2hDb250YWluZXIiLAogICAgICAgICAgICAgICAgInNlbGVjdGlvbiIKICAgICAgICAgICAgKTsKICAgICAgICB9LAoKICAgICAgICAvLyBtdWx0aQogICAgICAgIGluaXRDb250YWluZXI6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgICAgIHZhciBzZWxlY3RvciA9ICIuc2VsZWN0Mi1jaG9pY2VzIiwgc2VsZWN0aW9uOwoKICAgICAgICAgICAgdGhpcy5zZWFyY2hDb250YWluZXIgPSB0aGlzLmNvbnRhaW5lci5maW5kKCIuc2VsZWN0Mi1zZWFyY2gtZmllbGQiKTsKICAgICAgICAgICAgdGhpcy5zZWxlY3Rpb24gPSBzZWxlY3Rpb24gPSB0aGlzLmNvbnRhaW5lci5maW5kKHNlbGVjdG9yKTsKCiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICAgICAgICAgIHRoaXMuc2VsZWN0aW9uLm9uKCJjbGljayIsICIuc2VsZWN0Mi1zZWFyY2gtY2hvaWNlOm5vdCguc2VsZWN0Mi1sb2NrZWQpIiwgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICAgIC8va2lsbEV2ZW50KGUpOwogICAgICAgICAgICAgICAgX3RoaXMuc2VhcmNoWzBdLmZvY3VzKCk7CiAgICAgICAgICAgICAgICBfdGhpcy5zZWxlY3RDaG9pY2UoJCh0aGlzKSk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gcmV3cml0ZSBsYWJlbHMgZnJvbSBvcmlnaW5hbCBlbGVtZW50IHRvIGZvY3Vzc2VyCiAgICAgICAgICAgIHRoaXMuc2VhcmNoLmF0dHIoImlkIiwgInMyaWRfYXV0b2dlbiIrbmV4dFVpZCgpKTsKCiAgICAgICAgICAgIHRoaXMuc2VhcmNoLnByZXYoKQogICAgICAgICAgICAgICAgLnRleHQoJCgibGFiZWxbZm9yPSciICsgdGhpcy5vcHRzLmVsZW1lbnQuYXR0cigiaWQiKSArICInXSIpLnRleHQoKSkKICAgICAgICAgICAgICAgIC5hdHRyKCdmb3InLCB0aGlzLnNlYXJjaC5hdHRyKCdpZCcpKTsKCiAgICAgICAgICAgIHRoaXMuc2VhcmNoLm9uKCJpbnB1dCBwYXN0ZSIsIHRoaXMuYmluZChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnNlYXJjaC5hdHRyKCdwbGFjZWhvbGRlcicpICYmIHRoaXMuc2VhcmNoLnZhbCgpLmxlbmd0aCA9PSAwKSByZXR1cm47CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaXNJbnRlcmZhY2VFbmFibGVkKCkpIHJldHVybjsKICAgICAgICAgICAgICAgIGlmICghdGhpcy5vcGVuZWQoKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMub3BlbigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KSk7CgogICAgICAgICAgICB0aGlzLnNlYXJjaC5hdHRyKCJ0YWJpbmRleCIsIHRoaXMuZWxlbWVudFRhYkluZGV4KTsKCiAgICAgICAgICAgIHRoaXMua2V5ZG93bnMgPSAwOwogICAgICAgICAgICB0aGlzLnNlYXJjaC5vbigia2V5ZG93biIsIHRoaXMuYmluZChmdW5jdGlvbiAoZSkgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLmlzSW50ZXJmYWNlRW5hYmxlZCgpKSByZXR1cm47CgogICAgICAgICAgICAgICAgKyt0aGlzLmtleWRvd25zOwogICAgICAgICAgICAgICAgdmFyIHNlbGVjdGVkID0gc2VsZWN0aW9uLmZpbmQoIi5zZWxlY3QyLXNlYXJjaC1jaG9pY2UtZm9jdXMiKTsKICAgICAgICAgICAgICAgIHZhciBwcmV2ID0gc2VsZWN0ZWQucHJldigiLnNlbGVjdDItc2VhcmNoLWNob2ljZTpub3QoLnNlbGVjdDItbG9ja2VkKSIpOwogICAgICAgICAgICAgICAgdmFyIG5leHQgPSBzZWxlY3RlZC5uZXh0KCIuc2VsZWN0Mi1zZWFyY2gtY2hvaWNlOm5vdCguc2VsZWN0Mi1sb2NrZWQpIik7CiAgICAgICAgICAgICAgICB2YXIgcG9zID0gZ2V0Q3Vyc29ySW5mbyh0aGlzLnNlYXJjaCk7CgogICAgICAgICAgICAgICAgaWYgKHNlbGVjdGVkLmxlbmd0aCAmJgogICAgICAgICAgICAgICAgICAgIChlLndoaWNoID09IEtFWS5MRUZUIHx8IGUud2hpY2ggPT0gS0VZLlJJR0hUIHx8IGUud2hpY2ggPT0gS0VZLkJBQ0tTUEFDRSB8fCBlLndoaWNoID09IEtFWS5ERUxFVEUgfHwgZS53aGljaCA9PSBLRVkuRU5URVIpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHNlbGVjdGVkQ2hvaWNlID0gc2VsZWN0ZWQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKGUud2hpY2ggPT0gS0VZLkxFRlQgJiYgcHJldi5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRDaG9pY2UgPSBwcmV2OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChlLndoaWNoID09IEtFWS5SSUdIVCkgewogICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZENob2ljZSA9IG5leHQubGVuZ3RoID8gbmV4dCA6IG51bGw7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGUud2hpY2ggPT09IEtFWS5CQUNLU1BBQ0UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMudW5zZWxlY3Qoc2VsZWN0ZWQuZmlyc3QoKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2VhcmNoLndpZHRoKDEwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkQ2hvaWNlID0gcHJldi5sZW5ndGggPyBwcmV2IDogbmV4dDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZS53aGljaCA9PSBLRVkuREVMRVRFKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnVuc2VsZWN0KHNlbGVjdGVkLmZpcnN0KCkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNlYXJjaC53aWR0aCgxMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZENob2ljZSA9IG5leHQubGVuZ3RoID8gbmV4dCA6IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGUud2hpY2ggPT0gS0VZLkVOVEVSKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkQ2hvaWNlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0Q2hvaWNlKHNlbGVjdGVkQ2hvaWNlKTsKICAgICAgICAgICAgICAgICAgICBraWxsRXZlbnQoZSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFzZWxlY3RlZENob2ljZSB8fCAhc2VsZWN0ZWRDaG9pY2UubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3BlbigpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCgoZS53aGljaCA9PT0gS0VZLkJBQ0tTUEFDRSAmJiB0aGlzLmtleWRvd25zID09IDEpCiAgICAgICAgICAgICAgICAgICAgfHwgZS53aGljaCA9PSBLRVkuTEVGVCkgJiYgKHBvcy5vZmZzZXQgPT0gMCAmJiAhcG9zLmxlbmd0aCkpIHsKCiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RDaG9pY2Uoc2VsZWN0aW9uLmZpbmQoIi5zZWxlY3QyLXNlYXJjaC1jaG9pY2U6bm90KC5zZWxlY3QyLWxvY2tlZCkiKS5sYXN0KCkpOwogICAgICAgICAgICAgICAgICAgIGtpbGxFdmVudChlKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0Q2hvaWNlKG51bGwpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICh0aGlzLm9wZW5lZCgpKSB7CiAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChlLndoaWNoKSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSBLRVkuVVA6CiAgICAgICAgICAgICAgICAgICAgY2FzZSBLRVkuRE9XTjoKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tb3ZlSGlnaGxpZ2h0KChlLndoaWNoID09PSBLRVkuVVApID8gLTEgOiAxKTsKICAgICAgICAgICAgICAgICAgICAgICAga2lsbEV2ZW50KGUpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgY2FzZSBLRVkuRU5URVI6CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0SGlnaGxpZ2h0ZWQoKTsKICAgICAgICAgICAgICAgICAgICAgICAga2lsbEV2ZW50KGUpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgY2FzZSBLRVkuVEFCOgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdEhpZ2hsaWdodGVkKHtub0ZvY3VzOnRydWV9KTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jbG9zZSgpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgY2FzZSBLRVkuRVNDOgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbmNlbChlKTsKICAgICAgICAgICAgICAgICAgICAgICAga2lsbEV2ZW50KGUpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChlLndoaWNoID09PSBLRVkuVEFCIHx8IEtFWS5pc0NvbnRyb2woZSkgfHwgS0VZLmlzRnVuY3Rpb25LZXkoZSkKICAgICAgICAgICAgICAgICB8fCBlLndoaWNoID09PSBLRVkuQkFDS1NQQUNFIHx8IGUud2hpY2ggPT09IEtFWS5FU0MpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGUud2hpY2ggPT09IEtFWS5FTlRFUikgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLm9wdHMub3Blbk9uRW50ZXIgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGUuYWx0S2V5IHx8IGUuY3RybEtleSB8fCBlLnNoaWZ0S2V5IHx8IGUubWV0YUtleSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXMub3BlbigpOwoKICAgICAgICAgICAgICAgIGlmIChlLndoaWNoID09PSBLRVkuUEFHRV9VUCB8fCBlLndoaWNoID09PSBLRVkuUEFHRV9ET1dOKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gcHJldmVudCB0aGUgcGFnZSBmcm9tIHNjcm9sbGluZwogICAgICAgICAgICAgICAgICAgIGtpbGxFdmVudChlKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoZS53aGljaCA9PT0gS0VZLkVOVEVSKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gcHJldmVudCBmb3JtIGZyb20gYmVpbmcgc3VibWl0dGVkCiAgICAgICAgICAgICAgICAgICAga2lsbEV2ZW50KGUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfSkpOwoKICAgICAgICAgICAgdGhpcy5zZWFyY2gub24oImtleXVwIiwgdGhpcy5iaW5kKGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgICAgICB0aGlzLmtleWRvd25zID0gMDsKICAgICAgICAgICAgICAgIHRoaXMucmVzaXplU2VhcmNoKCk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgICk7CgogICAgICAgICAgICB0aGlzLnNlYXJjaC5vbigiYmx1ciIsIHRoaXMuYmluZChmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5yZW1vdmVDbGFzcygic2VsZWN0Mi1jb250YWluZXItYWN0aXZlIik7CiAgICAgICAgICAgICAgICB0aGlzLnNlYXJjaC5yZW1vdmVDbGFzcygic2VsZWN0Mi1mb2N1c2VkIik7CiAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdENob2ljZShudWxsKTsKICAgICAgICAgICAgICAgIGlmICghdGhpcy5vcGVuZWQoKSkgdGhpcy5jbGVhclNlYXJjaCgpOwogICAgICAgICAgICAgICAgZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgIHRoaXMub3B0cy5lbGVtZW50LnRyaWdnZXIoJC5FdmVudCgic2VsZWN0Mi1ibHVyIikpOwogICAgICAgICAgICB9KSk7CgogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5vbigiY2xpY2siLCBzZWxlY3RvciwgdGhpcy5iaW5kKGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaXNJbnRlcmZhY2VFbmFibGVkKCkpIHJldHVybjsKICAgICAgICAgICAgICAgIGlmICgkKGUudGFyZ2V0KS5jbG9zZXN0KCIuc2VsZWN0Mi1zZWFyY2gtY2hvaWNlIikubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgIC8vIGNsaWNrZWQgaW5zaWRlIGEgc2VsZWN0MiBzZWFyY2ggY2hvaWNlLCBkbyBub3Qgb3BlbgogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0Q2hvaWNlKG51bGwpOwogICAgICAgICAgICAgICAgdGhpcy5jbGVhclBsYWNlaG9sZGVyKCk7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuY29udGFpbmVyLmhhc0NsYXNzKCJzZWxlY3QyLWNvbnRhaW5lci1hY3RpdmUiKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMub3B0cy5lbGVtZW50LnRyaWdnZXIoJC5FdmVudCgic2VsZWN0Mi1mb2N1cyIpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMub3BlbigpOwogICAgICAgICAgICAgICAgdGhpcy5mb2N1c1NlYXJjaCgpOwogICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICB9KSk7CgogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5vbigiZm9jdXMiLCBzZWxlY3RvciwgdGhpcy5iaW5kKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGlmICghdGhpcy5pc0ludGVyZmFjZUVuYWJsZWQoKSkgcmV0dXJuOwogICAgICAgICAgICAgICAgaWYgKCF0aGlzLmNvbnRhaW5lci5oYXNDbGFzcygic2VsZWN0Mi1jb250YWluZXItYWN0aXZlIikpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLm9wdHMuZWxlbWVudC50cmlnZ2VyKCQuRXZlbnQoInNlbGVjdDItZm9jdXMiKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGRDbGFzcygic2VsZWN0Mi1jb250YWluZXItYWN0aXZlIik7CiAgICAgICAgICAgICAgICB0aGlzLmRyb3Bkb3duLmFkZENsYXNzKCJzZWxlY3QyLWRyb3AtYWN0aXZlIik7CiAgICAgICAgICAgICAgICB0aGlzLmNsZWFyUGxhY2Vob2xkZXIoKTsKICAgICAgICAgICAgfSkpOwoKICAgICAgICAgICAgdGhpcy5pbml0Q29udGFpbmVyV2lkdGgoKTsKICAgICAgICAgICAgdGhpcy5vcHRzLmVsZW1lbnQuYWRkQ2xhc3MoInNlbGVjdDItb2Zmc2NyZWVuIik7CgogICAgICAgICAgICAvLyBzZXQgdGhlIHBsYWNlaG9sZGVyIGlmIG5lY2Vzc2FyeQogICAgICAgICAgICB0aGlzLmNsZWFyU2VhcmNoKCk7CiAgICAgICAgfSwKCiAgICAgICAgLy8gbXVsdGkKICAgICAgICBlbmFibGVJbnRlcmZhY2U6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAodGhpcy5wYXJlbnQuZW5hYmxlSW50ZXJmYWNlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2VhcmNoLnByb3AoImRpc2FibGVkIiwgIXRoaXMuaXNJbnRlcmZhY2VFbmFibGVkKCkpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLy8gbXVsdGkKICAgICAgICBpbml0U2VsZWN0aW9uOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBkYXRhOwogICAgICAgICAgICBpZiAodGhpcy5vcHRzLmVsZW1lbnQudmFsKCkgPT09ICIiICYmIHRoaXMub3B0cy5lbGVtZW50LnRleHQoKSA9PT0gIiIpIHsKICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlU2VsZWN0aW9uKFtdKTsKICAgICAgICAgICAgICAgIHRoaXMuY2xvc2UoKTsKICAgICAgICAgICAgICAgIC8vIHNldCB0aGUgcGxhY2Vob2xkZXIgaWYgbmVjZXNzYXJ5CiAgICAgICAgICAgICAgICB0aGlzLmNsZWFyU2VhcmNoKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuc2VsZWN0IHx8IHRoaXMub3B0cy5lbGVtZW50LnZhbCgpICE9PSAiIikgewogICAgICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAgICAgICAgICAgdGhpcy5vcHRzLmluaXRTZWxlY3Rpb24uY2FsbChudWxsLCB0aGlzLm9wdHMuZWxlbWVudCwgZnVuY3Rpb24oZGF0YSl7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGEgIT09IHVuZGVmaW5lZCAmJiBkYXRhICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYudXBkYXRlU2VsZWN0aW9uKGRhdGEpOwogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmNsb3NlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNldCB0aGUgcGxhY2Vob2xkZXIgaWYgbmVjZXNzYXJ5CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuY2xlYXJTZWFyY2goKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8vIG11bHRpCiAgICAgICAgY2xlYXJTZWFyY2g6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIHBsYWNlaG9sZGVyID0gdGhpcy5nZXRQbGFjZWhvbGRlcigpLAogICAgICAgICAgICAgICAgbWF4V2lkdGggPSB0aGlzLmdldE1heFNlYXJjaFdpZHRoKCk7CgogICAgICAgICAgICBpZiAocGxhY2Vob2xkZXIgIT09IHVuZGVmaW5lZCAgJiYgdGhpcy5nZXRWYWwoKS5sZW5ndGggPT09IDAgJiYgdGhpcy5zZWFyY2guaGFzQ2xhc3MoInNlbGVjdDItZm9jdXNlZCIpID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgdGhpcy5zZWFyY2gudmFsKHBsYWNlaG9sZGVyKS5hZGRDbGFzcygic2VsZWN0Mi1kZWZhdWx0Iik7CiAgICAgICAgICAgICAgICAvLyBzdHJldGNoIHRoZSBzZWFyY2ggYm94IHRvIGZ1bGwgd2lkdGggb2YgdGhlIGNvbnRhaW5lciBzbyBhcyBtdWNoIG9mIHRoZSBwbGFjZWhvbGRlciBpcyB2aXNpYmxlIGFzIHBvc3NpYmxlCiAgICAgICAgICAgICAgICAvLyB3ZSBjb3VsZCBjYWxsIHRoaXMucmVzaXplU2VhcmNoKCksIGJ1dCB3ZSBkbyBub3QgYmVjYXVzZSB0aGF0IHJlcXVpcmVzIGEgc2l6ZXIgYW5kIHdlIGRvIG5vdCB3YW50IHRvIGNyZWF0ZSBvbmUgc28gZWFybHkgYmVjYXVzZSBvZiBhIGZpcmVmb3ggYnVnLCBzZWUgIzk0NAogICAgICAgICAgICAgICAgdGhpcy5zZWFyY2gud2lkdGgobWF4V2lkdGggPiAwID8gbWF4V2lkdGggOiB0aGlzLmNvbnRhaW5lci5jc3MoIndpZHRoIikpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5zZWFyY2gudmFsKCIiKS53aWR0aCgxMCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvLyBtdWx0aQogICAgICAgIGNsZWFyUGxhY2Vob2xkZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgaWYgKHRoaXMuc2VhcmNoLmhhc0NsYXNzKCJzZWxlY3QyLWRlZmF1bHQiKSkgewogICAgICAgICAgICAgICAgdGhpcy5zZWFyY2gudmFsKCIiKS5yZW1vdmVDbGFzcygic2VsZWN0Mi1kZWZhdWx0Iik7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvLyBtdWx0aQogICAgICAgIG9wZW5pbmc6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdGhpcy5jbGVhclBsYWNlaG9sZGVyKCk7IC8vIHNob3VsZCBiZSBkb25lIGJlZm9yZSBzdXBlciBzbyBwbGFjZWhvbGRlciBpcyBub3QgdXNlZCB0byBzZWFyY2gKICAgICAgICAgICAgdGhpcy5yZXNpemVTZWFyY2goKTsKCiAgICAgICAgICAgIHRoaXMucGFyZW50Lm9wZW5pbmcuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgICAgICAgICAgIHRoaXMuZm9jdXNTZWFyY2goKTsKCiAgICAgICAgICAgIC8vIGluaXRpYWxpemVzIHNlYXJjaCdzIHZhbHVlIHdpdGggbmV4dFNlYXJjaFRlcm0gKGlmIGRlZmluZWQgYnkgdXNlcikKICAgICAgICAgICAgLy8gaWdub3JlIG5leHRTZWFyY2hUZXJtIGlmIHRoZSBkcm9wZG93biBpcyBvcGVuZWQgYnkgdGhlIHVzZXIgcHJlc3NpbmcgYSBsZXR0ZXIKICAgICAgICAgICAgaWYodGhpcy5zZWFyY2gudmFsKCkgPT09ICIiKSB7CiAgICAgICAgICAgICAgICBpZih0aGlzLm5leHRTZWFyY2hUZXJtICE9IHVuZGVmaW5lZCl7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWFyY2gudmFsKHRoaXMubmV4dFNlYXJjaFRlcm0pOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc2VhcmNoLnNlbGVjdCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnVwZGF0ZVJlc3VsdHModHJ1ZSk7CiAgICAgICAgICAgIGlmICh0aGlzLm9wdHMuc2hvdWxkRm9jdXNJbnB1dCh0aGlzKSkgewogICAgICAgICAgICAgICAgdGhpcy5zZWFyY2guZm9jdXMoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLm9wdHMuZWxlbWVudC50cmlnZ2VyKCQuRXZlbnQoInNlbGVjdDItb3BlbiIpKTsKICAgICAgICB9LAoKICAgICAgICAvLyBtdWx0aQogICAgICAgIGNsb3NlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5vcGVuZWQoKSkgcmV0dXJuOwogICAgICAgICAgICB0aGlzLnBhcmVudC5jbG9zZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH0sCgogICAgICAgIC8vIG11bHRpCiAgICAgICAgZm9jdXM6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdGhpcy5jbG9zZSgpOwogICAgICAgICAgICB0aGlzLnNlYXJjaC5mb2N1cygpOwogICAgICAgIH0sCgogICAgICAgIC8vIG11bHRpCiAgICAgICAgaXNGb2N1c2VkOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnNlYXJjaC5oYXNDbGFzcygic2VsZWN0Mi1mb2N1c2VkIik7CiAgICAgICAgfSwKCiAgICAgICAgLy8gbXVsdGkKICAgICAgICB1cGRhdGVTZWxlY3Rpb246IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgIHZhciBpZHMgPSBbXSwgZmlsdGVyZWQgPSBbXSwgc2VsZiA9IHRoaXM7CgogICAgICAgICAgICAvLyBmaWx0ZXIgb3V0IGR1cGxpY2F0ZXMKICAgICAgICAgICAgJChkYXRhKS5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGlmIChpbmRleE9mKHNlbGYuaWQodGhpcyksIGlkcykgPCAwKSB7CiAgICAgICAgICAgICAgICAgICAgaWRzLnB1c2goc2VsZi5pZCh0aGlzKSk7CiAgICAgICAgICAgICAgICAgICAgZmlsdGVyZWQucHVzaCh0aGlzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGRhdGEgPSBmaWx0ZXJlZDsKCiAgICAgICAgICAgIHRoaXMuc2VsZWN0aW9uLmZpbmQoIi5zZWxlY3QyLXNlYXJjaC1jaG9pY2UiKS5yZW1vdmUoKTsKICAgICAgICAgICAgJChkYXRhKS5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHNlbGYuYWRkU2VsZWN0ZWRDaG9pY2UodGhpcyk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBzZWxmLnBvc3Rwcm9jZXNzUmVzdWx0cygpOwogICAgICAgIH0sCgogICAgICAgIC8vIG11bHRpCiAgICAgICAgdG9rZW5pemU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgaW5wdXQgPSB0aGlzLnNlYXJjaC52YWwoKTsKICAgICAgICAgICAgaW5wdXQgPSB0aGlzLm9wdHMudG9rZW5pemVyLmNhbGwodGhpcywgaW5wdXQsIHRoaXMuZGF0YSgpLCB0aGlzLmJpbmQodGhpcy5vblNlbGVjdCksIHRoaXMub3B0cyk7CiAgICAgICAgICAgIGlmIChpbnB1dCAhPSBudWxsICYmIGlucHV0ICE9IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdGhpcy5zZWFyY2gudmFsKGlucHV0KTsKICAgICAgICAgICAgICAgIGlmIChpbnB1dC5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vcGVuKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgfSwKCiAgICAgICAgLy8gbXVsdGkKICAgICAgICBvblNlbGVjdDogZnVuY3Rpb24gKGRhdGEsIG9wdGlvbnMpIHsKCiAgICAgICAgICAgIGlmICghdGhpcy50cmlnZ2VyU2VsZWN0KGRhdGEpKSB7IHJldHVybjsgfQoKICAgICAgICAgICAgdGhpcy5hZGRTZWxlY3RlZENob2ljZShkYXRhKTsKCiAgICAgICAgICAgIHRoaXMub3B0cy5lbGVtZW50LnRyaWdnZXIoeyB0eXBlOiAic2VsZWN0ZWQiLCB2YWw6IHRoaXMuaWQoZGF0YSksIGNob2ljZTogZGF0YSB9KTsKCiAgICAgICAgICAgIC8vIGtlZXAgdHJhY2sgb2YgdGhlIHNlYXJjaCdzIHZhbHVlIGJlZm9yZSBpdCBnZXRzIGNsZWFyZWQKICAgICAgICAgICAgdGhpcy5uZXh0U2VhcmNoVGVybSA9IHRoaXMub3B0cy5uZXh0U2VhcmNoVGVybShkYXRhLCB0aGlzLnNlYXJjaC52YWwoKSk7CgogICAgICAgICAgICB0aGlzLmNsZWFyU2VhcmNoKCk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlUmVzdWx0cygpOwoKICAgICAgICAgICAgaWYgKHRoaXMuc2VsZWN0IHx8ICF0aGlzLm9wdHMuY2xvc2VPblNlbGVjdCkgdGhpcy5wb3N0cHJvY2Vzc1Jlc3VsdHMoZGF0YSwgZmFsc2UsIHRoaXMub3B0cy5jbG9zZU9uU2VsZWN0PT09dHJ1ZSk7CgogICAgICAgICAgICBpZiAodGhpcy5vcHRzLmNsb3NlT25TZWxlY3QpIHsKICAgICAgICAgICAgICAgIHRoaXMuY2xvc2UoKTsKICAgICAgICAgICAgICAgIHRoaXMuc2VhcmNoLndpZHRoKDEwKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmNvdW50U2VsZWN0YWJsZVJlc3VsdHMoKT4wKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWFyY2gud2lkdGgoMTApOwogICAgICAgICAgICAgICAgICAgIHRoaXMucmVzaXplU2VhcmNoKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2V0TWF4aW11bVNlbGVjdGlvblNpemUoKSA+IDAgJiYgdGhpcy52YWwoKS5sZW5ndGggPj0gdGhpcy5nZXRNYXhpbXVtU2VsZWN0aW9uU2l6ZSgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIHdlIHJlYWNoZWQgbWF4IHNlbGVjdGlvbiBzaXplIHJlcGFpbnQgdGhlIHJlc3VsdHMgc28gY2hvaWNlcwogICAgICAgICAgICAgICAgICAgICAgICAvLyBhcmUgcmVwbGFjZWQgd2l0aCB0aGUgbWF4IHNlbGVjdGlvbiByZWFjaGVkIG1lc3NhZ2UKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy51cGRhdGVSZXN1bHRzKHRydWUpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGluaXRpYWxpemVzIHNlYXJjaCdzIHZhbHVlIHdpdGggbmV4dFNlYXJjaFRlcm0gYW5kIHVwZGF0ZSBzZWFyY2ggcmVzdWx0CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMubmV4dFNlYXJjaFRlcm0gIT0gdW5kZWZpbmVkKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2VhcmNoLnZhbCh0aGlzLm5leHRTZWFyY2hUZXJtKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlUmVzdWx0cygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWFyY2guc2VsZWN0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wb3NpdGlvbkRyb3Bkb3duKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIGlmIG5vdGhpbmcgbGVmdCB0byBzZWxlY3QgY2xvc2UKICAgICAgICAgICAgICAgICAgICB0aGlzLmNsb3NlKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWFyY2gud2lkdGgoMTApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBzaW5jZSBpdHMgbm90IHBvc3NpYmxlIHRvIHNlbGVjdCBhbiBlbGVtZW50IHRoYXQgaGFzIGFscmVhZHkgYmVlbgogICAgICAgICAgICAvLyBhZGRlZCB3ZSBkbyBub3QgbmVlZCB0byBjaGVjayBpZiB0aGlzIGlzIGEgbmV3IGVsZW1lbnQgYmVmb3JlIGZpcmluZyBjaGFuZ2UKICAgICAgICAgICAgdGhpcy50cmlnZ2VyQ2hhbmdlKHsgYWRkZWQ6IGRhdGEgfSk7CgogICAgICAgICAgICBpZiAoIW9wdGlvbnMgfHwgIW9wdGlvbnMubm9Gb2N1cykKICAgICAgICAgICAgICAgIHRoaXMuZm9jdXNTZWFyY2goKTsKICAgICAgICB9LAoKICAgICAgICAvLyBtdWx0aQogICAgICAgIGNhbmNlbDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB0aGlzLmNsb3NlKCk7CiAgICAgICAgICAgIHRoaXMuZm9jdXNTZWFyY2goKTsKICAgICAgICB9LAoKICAgICAgICBhZGRTZWxlY3RlZENob2ljZTogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgdmFyIGVuYWJsZUNob2ljZSA9ICFkYXRhLmxvY2tlZCwKICAgICAgICAgICAgICAgIGVuYWJsZWRJdGVtID0gJCgKICAgICAgICAgICAgICAgICAgICAiPGxpIGNsYXNzPSdzZWxlY3QyLXNlYXJjaC1jaG9pY2UnPiIgKwogICAgICAgICAgICAgICAgICAgICIgICAgPGRpdj48L2Rpdj4iICsKICAgICAgICAgICAgICAgICAgICAiICAgIDxhIGhyZWY9JyMnIGNsYXNzPSdzZWxlY3QyLXNlYXJjaC1jaG9pY2UtY2xvc2UnIHRhYmluZGV4PSctMSc+PC9hPiIgKwogICAgICAgICAgICAgICAgICAgICI8L2xpPiIpLAogICAgICAgICAgICAgICAgZGlzYWJsZWRJdGVtID0gJCgKICAgICAgICAgICAgICAgICAgICAiPGxpIGNsYXNzPSdzZWxlY3QyLXNlYXJjaC1jaG9pY2Ugc2VsZWN0Mi1sb2NrZWQnPiIgKwogICAgICAgICAgICAgICAgICAgICI8ZGl2PjwvZGl2PiIgKwogICAgICAgICAgICAgICAgICAgICI8L2xpPiIpOwogICAgICAgICAgICB2YXIgY2hvaWNlID0gZW5hYmxlQ2hvaWNlID8gZW5hYmxlZEl0ZW0gOiBkaXNhYmxlZEl0ZW0sCiAgICAgICAgICAgICAgICBpZCA9IHRoaXMuaWQoZGF0YSksCiAgICAgICAgICAgICAgICB2YWwgPSB0aGlzLmdldFZhbCgpLAogICAgICAgICAgICAgICAgZm9ybWF0dGVkLAogICAgICAgICAgICAgICAgY3NzQ2xhc3M7CgogICAgICAgICAgICBmb3JtYXR0ZWQ9dGhpcy5vcHRzLmZvcm1hdFNlbGVjdGlvbihkYXRhLCBjaG9pY2UuZmluZCgiZGl2IiksIHRoaXMub3B0cy5lc2NhcGVNYXJrdXApOwogICAgICAgICAgICBpZiAoZm9ybWF0dGVkICE9IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgY2hvaWNlLmZpbmQoImRpdiIpLnJlcGxhY2VXaXRoKCI8ZGl2PiIrZm9ybWF0dGVkKyI8L2Rpdj4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjc3NDbGFzcz10aGlzLm9wdHMuZm9ybWF0U2VsZWN0aW9uQ3NzQ2xhc3MoZGF0YSwgY2hvaWNlLmZpbmQoImRpdiIpKTsKICAgICAgICAgICAgaWYgKGNzc0NsYXNzICE9IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgY2hvaWNlLmFkZENsYXNzKGNzc0NsYXNzKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYoZW5hYmxlQ2hvaWNlKXsKICAgICAgICAgICAgICBjaG9pY2UuZmluZCgiLnNlbGVjdDItc2VhcmNoLWNob2ljZS1jbG9zZSIpCiAgICAgICAgICAgICAgICAgIC5vbigibW91c2Vkb3duIiwga2lsbEV2ZW50KQogICAgICAgICAgICAgICAgICAub24oImNsaWNrIGRibGNsaWNrIiwgdGhpcy5iaW5kKGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5pc0ludGVyZmFjZUVuYWJsZWQoKSkgcmV0dXJuOwoKICAgICAgICAgICAgICAgICAgdGhpcy51bnNlbGVjdCgkKGUudGFyZ2V0KSk7CiAgICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0aW9uLmZpbmQoIi5zZWxlY3QyLXNlYXJjaC1jaG9pY2UtZm9jdXMiKS5yZW1vdmVDbGFzcygic2VsZWN0Mi1zZWFyY2gtY2hvaWNlLWZvY3VzIik7CiAgICAgICAgICAgICAgICAgIGtpbGxFdmVudChlKTsKICAgICAgICAgICAgICAgICAgdGhpcy5jbG9zZSgpOwogICAgICAgICAgICAgICAgICB0aGlzLmZvY3VzU2VhcmNoKCk7CiAgICAgICAgICAgICAgfSkpLm9uKCJmb2N1cyIsIHRoaXMuYmluZChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5pc0ludGVyZmFjZUVuYWJsZWQoKSkgcmV0dXJuOwogICAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGRDbGFzcygic2VsZWN0Mi1jb250YWluZXItYWN0aXZlIik7CiAgICAgICAgICAgICAgICAgIHRoaXMuZHJvcGRvd24uYWRkQ2xhc3MoInNlbGVjdDItZHJvcC1hY3RpdmUiKTsKICAgICAgICAgICAgICB9KSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNob2ljZS5kYXRhKCJzZWxlY3QyLWRhdGEiLCBkYXRhKTsKICAgICAgICAgICAgY2hvaWNlLmluc2VydEJlZm9yZSh0aGlzLnNlYXJjaENvbnRhaW5lcik7CgogICAgICAgICAgICB2YWwucHVzaChpZCk7CiAgICAgICAgICAgIHRoaXMuc2V0VmFsKHZhbCk7CiAgICAgICAgfSwKCiAgICAgICAgLy8gbXVsdGkKICAgICAgICB1bnNlbGVjdDogZnVuY3Rpb24gKHNlbGVjdGVkKSB7CiAgICAgICAgICAgIHZhciB2YWwgPSB0aGlzLmdldFZhbCgpLAogICAgICAgICAgICAgICAgZGF0YSwKICAgICAgICAgICAgICAgIGluZGV4OwogICAgICAgICAgICBzZWxlY3RlZCA9IHNlbGVjdGVkLmNsb3Nlc3QoIi5zZWxlY3QyLXNlYXJjaC1jaG9pY2UiKTsKCiAgICAgICAgICAgIGlmIChzZWxlY3RlZC5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgIHRocm93ICJJbnZhbGlkIGFyZ3VtZW50OiAiICsgc2VsZWN0ZWQgKyAiLiBNdXN0IGJlIC5zZWxlY3QyLXNlYXJjaC1jaG9pY2UiOwogICAgICAgICAgICB9CgogICAgICAgICAgICBkYXRhID0gc2VsZWN0ZWQuZGF0YSgic2VsZWN0Mi1kYXRhIik7CgogICAgICAgICAgICBpZiAoIWRhdGEpIHsKICAgICAgICAgICAgICAgIC8vIHByZXZlbnQgYSByYWNlIGNvbmRpdGlvbiB3aGVuIHRoZSAneCcgaXMgY2xpY2tlZCByZWFsbHkgZmFzdCByZXBlYXRlZGx5IHRoZSBldmVudCBjYW4gYmUgcXVldWVkCiAgICAgICAgICAgICAgICAvLyBhbmQgaW52b2tlZCBvbiBhbiBlbGVtZW50IGFscmVhZHkgcmVtb3ZlZAogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgZXZ0ID0gJC5FdmVudCgic2VsZWN0Mi1yZW1vdmluZyIpOwogICAgICAgICAgICBldnQudmFsID0gdGhpcy5pZChkYXRhKTsKICAgICAgICAgICAgZXZ0LmNob2ljZSA9IGRhdGE7CiAgICAgICAgICAgIHRoaXMub3B0cy5lbGVtZW50LnRyaWdnZXIoZXZ0KTsKCiAgICAgICAgICAgIGlmIChldnQuaXNEZWZhdWx0UHJldmVudGVkKCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgd2hpbGUoKGluZGV4ID0gaW5kZXhPZih0aGlzLmlkKGRhdGEpLCB2YWwpKSA+PSAwKSB7CiAgICAgICAgICAgICAgICB2YWwuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICAgICAgICAgIHRoaXMuc2V0VmFsKHZhbCk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zZWxlY3QpIHRoaXMucG9zdHByb2Nlc3NSZXN1bHRzKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHNlbGVjdGVkLnJlbW92ZSgpOwoKICAgICAgICAgICAgdGhpcy5vcHRzLmVsZW1lbnQudHJpZ2dlcih7IHR5cGU6ICJzZWxlY3QyLXJlbW92ZWQiLCB2YWw6IHRoaXMuaWQoZGF0YSksIGNob2ljZTogZGF0YSB9KTsKICAgICAgICAgICAgdGhpcy50cmlnZ2VyQ2hhbmdlKHsgcmVtb3ZlZDogZGF0YSB9KTsKCiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0sCgogICAgICAgIC8vIG11bHRpCiAgICAgICAgcG9zdHByb2Nlc3NSZXN1bHRzOiBmdW5jdGlvbiAoZGF0YSwgaW5pdGlhbCwgbm9IaWdobGlnaHRVcGRhdGUpIHsKICAgICAgICAgICAgdmFyIHZhbCA9IHRoaXMuZ2V0VmFsKCksCiAgICAgICAgICAgICAgICBjaG9pY2VzID0gdGhpcy5yZXN1bHRzLmZpbmQoIi5zZWxlY3QyLXJlc3VsdCIpLAogICAgICAgICAgICAgICAgY29tcG91bmQgPSB0aGlzLnJlc3VsdHMuZmluZCgiLnNlbGVjdDItcmVzdWx0LXdpdGgtY2hpbGRyZW4iKSwKICAgICAgICAgICAgICAgIHNlbGYgPSB0aGlzOwoKICAgICAgICAgICAgY2hvaWNlcy5lYWNoMihmdW5jdGlvbiAoaSwgY2hvaWNlKSB7CiAgICAgICAgICAgICAgICB2YXIgaWQgPSBzZWxmLmlkKGNob2ljZS5kYXRhKCJzZWxlY3QyLWRhdGEiKSk7CiAgICAgICAgICAgICAgICBpZiAoaW5kZXhPZihpZCwgdmFsKSA+PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgY2hvaWNlLmFkZENsYXNzKCJzZWxlY3QyLXNlbGVjdGVkIik7CiAgICAgICAgICAgICAgICAgICAgLy8gbWFyayBhbGwgY2hpbGRyZW4gb2YgdGhlIHNlbGVjdGVkIHBhcmVudCBhcyBzZWxlY3RlZAogICAgICAgICAgICAgICAgICAgIGNob2ljZS5maW5kKCIuc2VsZWN0Mi1yZXN1bHQtc2VsZWN0YWJsZSIpLmFkZENsYXNzKCJzZWxlY3QyLXNlbGVjdGVkIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgY29tcG91bmQuZWFjaDIoZnVuY3Rpb24oaSwgY2hvaWNlKSB7CiAgICAgICAgICAgICAgICAvLyBoaWRlIGFuIG9wdGdyb3VwIGlmIGl0IGRvZXNuJ3QgaGF2ZSBhbnkgc2VsZWN0YWJsZSBjaGlsZHJlbgogICAgICAgICAgICAgICAgaWYgKCFjaG9pY2UuaXMoJy5zZWxlY3QyLXJlc3VsdC1zZWxlY3RhYmxlJykKICAgICAgICAgICAgICAgICAgICAmJiBjaG9pY2UuZmluZCgiLnNlbGVjdDItcmVzdWx0LXNlbGVjdGFibGU6bm90KC5zZWxlY3QyLXNlbGVjdGVkKSIpLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGNob2ljZS5hZGRDbGFzcygic2VsZWN0Mi1zZWxlY3RlZCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGlmICh0aGlzLmhpZ2hsaWdodCgpID09IC0xICYmIG5vSGlnaGxpZ2h0VXBkYXRlICE9PSBmYWxzZSl7CiAgICAgICAgICAgICAgICBzZWxmLmhpZ2hsaWdodCgwKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy9JZiBhbGwgcmVzdWx0cyBhcmUgY2hvc2VuIHJlbmRlciBmb3JtYXROb01hdGNoZXMKICAgICAgICAgICAgaWYoIXRoaXMub3B0cy5jcmVhdGVTZWFyY2hDaG9pY2UgJiYgIWNob2ljZXMuZmlsdGVyKCcuc2VsZWN0Mi1yZXN1bHQ6bm90KC5zZWxlY3QyLXNlbGVjdGVkKScpLmxlbmd0aCA+IDApewogICAgICAgICAgICAgICAgaWYoIWRhdGEgfHwgZGF0YSAmJiAhZGF0YS5tb3JlICYmIHRoaXMucmVzdWx0cy5maW5kKCIuc2VsZWN0Mi1uby1yZXN1bHRzIikubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNoZWNrRm9ybWF0dGVyKHNlbGYub3B0cy5mb3JtYXROb01hdGNoZXMsICJmb3JtYXROb01hdGNoZXMiKSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlc3VsdHMuYXBwZW5kKCI8bGkgY2xhc3M9J3NlbGVjdDItbm8tcmVzdWx0cyc+IiArIGV2YWx1YXRlKHNlbGYub3B0cy5mb3JtYXROb01hdGNoZXMsIHNlbGYub3B0cy5lbGVtZW50LCBzZWxmLnNlYXJjaC52YWwoKSkgKyAiPC9saT4iKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgfSwKCiAgICAgICAgLy8gbXVsdGkKICAgICAgICBnZXRNYXhTZWFyY2hXaWR0aDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnNlbGVjdGlvbi53aWR0aCgpIC0gZ2V0U2lkZUJvcmRlclBhZGRpbmcodGhpcy5zZWFyY2gpOwogICAgICAgIH0sCgogICAgICAgIC8vIG11bHRpCiAgICAgICAgcmVzaXplU2VhcmNoOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBtaW5pbXVtV2lkdGgsIGxlZnQsIG1heFdpZHRoLCBjb250YWluZXJMZWZ0LCBzZWFyY2hXaWR0aCwKICAgICAgICAgICAgICAgIHNpZGVCb3JkZXJQYWRkaW5nID0gZ2V0U2lkZUJvcmRlclBhZGRpbmcodGhpcy5zZWFyY2gpOwoKICAgICAgICAgICAgbWluaW11bVdpZHRoID0gbWVhc3VyZVRleHRXaWR0aCh0aGlzLnNlYXJjaCkgKyAxMDsKCiAgICAgICAgICAgIGxlZnQgPSB0aGlzLnNlYXJjaC5vZmZzZXQoKS5sZWZ0OwoKICAgICAgICAgICAgbWF4V2lkdGggPSB0aGlzLnNlbGVjdGlvbi53aWR0aCgpOwogICAgICAgICAgICBjb250YWluZXJMZWZ0ID0gdGhpcy5zZWxlY3Rpb24ub2Zmc2V0KCkubGVmdDsKCiAgICAgICAgICAgIHNlYXJjaFdpZHRoID0gbWF4V2lkdGggLSAobGVmdCAtIGNvbnRhaW5lckxlZnQpIC0gc2lkZUJvcmRlclBhZGRpbmc7CgogICAgICAgICAgICBpZiAoc2VhcmNoV2lkdGggPCBtaW5pbXVtV2lkdGgpIHsKICAgICAgICAgICAgICAgIHNlYXJjaFdpZHRoID0gbWF4V2lkdGggLSBzaWRlQm9yZGVyUGFkZGluZzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHNlYXJjaFdpZHRoIDwgNDApIHsKICAgICAgICAgICAgICAgIHNlYXJjaFdpZHRoID0gbWF4V2lkdGggLSBzaWRlQm9yZGVyUGFkZGluZzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHNlYXJjaFdpZHRoIDw9IDApIHsKICAgICAgICAgICAgICBzZWFyY2hXaWR0aCA9IG1pbmltdW1XaWR0aDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5zZWFyY2gud2lkdGgoTWF0aC5mbG9vcihzZWFyY2hXaWR0aCkpOwogICAgICAgIH0sCgogICAgICAgIC8vIG11bHRpCiAgICAgICAgZ2V0VmFsOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciB2YWw7CiAgICAgICAgICAgIGlmICh0aGlzLnNlbGVjdCkgewogICAgICAgICAgICAgICAgdmFsID0gdGhpcy5zZWxlY3QudmFsKCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsID09PSBudWxsID8gW10gOiB2YWw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YWwgPSB0aGlzLm9wdHMuZWxlbWVudC52YWwoKTsKICAgICAgICAgICAgICAgIHJldHVybiBzcGxpdFZhbCh2YWwsIHRoaXMub3B0cy5zZXBhcmF0b3IpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLy8gbXVsdGkKICAgICAgICBzZXRWYWw6IGZ1bmN0aW9uICh2YWwpIHsKICAgICAgICAgICAgdmFyIHVuaXF1ZTsKICAgICAgICAgICAgaWYgKHRoaXMuc2VsZWN0KSB7CiAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdC52YWwodmFsKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHVuaXF1ZSA9IFtdOwogICAgICAgICAgICAgICAgLy8gZmlsdGVyIG91dCBkdXBsaWNhdGVzCiAgICAgICAgICAgICAgICAkKHZhbCkuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGluZGV4T2YodGhpcywgdW5pcXVlKSA8IDApIHVuaXF1ZS5wdXNoKHRoaXMpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB0aGlzLm9wdHMuZWxlbWVudC52YWwodW5pcXVlLmxlbmd0aCA9PT0gMCA/ICIiIDogdW5pcXVlLmpvaW4odGhpcy5vcHRzLnNlcGFyYXRvcikpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLy8gbXVsdGkKICAgICAgICBidWlsZENoYW5nZURldGFpbHM6IGZ1bmN0aW9uIChvbGQsIGN1cnJlbnQpIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnQgPSBjdXJyZW50LnNsaWNlKDApLAogICAgICAgICAgICAgICAgb2xkID0gb2xkLnNsaWNlKDApOwoKICAgICAgICAgICAgLy8gcmVtb3ZlIGludGVyc2VjdGlvbiBmcm9tIGVhY2ggYXJyYXkKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjdXJyZW50Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IG9sZC5sZW5ndGg7IGorKykgewogICAgICAgICAgICAgICAgICAgIGlmIChlcXVhbCh0aGlzLm9wdHMuaWQoY3VycmVudFtpXSksIHRoaXMub3B0cy5pZChvbGRbal0pKSkgewogICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50LnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYoaT4wKXsKICAgICAgICAgICAgICAgICAgICAgICAgCWktLTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBvbGQuc3BsaWNlKGosIDEpOwogICAgICAgICAgICAgICAgICAgICAgICBqLS07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4ge2FkZGVkOiBjdXJyZW50LCByZW1vdmVkOiBvbGR9OwogICAgICAgIH0sCgoKICAgICAgICAvLyBtdWx0aQogICAgICAgIHZhbDogZnVuY3Rpb24gKHZhbCwgdHJpZ2dlckNoYW5nZSkgewogICAgICAgICAgICB2YXIgb2xkRGF0YSwgc2VsZj10aGlzOwoKICAgICAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldFZhbCgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBvbGREYXRhPXRoaXMuZGF0YSgpOwogICAgICAgICAgICBpZiAoIW9sZERhdGEubGVuZ3RoKSBvbGREYXRhPVtdOwoKICAgICAgICAgICAgLy8gdmFsIGlzIGFuIGlkLiAhdmFsIGlzIHRydWUgZm9yIFt1bmRlZmluZWQsbnVsbCwnJywwXSAtIDAgaXMgbGVnYWwKICAgICAgICAgICAgaWYgKCF2YWwgJiYgdmFsICE9PSAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLm9wdHMuZWxlbWVudC52YWwoIiIpOwogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVTZWxlY3Rpb24oW10pOwogICAgICAgICAgICAgICAgdGhpcy5jbGVhclNlYXJjaCgpOwogICAgICAgICAgICAgICAgaWYgKHRyaWdnZXJDaGFuZ2UpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXJDaGFuZ2Uoe2FkZGVkOiB0aGlzLmRhdGEoKSwgcmVtb3ZlZDogb2xkRGF0YX0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyB2YWwgaXMgYSBsaXN0IG9mIGlkcwogICAgICAgICAgICB0aGlzLnNldFZhbCh2YWwpOwoKICAgICAgICAgICAgaWYgKHRoaXMuc2VsZWN0KSB7CiAgICAgICAgICAgICAgICB0aGlzLm9wdHMuaW5pdFNlbGVjdGlvbih0aGlzLnNlbGVjdCwgdGhpcy5iaW5kKHRoaXMudXBkYXRlU2VsZWN0aW9uKSk7CiAgICAgICAgICAgICAgICBpZiAodHJpZ2dlckNoYW5nZSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlckNoYW5nZSh0aGlzLmJ1aWxkQ2hhbmdlRGV0YWlscyhvbGREYXRhLCB0aGlzLmRhdGEoKSkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKHRoaXMub3B0cy5pbml0U2VsZWN0aW9uID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInZhbCgpIGNhbm5vdCBiZSBjYWxsZWQgaWYgaW5pdFNlbGVjdGlvbigpIGlzIG5vdCBkZWZpbmVkIik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5vcHRzLmluaXRTZWxlY3Rpb24odGhpcy5vcHRzLmVsZW1lbnQsIGZ1bmN0aW9uKGRhdGEpewogICAgICAgICAgICAgICAgICAgIHZhciBpZHM9JC5tYXAoZGF0YSwgc2VsZi5pZCk7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5zZXRWYWwoaWRzKTsKICAgICAgICAgICAgICAgICAgICBzZWxmLnVwZGF0ZVNlbGVjdGlvbihkYXRhKTsKICAgICAgICAgICAgICAgICAgICBzZWxmLmNsZWFyU2VhcmNoKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRyaWdnZXJDaGFuZ2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi50cmlnZ2VyQ2hhbmdlKHNlbGYuYnVpbGRDaGFuZ2VEZXRhaWxzKG9sZERhdGEsIHNlbGYuZGF0YSgpKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5jbGVhclNlYXJjaCgpOwogICAgICAgIH0sCgogICAgICAgIC8vIG11bHRpCiAgICAgICAgb25Tb3J0U3RhcnQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAodGhpcy5zZWxlY3QpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiU29ydGluZyBvZiBlbGVtZW50cyBpcyBub3Qgc3VwcG9ydGVkIHdoZW4gYXR0YWNoZWQgdG8gPHNlbGVjdD4uIEF0dGFjaCB0byA8aW5wdXQgdHlwZT0naGlkZGVuJy8+IGluc3RlYWQuIik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGNvbGxhcHNlIHNlYXJjaCBmaWVsZCBpbnRvIDAgd2lkdGggc28gaXRzIGNvbnRhaW5lciBjYW4gYmUgY29sbGFwc2VkIGFzIHdlbGwKICAgICAgICAgICAgdGhpcy5zZWFyY2gud2lkdGgoMCk7CiAgICAgICAgICAgIC8vIGhpZGUgdGhlIGNvbnRhaW5lcgogICAgICAgICAgICB0aGlzLnNlYXJjaENvbnRhaW5lci5oaWRlKCk7CiAgICAgICAgfSwKCiAgICAgICAgLy8gbXVsdGkKICAgICAgICBvblNvcnRFbmQ6ZnVuY3Rpb24oKSB7CgogICAgICAgICAgICB2YXIgdmFsPVtdLCBzZWxmPXRoaXM7CgogICAgICAgICAgICAvLyBzaG93IHNlYXJjaCBhbmQgbW92ZSBpdCB0byB0aGUgZW5kIG9mIHRoZSBsaXN0CiAgICAgICAgICAgIHRoaXMuc2VhcmNoQ29udGFpbmVyLnNob3coKTsKICAgICAgICAgICAgLy8gbWFrZSBzdXJlIHRoZSBzZWFyY2ggY29udGFpbmVyIGlzIHRoZSBsYXN0IGl0ZW0gaW4gdGhlIGxpc3QKICAgICAgICAgICAgdGhpcy5zZWFyY2hDb250YWluZXIuYXBwZW5kVG8odGhpcy5zZWFyY2hDb250YWluZXIucGFyZW50KCkpOwogICAgICAgICAgICAvLyBzaW5jZSB3ZSBjb2xsYXBzZWQgdGhlIHdpZHRoIGluIGRyYWdTdGFydGVkLCB3ZSByZXNpemUgaXQgaGVyZQogICAgICAgICAgICB0aGlzLnJlc2l6ZVNlYXJjaCgpOwoKICAgICAgICAgICAgLy8gdXBkYXRlIHNlbGVjdGlvbgogICAgICAgICAgICB0aGlzLnNlbGVjdGlvbi5maW5kKCIuc2VsZWN0Mi1zZWFyY2gtY2hvaWNlIikuZWFjaChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhbC5wdXNoKHNlbGYub3B0cy5pZCgkKHRoaXMpLmRhdGEoInNlbGVjdDItZGF0YSIpKSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLnNldFZhbCh2YWwpOwogICAgICAgICAgICB0aGlzLnRyaWdnZXJDaGFuZ2UoKTsKICAgICAgICB9LAoKICAgICAgICAvLyBtdWx0aQogICAgICAgIGRhdGE6IGZ1bmN0aW9uKHZhbHVlcywgdHJpZ2dlckNoYW5nZSkgewogICAgICAgICAgICB2YXIgc2VsZj10aGlzLCBpZHMsIG9sZDsKICAgICAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zZWxlY3Rpb24KICAgICAgICAgICAgICAgICAgICAgLmNoaWxkcmVuKCIuc2VsZWN0Mi1zZWFyY2gtY2hvaWNlIikKICAgICAgICAgICAgICAgICAgICAgLm1hcChmdW5jdGlvbigpIHsgcmV0dXJuICQodGhpcykuZGF0YSgic2VsZWN0Mi1kYXRhIik7IH0pCiAgICAgICAgICAgICAgICAgICAgIC5nZXQoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG9sZCA9IHRoaXMuZGF0YSgpOwogICAgICAgICAgICAgICAgaWYgKCF2YWx1ZXMpIHsgdmFsdWVzID0gW107IH0KICAgICAgICAgICAgICAgIGlkcyA9ICQubWFwKHZhbHVlcywgZnVuY3Rpb24oZSkgeyByZXR1cm4gc2VsZi5vcHRzLmlkKGUpOyB9KTsKICAgICAgICAgICAgICAgIHRoaXMuc2V0VmFsKGlkcyk7CiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVNlbGVjdGlvbih2YWx1ZXMpOwogICAgICAgICAgICAgICAgdGhpcy5jbGVhclNlYXJjaCgpOwogICAgICAgICAgICAgICAgaWYgKHRyaWdnZXJDaGFuZ2UpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXJDaGFuZ2UodGhpcy5idWlsZENoYW5nZURldGFpbHMob2xkLCB0aGlzLmRhdGEoKSkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSk7CgogICAgJC5mbi5zZWxlY3QyID0gZnVuY3Rpb24gKCkgewoKICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMCksCiAgICAgICAgICAgIG9wdHMsCiAgICAgICAgICAgIHNlbGVjdDIsCiAgICAgICAgICAgIG1ldGhvZCwgdmFsdWUsIG11bHRpcGxlLAogICAgICAgICAgICBhbGxvd2VkTWV0aG9kcyA9IFsidmFsIiwgImRlc3Ryb3kiLCAib3BlbmVkIiwgIm9wZW4iLCAiY2xvc2UiLCAiZm9jdXMiLCAiaXNGb2N1c2VkIiwgImNvbnRhaW5lciIsICJkcm9wZG93biIsICJvblNvcnRTdGFydCIsICJvblNvcnRFbmQiLCAiZW5hYmxlIiwgImRpc2FibGUiLCAicmVhZG9ubHkiLCAicG9zaXRpb25Ecm9wZG93biIsICJkYXRhIiwgInNlYXJjaCJdLAogICAgICAgICAgICB2YWx1ZU1ldGhvZHMgPSBbIm9wZW5lZCIsICJpc0ZvY3VzZWQiLCAiY29udGFpbmVyIiwgImRyb3Bkb3duIl0sCiAgICAgICAgICAgIHByb3BlcnR5TWV0aG9kcyA9IFsidmFsIiwgImRhdGEiXSwKICAgICAgICAgICAgbWV0aG9kc01hcCA9IHsgc2VhcmNoOiAiZXh0ZXJuYWxTZWFyY2giIH07CgogICAgICAgIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGlmIChhcmdzLmxlbmd0aCA9PT0gMCB8fCB0eXBlb2YoYXJnc1swXSkgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgICBvcHRzID0gYXJncy5sZW5ndGggPT09IDAgPyB7fSA6ICQuZXh0ZW5kKHt9LCBhcmdzWzBdKTsKICAgICAgICAgICAgICAgIG9wdHMuZWxlbWVudCA9ICQodGhpcyk7CgogICAgICAgICAgICAgICAgaWYgKG9wdHMuZWxlbWVudC5nZXQoMCkudGFnTmFtZS50b0xvd2VyQ2FzZSgpID09PSAic2VsZWN0IikgewogICAgICAgICAgICAgICAgICAgIG11bHRpcGxlID0gb3B0cy5lbGVtZW50LnByb3AoIm11bHRpcGxlIik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIG11bHRpcGxlID0gb3B0cy5tdWx0aXBsZSB8fCBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBpZiAoInRhZ3MiIGluIG9wdHMpIHtvcHRzLm11bHRpcGxlID0gbXVsdGlwbGUgPSB0cnVlO30KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBzZWxlY3QyID0gbXVsdGlwbGUgPyBuZXcgd2luZG93LlNlbGVjdDJbImNsYXNzIl0ubXVsdGkoKSA6IG5ldyB3aW5kb3cuU2VsZWN0MlsiY2xhc3MiXS5zaW5nbGUoKTsKICAgICAgICAgICAgICAgIHNlbGVjdDIuaW5pdChvcHRzKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YoYXJnc1swXSkgPT09ICJzdHJpbmciKSB7CgogICAgICAgICAgICAgICAgaWYgKGluZGV4T2YoYXJnc1swXSwgYWxsb3dlZE1ldGhvZHMpIDwgMCkgewogICAgICAgICAgICAgICAgICAgIHRocm93ICJVbmtub3duIG1ldGhvZDogIiArIGFyZ3NbMF07CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdmFsdWUgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICBzZWxlY3QyID0gJCh0aGlzKS5kYXRhKCJzZWxlY3QyIik7CiAgICAgICAgICAgICAgICBpZiAoc2VsZWN0MiA9PT0gdW5kZWZpbmVkKSByZXR1cm47CgogICAgICAgICAgICAgICAgbWV0aG9kPWFyZ3NbMF07CgogICAgICAgICAgICAgICAgaWYgKG1ldGhvZCA9PT0gImNvbnRhaW5lciIpIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHNlbGVjdDIuY29udGFpbmVyOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChtZXRob2QgPT09ICJkcm9wZG93biIpIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHNlbGVjdDIuZHJvcGRvd247CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmIChtZXRob2RzTWFwW21ldGhvZF0pIG1ldGhvZCA9IG1ldGhvZHNNYXBbbWV0aG9kXTsKCiAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBzZWxlY3QyW21ldGhvZF0uYXBwbHkoc2VsZWN0MiwgYXJncy5zbGljZSgxKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoaW5kZXhPZihhcmdzWzBdLCB2YWx1ZU1ldGhvZHMpID49IDAKICAgICAgICAgICAgICAgICAgICB8fCAoaW5kZXhPZihhcmdzWzBdLCBwcm9wZXJ0eU1ldGhvZHMpID49IDAgJiYgYXJncy5sZW5ndGggPT0gMSkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7IC8vIGFib3J0IHRoZSBpdGVyYXRpb24sIHJlYWR5IHRvIHJldHVybiBmaXJzdCBtYXRjaGVkIHZhbHVlCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aHJvdyAiSW52YWxpZCBhcmd1bWVudHMgdG8gc2VsZWN0MiBwbHVnaW46ICIgKyBhcmdzOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSA/IHRoaXMgOiB2YWx1ZTsKICAgIH07CgogICAgLy8gcGx1Z2luIGRlZmF1bHRzLCBhY2Nlc3NpYmxlIHRvIHVzZXJzCiAgICAkLmZuLnNlbGVjdDIuZGVmYXVsdHMgPSB7CiAgICAgICAgd2lkdGg6ICJjb3B5IiwKICAgICAgICBsb2FkTW9yZVBhZGRpbmc6IDAsCiAgICAgICAgY2xvc2VPblNlbGVjdDogdHJ1ZSwKICAgICAgICBvcGVuT25FbnRlcjogdHJ1ZSwKICAgICAgICBjb250YWluZXJDc3M6IHt9LAogICAgICAgIGRyb3Bkb3duQ3NzOiB7fSwKICAgICAgICBjb250YWluZXJDc3NDbGFzczogIiIsCiAgICAgICAgZHJvcGRvd25Dc3NDbGFzczogIiIsCiAgICAgICAgZm9ybWF0UmVzdWx0OiBmdW5jdGlvbihyZXN1bHQsIGNvbnRhaW5lciwgcXVlcnksIGVzY2FwZU1hcmt1cCkgewogICAgICAgICAgICB2YXIgbWFya3VwPVtdOwogICAgICAgICAgICBtYXJrTWF0Y2gocmVzdWx0LnRleHQsIHF1ZXJ5LnRlcm0sIG1hcmt1cCwgZXNjYXBlTWFya3VwKTsKICAgICAgICAgICAgcmV0dXJuIG1hcmt1cC5qb2luKCIiKTsKICAgICAgICB9LAogICAgICAgIGZvcm1hdFNlbGVjdGlvbjogZnVuY3Rpb24gKGRhdGEsIGNvbnRhaW5lciwgZXNjYXBlTWFya3VwKSB7CiAgICAgICAgICAgIHJldHVybiBkYXRhID8gZXNjYXBlTWFya3VwKGRhdGEudGV4dCkgOiB1bmRlZmluZWQ7CiAgICAgICAgfSwKICAgICAgICBzb3J0UmVzdWx0czogZnVuY3Rpb24gKHJlc3VsdHMsIGNvbnRhaW5lciwgcXVlcnkpIHsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdHM7CiAgICAgICAgfSwKICAgICAgICBmb3JtYXRSZXN1bHRDc3NDbGFzczogZnVuY3Rpb24oZGF0YSkge3JldHVybiBkYXRhLmNzczt9LAogICAgICAgIGZvcm1hdFNlbGVjdGlvbkNzc0NsYXNzOiBmdW5jdGlvbihkYXRhLCBjb250YWluZXIpIHtyZXR1cm4gdW5kZWZpbmVkO30sCiAgICAgICAgZm9ybWF0TWF0Y2hlczogZnVuY3Rpb24gKG1hdGNoZXMpIHsgaWYgKG1hdGNoZXMgPT09IDEpIHsgcmV0dXJuICJPbmUgcmVzdWx0IGlzIGF2YWlsYWJsZSwgcHJlc3MgZW50ZXIgdG8gc2VsZWN0IGl0LiI7IH0gcmV0dXJuIG1hdGNoZXMgKyAiIHJlc3VsdHMgYXJlIGF2YWlsYWJsZSwgdXNlIHVwIGFuZCBkb3duIGFycm93IGtleXMgdG8gbmF2aWdhdGUuIjsgfSwKICAgICAgICBmb3JtYXROb01hdGNoZXM6IGZ1bmN0aW9uICgpIHsgcmV0dXJuICJObyBtYXRjaGVzIGZvdW5kIjsgfSwKICAgICAgICBmb3JtYXRJbnB1dFRvb1Nob3J0OiBmdW5jdGlvbiAoaW5wdXQsIG1pbikgeyB2YXIgbiA9IG1pbiAtIGlucHV0Lmxlbmd0aDsgcmV0dXJuICJQbGVhc2UgZW50ZXIgIiArIG4gKyAiIG9yIG1vcmUgY2hhcmFjdGVyIiArIChuID09IDE/ICIiIDogInMiKTsgfSwKICAgICAgICBmb3JtYXRJbnB1dFRvb0xvbmc6IGZ1bmN0aW9uIChpbnB1dCwgbWF4KSB7IHZhciBuID0gaW5wdXQubGVuZ3RoIC0gbWF4OyByZXR1cm4gIlBsZWFzZSBkZWxldGUgIiArIG4gKyAiIGNoYXJhY3RlciIgKyAobiA9PSAxPyAiIiA6ICJzIik7IH0sCiAgICAgICAgZm9ybWF0U2VsZWN0aW9uVG9vQmlnOiBmdW5jdGlvbiAobGltaXQpIHsgcmV0dXJuICJZb3UgY2FuIG9ubHkgc2VsZWN0ICIgKyBsaW1pdCArICIgaXRlbSIgKyAobGltaXQgPT0gMSA/ICIiIDogInMiKTsgfSwKICAgICAgICBmb3JtYXRMb2FkTW9yZTogZnVuY3Rpb24gKHBhZ2VOdW1iZXIpIHsgcmV0dXJuICJMb2FkaW5nIG1vcmUgcmVzdWx0c+KApiI7IH0sCiAgICAgICAgZm9ybWF0U2VhcmNoaW5nOiBmdW5jdGlvbiAoKSB7IHJldHVybiAiU2VhcmNoaW5n4oCmIjsgfSwKICAgICAgICBtaW5pbXVtUmVzdWx0c0ZvclNlYXJjaDogMCwKICAgICAgICBtaW5pbXVtSW5wdXRMZW5ndGg6IDAsCiAgICAgICAgbWF4aW11bUlucHV0TGVuZ3RoOiBudWxsLAogICAgICAgIG1heGltdW1TZWxlY3Rpb25TaXplOiAwLAogICAgICAgIGlkOiBmdW5jdGlvbiAoZSkgeyByZXR1cm4gZSA9PSB1bmRlZmluZWQgPyBudWxsIDogZS5pZDsgfSwKICAgICAgICBtYXRjaGVyOiBmdW5jdGlvbih0ZXJtLCB0ZXh0KSB7CiAgICAgICAgICAgIHJldHVybiBzdHJpcERpYWNyaXRpY3MoJycrdGV4dCkudG9VcHBlckNhc2UoKS5pbmRleE9mKHN0cmlwRGlhY3JpdGljcygnJyt0ZXJtKS50b1VwcGVyQ2FzZSgpKSA+PSAwOwogICAgICAgIH0sCiAgICAgICAgc2VwYXJhdG9yOiAiLCIsCiAgICAgICAgdG9rZW5TZXBhcmF0b3JzOiBbXSwKICAgICAgICB0b2tlbml6ZXI6IGRlZmF1bHRUb2tlbml6ZXIsCiAgICAgICAgZXNjYXBlTWFya3VwOiBkZWZhdWx0RXNjYXBlTWFya3VwLAogICAgICAgIGJsdXJPbkNoYW5nZTogZmFsc2UsCiAgICAgICAgc2VsZWN0T25CbHVyOiBmYWxzZSwKICAgICAgICBhZGFwdENvbnRhaW5lckNzc0NsYXNzOiBmdW5jdGlvbihjKSB7IHJldHVybiBjOyB9LAogICAgICAgIGFkYXB0RHJvcGRvd25Dc3NDbGFzczogZnVuY3Rpb24oYykgeyByZXR1cm4gbnVsbDsgfSwKICAgICAgICBuZXh0U2VhcmNoVGVybTogZnVuY3Rpb24oc2VsZWN0ZWRPYmplY3QsIGN1cnJlbnRTZWFyY2hUZXJtKSB7IHJldHVybiB1bmRlZmluZWQ7IH0sCiAgICAgICAgc2VhcmNoSW5wdXRQbGFjZWhvbGRlcjogJycsCiAgICAgICAgY3JlYXRlU2VhcmNoQ2hvaWNlUG9zaXRpb246ICd0b3AnLAogICAgICAgIHNob3VsZEZvY3VzSW5wdXQ6IGZ1bmN0aW9uIChpbnN0YW5jZSkgewogICAgICAgICAgICAvLyBBdHRlbXB0IHRvIGRldGVjdCB0b3VjaCBkZXZpY2VzCiAgICAgICAgICAgIHZhciBzdXBwb3J0c1RvdWNoRXZlbnRzID0gKCgnb250b3VjaHN0YXJ0JyBpbiB3aW5kb3cpIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChuYXZpZ2F0b3IubXNNYXhUb3VjaFBvaW50cyA+IDApKTsKCiAgICAgICAgICAgIC8vIE9ubHkgZGV2aWNlcyB3aGljaCBzdXBwb3J0IHRvdWNoIGV2ZW50cyBzaG91bGQgYmUgc3BlY2lhbCBjYXNlZAogICAgICAgICAgICBpZiAoIXN1cHBvcnRzVG91Y2hFdmVudHMpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBOZXZlciBmb2N1cyB0aGUgaW5wdXQgaWYgc2VhcmNoIGlzIGRpc2FibGVkCiAgICAgICAgICAgIGlmIChpbnN0YW5jZS5vcHRzLm1pbmltdW1SZXN1bHRzRm9yU2VhcmNoIDwgMCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICB9OwoKICAgICQuZm4uc2VsZWN0Mi5hamF4RGVmYXVsdHMgPSB7CiAgICAgICAgdHJhbnNwb3J0OiAkLmFqYXgsCiAgICAgICAgcGFyYW1zOiB7CiAgICAgICAgICAgIHR5cGU6ICJHRVQiLAogICAgICAgICAgICBjYWNoZTogZmFsc2UsCiAgICAgICAgICAgIGRhdGFUeXBlOiAianNvbiIKICAgICAgICB9CiAgICB9OwoKICAgIC8vIGV4cG9ydHMKICAgIHdpbmRvdy5TZWxlY3QyID0gewogICAgICAgIHF1ZXJ5OiB7CiAgICAgICAgICAgIGFqYXg6IGFqYXgsCiAgICAgICAgICAgIGxvY2FsOiBsb2NhbCwKICAgICAgICAgICAgdGFnczogdGFncwogICAgICAgIH0sIHV0aWw6IHsKICAgICAgICAgICAgZGVib3VuY2U6IGRlYm91bmNlLAogICAgICAgICAgICBtYXJrTWF0Y2g6IG1hcmtNYXRjaCwKICAgICAgICAgICAgZXNjYXBlTWFya3VwOiBkZWZhdWx0RXNjYXBlTWFya3VwLAogICAgICAgICAgICBzdHJpcERpYWNyaXRpY3M6IHN0cmlwRGlhY3JpdGljcwogICAgICAgIH0sICJjbGFzcyI6IHsKICAgICAgICAgICAgImFic3RyYWN0IjogQWJzdHJhY3RTZWxlY3QyLAogICAgICAgICAgICAic2luZ2xlIjogU2luZ2xlU2VsZWN0MiwKICAgICAgICAgICAgIm11bHRpIjogTXVsdGlTZWxlY3QyCiAgICAgICAgfQogICAgfTsKCn0oalF1ZXJ5KSk7Cg=="></script> -->
<link href="../js/select2/select2.css" rel="stylesheet"/>
<link rel="stylesheet" href="../js/ea/themes/bootstrap/easyui.css">
<style>
    .combo{ 
        width: 545px !important; 
        height: 35px !important;
        border-radius: 5px !important;
    }
    .searchbox{ 
        width: 600px !important; 
        height: 35px !important;
        border-radius: 5px !important;
    }
    .searchbox-text{
        height: 20px !important;
        padding: 0px !important;
        padding-top: 4px !important;
        padding-left: 10px !important;
    }
    .combo-text{
        height: 20px !important;
        padding: 0px !important;
        padding-top: 4px !important;
        padding-left: 4px !important;
    }
    .combo-arrow{
        margin-top: -20px;
    }
</style>
<script>
// $(document).on("ready xcrudafterrequest",function(){
//     $("select").select2();
// })
$(document).ready(function(){
	$('#precio_pb, #cantidad_pb').keyup(function() {
		subtotal_pb();
	});
	function subtotal_pb(){
	$('#subtotal_pb').val(($('#precio_pb').val()*$('#cantidad_pb').val()).toFixed(2));
	}
	$('#depto, #fecha, #total').mousedown(function(){ return false; }).keydown(function(event){ return false; });
	$('#depto, #fecha, #total').css({ 'cursor':'not-allowed' });
	jQuery('#name,#rif,#rnc_code,#status,#address,#tlf,#email,#create_date,#due_date').mousedown(function(){ return false; }).keydown(function(event){ return false; });
	jQuery('#name,#rif,#rnc_code,#status,#address,#tlf,#email,#create_date,#due_date').css({ 'cursor':'not-allowed' });
 jQuery('#id_pb').combogrid({
    panelWidth:545,
    idField:'id_req_detail',
    textField:'name_product',
	url: '../procesos/traeprueba',
 	mode:'remote',
    columns:[[
 {field:'id_requisition',title:'N°req',width:45},
{field:'name_unit',title:'Unidad',width:160},
{field:'name_product',title:'Detalle',width:160},
{field:'quantity',title:'Cantidad',width:160}
    ]],
  onSelect:function(){
		 var g = jQuery('#id_pb').combogrid('grid');	// get datagrid object
		 var r = g.datagrid('getSelected');	// get the selected row
		$('#id_pb').val(r.id_req_detail);
		$('#cantidad_pb').val(r.quantity);
		subtotal_pb();
	}
    });
 // if(jQuery('#rif')){
 // 	//alert('hola');
 // 	var ap='<table class="table table-striped"><tbody><tr><td style="width: 26% !important;"class="details-label">INTRODUZCA RIF</td><td><input type="text" class="xcrud-input form-control" data-type="text" id="searchRif"></td></tr></tbody></table>';
 // 	jQuery('.xcrud-view').append(ap);
 // 	jQuery('#name,#rif,#rnc_code,#status,#address,#tlf,#email,#create_date,#due_date').mousedown(function(){ return false; }).keydown(function(event){ return false; });
	// jQuery('#name,#rif,#rnc_code,#status,#address,#tlf,#email,#create_date,#due_date').css({ 'cursor':'not-allowed' });

 // }
jQuery('#rif').searchbox({
searcher:function(value){
				if(value==0){
					alert("Debe introducir primero un RIF");
				}else{
						//jQuery(':input').val('');
						var rif =value.toUpperCase();
						rif = rif.replace(/^\s+/,'').replace(/\s+$/,'');
						//alert(rif);
					    jQuery.ajax({url:'../usuarios/sncVerificar',type:'POST',data:{ id: value },success:function(respuesta){
                            var pos=respuesta.indexOf('}');
                            respuesta=respuesta.substr(0,pos+1);
                            var res = jQuery.parseJSON(respuesta);
                            if(res.existe=='S'){
                            	var pos=res.estadoEmpre.indexOf('NO REGISTRADA');
                            	var pos2=res.estadoEmpre.indexOf('SUSPENDIDA');
                            	if(pos!=-1){
                            		alert(res.estadoEmpre);
                            	}
                            	else if(pos2!=-1){
                            		alert(res.estadoEmpre);
                            	}
                            	else{

                            	jQuery('#name').val(res.nomfis);
                            	jQuery('#rif').val(res.rif);
                            	$('#rif').val(res.rif);
                            	jQuery('#rnc_code').val(res.rnc);
                            	jQuery('#status').val(res.estadoEmpre);
                            	jQuery('#address').val(res.direc1);
                            	jQuery('#tlf').val(res.telefono);
                            	jQuery('#email').val(res.email);
                            	jQuery('#create_date').val(res.creacionrnc.toLocaleString());
                            	jQuery('#due_date').val(res.vencernc.toLocaleString());
                            	}
                            }
                            else{
                            	alert('Empresa No Registrada');
                            }
                         }});

				}
},
});
 jQuery('#id_cuenta').combogrid({
    panelWidth:700,
    idField:'id_account',
    textField:'code_account',
	url: '../procesos/account_fund',
 	mode:'remote',
    columns:[[
 {field:'code_account',title:'N° Cuenta',width:100},
{field:'name_account',title:'Nombre de Cuenta',width:300},
{field:'id_fund',title:'Fondo',width:160},
{field:'name_dept',title:'Unidad Ejecutora',width:160}
    ]],
onSelect:function(){
		 var g = jQuery('#id_cuenta').combogrid('grid');	// get datagrid object
		 var r = g.datagrid('getSelected');	// get the selected row
		$('#id_cuenta').val(r.id_account);
	}
    });
});
</script>
<?php echo $this->render_table_name($mode); ?>
<div class="xcrud-top-actions btn-group">
    <?php echo $this->render_button('save_new','save','create','btn btn-primary','','create,edit') ?>
    <?php echo $this->render_button('save_edit','save','edit','btn btn-default','','create,edit') ?>
    <?php echo $this->render_button('save_return','save','list','btn btn-success','','create,edit') ?>
    <?php echo $this->render_button('return','list','','btn btn-warning') ?>
</div>
<div id="respuesta">
</div>
<div class="xcrud-view">
<?php echo $this->render_fields_list($mode); ?>
</div>
<div class="xcrud-nav">
    <?php echo $this->render_benchmark(); ?>
</div>
